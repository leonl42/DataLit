[CLS]
RP\rightarrow RP
\{RP,QP_{i}\}\rightarrow QP_{i}
QP_{i}\nrightarrow QP_{j}\ (i\neq j)
RP
QP_{i}
[CLS]
i
[CLS]
\mathbf{x}\in\mathbb{R}^{C\times H\times W}
H\times W
C
\mathbf{x}
\{\mathbf{x}^{(i)}\in\mathbb{R}^{CP^{2}}\}_{i=1}^{N}
P\times P
D
\mathbf{z}^{(i)}=\mathbf{Ex}^{(i)}+\mathbf{W}_{pos}^{i}\in\mathbb{R}^{D}
\mathbf{E}\in\mathbb{R}^{D\times CP^{2}}
\mathbf{W}_{pos}\in\mathbb{R}^{D}
i
[CLS]
\mathbf{z}^{[CLS]}\in\mathbb{R}^{D}
\mathbf{z}=[\mathbf{z}^{[CLS]},\mathbf{z}^{(1)},\mathbf{z}^{(2)},\cdots,%
\mathbf{z}^{(N)}]
[CLS]
f_{\theta}
\theta
f_{\theta}(\mathbf{x})=f_{\theta}\left(\left[\mathbf{z}^{[CLS]},\mathbf{z}^{(1%
)},\mathbf{z}^{(2)},\cdots,\mathbf{z}^{(N)}\right]\right)=\left[f_{\theta}^{[%
CLS]}(\mathbf{x}),f_{\theta}^{(1)}(\mathbf{x}),f_{\theta}^{(2)}(\mathbf{x}),%
\cdots,f_{\theta}^{(N)}(\mathbf{x})\right],
f_{\theta}^{[CLS]}(x)
f_{\theta}^{(i)}(\mathbf{x})
i
\mathbf{x}
(\mathbf{x}_{A},\mathbf{x}_{B})
\mathcal{L}_{DINO}=H\left(g_{\gamma}\left(f_{\theta}^{[CLS]}(\mathbf{x}_{A})%
\right),sg\left(g_{\gamma^{\prime}}(f_{\theta^{\prime}}^{[CLS]}(\mathbf{x}_{B}%
))\right)\right),
H(a,b)=-a\log b
sg(\cdot)
g_{\gamma}
\gamma^{\prime}
\theta^{\prime}
\mathcal{L}_{Q}
\mathcal{L}_{Q}
[CLS]
[CLS]
Q
Q
16\times 16
8\times 8
\mathbf{X}^{q}\in\mathbb{R}^{Q\times CP^{2}}
i
\mathbf{x}^{q_{i}}
\mathbf{z}^{(q_{i})}
\mathbf{z}=\left[\mathbf{z}^{[CLS]},\underbrace{\mathbf{z}^{(1)},\mathbf{z}^{(%
2)},\cdots,\mathbf{z}^{(N)}}_{\text{raw patches}},\underbrace{\mathbf{z}^{(q_{%
1})},\mathbf{z}^{(q_{2})},\cdots,\mathbf{z}^{(q_{Q})}}_{\text{query patches}}%
\right].
\mathbf{z}^{[CLS]}
[\mathbf{z}^{(1)},\mathbf{z}^{(2)},\cdots,\mathbf{z}^{(N)}]
[CLS]
[CLS]
\mathbf{z}^{[CLS]}
[\mathbf{z}^{(1)},\mathbf{z}^{(2)},\cdots,\mathbf{z}^{(N)}]
[\mathbf{z}^{(q_{1})},\mathbf{z}^{(q_{2})},\cdots,\mathbf{z}^{(q_{Q})}]
\mathbf{z}^{\prime}=[\mathbf{z}^{[CLS]},\mathbf{z}^{(1)},\mathbf{z}^{(2)},%
\cdots,\mathbf{z}^{(N)}]
\mathbf{z}^{q}=[\mathbf{z}^{(q_{1})},\mathbf{z}^{(q_{2})},\cdots,\mathbf{z}^{(%
q_{Q})}]
\mathbf{z}^{[CLS]}
\operatorname{Attn}(\mathbf{Q}_{\mathbf{z}^{\prime}},\mathbf{K}_{\mathbf{z}^{%
\prime}},\mathbf{V}_{\mathbf{z}^{\prime}})=\operatorname{Softmax}\left(\frac{%
\mathbf{Q_{\mathbf{z}^{\prime}}K_{\mathbf{z}^{\prime}}}^{\top}}{\sqrt{d_{k}}}%
\right)\mathbf{V}_{\mathbf{z}^{\prime}},
\mathbf{Q}_{\mathbf{z}^{\prime}}=\mathbf{z}^{\prime}\mathbf{W}_{\mathbf{Q}},%
\mathbf{K}=\mathbf{z}^{\prime}\mathbf{W}_{\mathbf{K}},\mathbf{V}=\mathbf{z}^{%
\prime}\mathbf{W}_{\mathbf{V}}
\mathbf{W}_{\mathbf{Q}},\mathbf{W}_{\mathbf{K}},\mathbf{W}_{\mathbf{V}}
\mathbf{z}^{(q_{i})}
[CLS]
\operatorname{Attn}(\mathbf{Q}_{\mathbf{z}^{(q_{i})}},\mathbf{K}_{\mathbf{z}^{%
\prime}},\mathbf{V}_{\mathbf{z}^{\prime}})=\operatorname{Softmax}\left(\frac{%
\mathbf{Q_{\mathbf{z}^{(q_{i})}}K_{\mathbf{z}^{\prime}}}^{\top}}{\sqrt{d_{k}}}%
\right)\mathbf{V}_{\mathbf{z}^{\prime}},\ \ \ 1\leq i\leq Q,
\mathbf{Q}_{\mathbf{z}^{(q_{i})}}=\mathbf{z}^{(q_{i})}\mathbf{W}_{\mathbf{Q}}
RP\rightarrow RP
\{RP,QP_{i}\}\rightarrow QP_{i}
QP_{i}\nrightarrow QP_{j}\ (i\neq j)
RP
QP_{i}
[CLS]
i
[CLS]
[CLS]
\mathbf{x}_{A}
\mathbf{x}_{B}
f_{\theta}
g_{\gamma}
\mathbf{h}^{[CLS]}_{A;B}
\mathbf{h}_{A;B}
\mathbf{h}^{q}_{A;B}
\mathcal{L}_{ADCLR}=\underbrace{H(\mathbf{h}^{[CLS]}_{A},\mathbf{h}^{[CLS]}_{B%
})}_{\text{Global}}+\underbrace{\frac{\lambda}{Q}\sum_{i=1}^{Q}H(\mathbf{h}^{(%
q_{i})}_{A},\mathbf{h}^{(q_{i})}_{B})}_{\text{Local}},
\lambda
\lambda
\{\mathbf{x}\}_{i=1}^{Q}
\{\mathbf{x}\}_{i=1}^{N}
Q
Q>>
{\dagger}
\cdot
{\ddagger}
{\dagger}
\cdot
{\ddagger}
k
k
k
r=2+(\frac{96}{224})^{2}\times 10=3.84\approx 4
r=2+(\frac{96}{224})^{2}\times 10+(\frac{16}{224})^{2}\times 10=3.89\approx 4
k
{}^{bb}_{50}
{}^{bb}_{75}
{}^{mk}_{50}
{}^{mk}_{75}
\lambda=0.5
Q=10
\lambda
\lambda
Q
Q
\lambda
Q
\lambda
\lambda
\mathcal{L}_{Local}
\lambda=0.5
\lambda
\lambda
[CLS]
Q
\lambda
\lambda=0.5
Q
Q=9
Q=10
Q
Q=15
Q=10
[CLS]
Q=1
\sim
Q
Q=196
s
s
s
s
\times
\times
\times
\times
\times
\times
\times
\times
\times
k
k
Q
1\leq Q\leq 10
\mathbf{g},\mathbf{b}
Attn(\mathbf{x},\mathbf{W}_{Q},\mathbf{W}_{K},\mathbf{W}_{V})=Softmax(\frac{(%
\mathbf{xW}_{Q})(\mathbf{xW}_{K})^{\top}}{\sqrt{d}})\mathbf{xW}_{V}
\mathbf{W}_{Q}
\mathbf{W}_{K}
\mathbf{W}_{V}
\sqrt{d}
\mathbf{x}\in\mathbb{R}^{(1+N+Q)\times d}
[CLS]
s^{i;j}=\frac{(\mathbf{x}_{i}\mathbf{W}_{Q})(\mathbf{x}_{j}\mathbf{W}_{K})^{%
\top}}{\sqrt{d}}
\frac{e^{-1}}{(N+Q)e+e^{-1}}\leq s^{i;j}\leq\frac{e}{(N+Q)e^{-1}+e}
\|\mathbf{x}_{i}\mathbf{W}_{Q}\|_{2}^{2}=1
[\mathbf{x}^{0}_{A},\mathbf{x}^{1}_{A},\mathbf{x}^{2}_{A},\cdots,\mathbf{x}^{Q%
}_{A},\cdots,\mathbf{x}^{N+Q}_{A}]
[\mathbf{x}^{0}_{B},\mathbf{x}^{1}_{B},\mathbf{x}^{2}_{B},\cdots,\mathbf{x}^{Q%
}_{B},\cdots,\mathbf{x}^{N+Q}_{B}]
\mathbf{x}^{i}_{A}=\mathbf{x}^{i}_{B}
1\leq i\leq Q
i
\mathbf{z}^{i}_{A}
\mathbf{z}^{i}_{B}
\mathbf{z}^{i}_{A}=(\sum_{i=0}^{N+Q}s^{i;j}_{A}\cdot\mathbf{x}^{j}_{A})\mathbf%
{W}_{V},\ \ \ \mathbf{z}^{i}_{B}=(\sum_{i=0}^{N+Q}s^{i;j}_{B}\cdot\mathbf{x}_{%
B}^{j})\mathbf{W}_{V},\ \ \ 0\leq i\leq N+Q
max\ sim(\mathbf{z}^{i}_{A},\mathbf{z}^{i}_{B})
0\leq i\leq Q
\mathbf{z}_{0}
[CLS]
\frac{\partial\mathcal{L}(z^{i}_{A},z^{i}_{B})}{\partial s^{i;j}_{A}}=\frac{%
\partial\mathcal{L}(z^{i}_{A},z^{i}_{B})}{\mathcal{H}(z^{i}_{A},z^{i}_{B})}%
\cdot\frac{\partial\mathcal{H}(z^{i}_{A},z^{i}_{B})}{\partial s^{i;j}_{A}}=%
\frac{\partial\|(\sum_{j=0}^{N+Q}s^{i;j}_{A}\mathbf{x}_{A}^{j}-\sum_{j=0}^{N+Q%
}s^{i;j}_{A}\mathbf{x}_{B}^{j})\mathbf{W}_{V}\|_{2}^{2}}{\partial s^{i;j}_{A}}
s^{i;j}_{A}
i
j
A
\mathbf{x}
Q>>N
\|(\sum_{j=0}^{Q}s^{i;j}_{A}\mathbf{x}_{A}^{j}-\sum_{j=0}^{Q}s^{i;j}_{A}%
\mathbf{x}_{B}^{j})\mathbf{W}_{V}\|_{2}^{2}
s^{i;j}_{A}=s^{i;j}_{B}
0\leq i,j\leq Q
\mathcal{L}(z^{i}_{A},z^{i}_{B})=0
\mathbf{x}_{A}^{i}=\mathbf{x}_{B}^{i}
0\leq i\leq Q
\tau
\tau_{t}
\lambda=0.5
