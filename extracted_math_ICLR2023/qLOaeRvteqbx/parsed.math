D
n
(x_{i},a_{i},y_{i})
x_{i}\in\mathbb{R}^{d}
y_{i}\in\{0,1\}
a_{i}\in[K]
a_{i}
x_{i}
y_{i}
f_{\theta}:\mathbb{R}^{d}\to[0,1]
\theta
\ell:[0,1]\times\{0,1\}\to\mathbb{R}
\mathcal{L}(\theta;D)=\frac{1}{n}\sum_{i\in D}\ell(f_{\theta}(x_{i}),y_{i})
\theta^{*}=\arg\min_{\theta}\mathcal{L}(\theta;D)
\tilde{\theta}
D
k
D_{k}=\{(x_{i},a_{i},y_{i})\in D\,|\,a_{i}=k\}
D_{k}
\pi(\theta,D_{k})=\text{acc}(\theta^{*};D_{k})-\mathbb{E}_{\tilde{\theta}}[%
\text{acc}(\tilde{\theta};D_{k})],
R(\theta,D_{k})=\mathbb{E}_{\tilde{\theta}}[\mathcal{L}(\tilde{\theta};D_{k})]%
-\mathcal{L}(\theta^{*};D_{k}).
R(\theta;D_{k})
R_{k}
\pi_{k}
\pi_{a,b}=|\pi_{a}-\pi_{b}|
a,b\in[K]
R_{a,b}=|R_{a}-R_{b}|
T
D
q
C_{0}
\sigma
\eta_{t}
\theta_{0}
t\text{ in }0,\dots,T-1
B\leftarrow\text{Poisson sample of }D\text{ with rate }q
(x_{i},y_{i})\text{ in }B
g_{i}\leftarrow\nabla_{\theta}\ell(f_{\theta_{t}}(x_{i}),y_{i})
\bar{g}_{i}\leftarrow g_{i}\cdot\min\left(1,\frac{C_{0}}{\|g_{i}\|}\right)
\tilde{g}_{B}\leftarrow\frac{1}{|B|}\left(\sum_{i\in B}\bar{g}_{i}+\mathcal{N}%
(0,\sigma^{2}C_{0}^{2}\mathbb{I})\right)
\theta_{t+1}\leftarrow\theta_{t}-\eta_{t}\tilde{g}_{B}
D
M
(\epsilon,\delta)
S\subseteq\text{Range}(M)
D
D^{\prime}
\text{Pr}[M(D)\in S]\leq\exp(\epsilon)\,\text{Pr}[M(D^{\prime})\in S]+\delta.
g_{i}
\Delta_{h}=\max_{D,D^{\prime}}\|h(D)-h(D^{\prime})\|
h
C_{0}
\bar{g}_{i}
B\subset D
\bar{g}_{B}
\tilde{g}_{B}
\mathcal{L}(\theta;D_{a})
a
R_{a}
\ell
\mathbb{E}[\mathcal{L}(\theta_{t+1};D_{a})]
a\in[K]
t
\|\theta_{t+1}-\theta_{t}\|
\displaystyle\vspace{-8pt}\mathbb{E}[\mathcal{L}(\theta_{t+1};D_{a})]\approx\,%
\mathcal{L}(\theta_{t};D_{a})-\eta_{t}\langle g_{D_{a}},g_{D}\rangle+\tfrac{%
\eta_{t}^{2}}{2}\mathbb{E}[g^{T}_{B}H_{\ell}^{a}g_{B}]
\displaystyle\vspace{-8pt}\mathbb{E}[\mathcal{L}(\theta_{t+1};D_{a})]\approx
\displaystyle\,\mathcal{L}(\theta_{t};D_{a})-\eta_{t}\langle g_{D_{a}},g_{D}%
\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}[g^{T}_{B}H_{\ell}^{a}g_{B}]
R_{a}^{\text{clip}}
R_{a}^{\text{clip}}
R_{a}^{\text{clip}}
\displaystyle+\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}\rangle+\tfrac{\eta_{%
t}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}]-\mathbb{E}[%
g_{B}^{T}H^{a}_{\ell}g_{B}]\right)
\displaystyle+\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}\rangle+\tfrac{\eta_{%
t}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}]-\mathbb{E}[%
g_{B}^{T}H^{a}_{\ell}g_{B}]\right)
R_{a}^{\text{noise}}
R_{a}^{\text{noise}}
R_{a}^{\text{noise}}
\displaystyle+\tfrac{\eta_{t}^{2}}{2}\textup{Tr}(H^{a}_{\ell})C_{0}^{2}\sigma^%
{2}.
\displaystyle+\tfrac{\eta_{t}^{2}}{2}\textup{Tr}(H^{a}_{\ell})C_{0}^{2}\sigma^%
{2}.
R_{a}^{\text{clip}}
\bar{g}_{B}=g_{B}
g_{D_{a}}
H_{\ell}^{a}
a
R_{a}^{\text{noise}}
D_{a}
\|x_{i}\|
R_{a}^{\text{clip}}
\bar{g}_{B}
\|g_{B}\|
g_{B}
\eta_{t}
\bar{g}_{B}{=}M_{B}\left(\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right)
M_{B}
\bar{g}_{B}
M_{B}g_{B}
\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
M_{B}g_{B}
\bar{g}_{B}
g_{B}
g_{B}
\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
\bar{g}_{B}{=}M_{B}\left(\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right)
\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
\ell
a\in[K]
t
\|\theta_{t+1}-\theta_{t}\|
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
\displaystyle R_{a}^{\textup{clip}}\approx\,{\eta_{t}}\left\langle g_{D_{a}},%
\mathbb{E}\left[\left(1-\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}\right)g_{B}\right]%
\right\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[\left(\tfrac{\|\bar{g}_{B%
}\|^{2}}{\|g_{B}\|^{2}}-1\right)g_{B}^{T}H_{\ell}^{a}g_{B}\right]
\displaystyle R_{a}^{\textup{clip}}
\displaystyle\approx\,{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\left(1%
-\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}\right)g_{B}\right]\right\rangle+\tfrac{%
\eta_{t}^{2}}{2}\mathbb{E}\left[\left(\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2%
}}-1\right)g_{B}^{T}H_{\ell}^{a}g_{B}\right]
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
\displaystyle+{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\tfrac{\|\bar{g%
}_{B}\|}{\|g_{B}\|}(g_{B}{-}M_{B}g_{B})\right]\right\rangle\!+\!\tfrac{\eta_{t%
}^{2}}{2}\mathbb{E}\left[\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B%
}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B}){-}g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right],
\displaystyle+{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\tfrac{\|\bar{g%
}_{B}\|}{\|g_{B}\|}(g_{B}{-}M_{B}g_{B})\right]\right\rangle\!+\!\tfrac{\eta_{t%
}^{2}}{2}\mathbb{E}\left[\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B%
}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B}){-}g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right],
g_{D_{a}}
\bar{g}_{D_{a}}
a
t
H^{a}_{\ell}
a
M_{B}
\bar{g}_{B}
M_{B}g_{B}
\|g_{B}\|{=}\|\bar{g}_{B}\|
R_{a}^{\text{mag}}{=}0
M_{B}
R_{a}^{\text{dir}}=0
R_{a}^{\text{dir}}>R_{b}^{\text{dir}}
x^{T}y\geq-\|x\|\|y\|
R_{a}^{\text{clip}}
R_{a}^{\text{dir}}-R_{b}^{\text{dir}}
x^{T}y=\|x\|\|y\|\cos\theta
\theta=\angle(x,y)
\ell
\eta_{t}\leq(\max_{k\in[K]}\lambda_{k})^{-1}
\lambda_{k}
H_{\ell}^{k}
a,b\in[K]
R^{\textup{dir}}_{a}>R^{\textup{dir}}_{b}
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\tfrac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\tfrac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|},
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\tfrac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\tfrac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|},
\theta^{k}_{B}\!=\!\angle(g_{D_{k}},g_{B})
\bar{\theta}^{k}_{B}\!=\!\angle(g_{D_{k}},\bar{g}_{B})
k\!\in\![K]
a
b
a
R_{a}^{\text{dir}}-R_{b}^{\text{dir}}
a
b
\theta_{B}^{i}\approx\bar{\theta}_{B}^{i}
i=a,b
R_{a}^{\text{dir}}-R_{b}^{\text{dir}}\approx 0
\|g_{D_{a}}\|
\|g_{D_{b}}\|
R_{a}^{\text{dir}}
\|g_{D_{a}}\|
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{noise}}
\theta^{*}_{i}
\theta^{*}
T
D
q
C_{0}
Z\geq C_{0}
\sigma_{1}
\sigma_{2}
\eta_{t}
\eta_{Z}
\tau\geq 0
\theta_{0}
t\text{ in }0,\dots,T-1
B\leftarrow\text{Poisson sample of }D\text{ with rate }q
(x_{i},y_{i})\text{ in }B
g_{i}\leftarrow\nabla_{\theta}\ell(f_{\theta_{t}}(x_{i}),y_{i})
\gamma_{i}\leftarrow\begin{cases}\frac{C_{0}}{Z},&\|g_{i}\|\leq Z\\
0\ \ {\color[rgb]{1,0,0}(\frac{C_{0}}{\|g_{i}\|})},&\|g_{i}\|>Z\end{cases}
\bar{g}_{i}\leftarrow\gamma_{i}g_{i}
\tilde{g}_{B}\leftarrow\frac{1}{|B|}\left(\sum_{i\in B}\bar{g}_{i}+\mathcal{N}%
(0,\sigma_{1}^{2}C_{0}^{2}\mathbb{I})\right)
\theta_{t+1}\leftarrow\theta_{t}-\eta_{t}\tilde{g}_{B}
Z
b_{t}\leftarrow\left|\left\{i:\|g_{i}\|>\tau\cdot Z\right\}\right|
\tilde{b}_{t}\leftarrow\frac{1}{|B|}(b_{t}+\mathcal{N}(0,\sigma_{2}^{2}))
Z\leftarrow Z\cdot\exp(-\eta_{Z}+\tilde{b}_{t})
R_{a}^{\text{dir}}
g_{B}
Z
C_{0}
C_{0}
Z
C_{0}
C_{0}
\bar{g}_{i}=\gamma g_{i}
0\!<\!\gamma\!<\!1
Z\geq\|g_{i}\|\,\forall\,i\in D
\gamma=C_{0}/Z
C_{0}
\bar{g}_{i}
\max_{i\in D}\|g_{i}\|
Z
C_{0}
Z
\|g_{i}\|>Z
Z
Z
\bar{g}_{i}
\|g_{i}\|>Z
C_{0}
Z
Z
\max_{i\in B}\|g_{i}\|
Z
Z
Z
b_{t}
B
Z
\tau\geq 0
b_{t}
\tilde{b}_{t}=\tfrac{1}{|B|}(b_{t}+\mathcal{N}(0,\sigma_{2}^{2}))
Z\leftarrow Z\cdot\exp(-\eta_{Z}+\tilde{b}_{t})
\eta_{Z}
\tau\cdot Z
\tilde{b}_{t}=0
Z
\exp(-\eta_{Z})
Z
\tilde{b}_{t}>\eta_{Z}
\frac{b_{t}}{|B|}\geq\eta_{Z}+\frac{2\sigma_{2}}{|B|}
|B|\eta_{Z}+2\sigma_{2}
\tau\cdot Z
C_{0}
\tau\cdot Z
\epsilon
\delta
\sigma_{1}
\sigma_{2}>0
\epsilon
\delta
b_{t}
\sigma_{2}\approx 10\sigma_{1}
\|g_{B}\|
\|g_{B}\|
\pi_{a}
R_{a}
\pi_{a,b}
R_{a,b}
\pm
\tanh
\delta=10^{-6}
\sigma=1
C_{0}=0.5
\sigma=1
C_{0}=0.1
\sigma=0.8
C_{0}=1
\epsilon=3.41
\epsilon=2.27
\epsilon=5.90
\epsilon=2.49
\epsilon
\epsilon
\pi_{\textsc{2}}
\pi_{\textsc{8}}
\pi_{\textsc{2,8}}
R_{\textsc{2}}
R_{\textsc{8}}
R_{\textsc{2,8}}
98.0
\pm 0.1
84.3
\pm 1.1
0.06
\pm 0.00
0.32
\pm 0.01
89.0
\pm 0.1
26.3
\pm 0.4
8.9
\pm 0.1
57.9
\pm 1.3
48.9
\pm 1.3
0.67
\pm 0.01
2.56
\pm 0.04
0.61
\pm 0.01
2.24
\pm 0.03
1.63
\pm 0.03
89.5
\pm 0.1
59.3
\pm 0.4
8.5
\pm 0.1
24.9
\pm 1.3
16.4
\pm 1.3
0.65
\pm 0.01
1.47
\pm 0.04
0.59
\pm 0.01
1.16
\pm 0.03
0.56
\pm 0.04
90.6
\pm 0.2
62.0
\pm 2.6
7.4
\pm 0.1
22.2
\pm 2.6
14.8
\pm 2.7
0.34
\pm 0.01
1.31
\pm 0.04
0.28
\pm 0.01
0.99
\pm 0.03
0.71
\pm 0.04
92.0
\pm 0.2
65.5
\pm 1.2
6.0
\pm 0.2
18.8
\pm 0.9
12.8
\pm 0.8
0.35
\pm 0.01
1.20
\pm 0.04
0.29
\pm 0.01
0.89
\pm 0.03
0.60
\pm 0.03
\pi_{\textsc{W/O}}
\pi_{\textsc{W}}
\pi_{\textsc{W/O, W}}
R_{\textsc{W/O}}
R_{\textsc{W}}
R_{\textsc{W/O, W}}
95.8
\pm 0.1
89.7
\pm 0.4
0.11
\pm 0.00
0.24
\pm 0.01
86.5
\pm 0.2
74.0
\pm 0.6
9.3
\pm 0.3
15.7
\pm 0.6
6.4
\pm 0.7
0.60
\pm 0.01
1.34
\pm 0.05
0.49
\pm 0.01
1.10
\pm 0.05
0.61
\pm 0.05
91.8
\pm 0.2
79.7
\pm 0.5
4.0
\pm 0.2
10.0
\pm 0.6
6.0
\pm 0.6
0.32
\pm 0.01
0.97
\pm 0.04
0.21
\pm 0.01
0.73
\pm 0.04
0.52
\pm 0.04
93.1
\pm 0.3
82.5
\pm 0.5
2.7
\pm 0.3
7.2
\pm 0.6
4.5
\pm 0.5
0.21
\pm 0.01
0.57
\pm 0.05
0.10
\pm 0.01
0.33
\pm 0.05
0.24
\pm 0.04
94.2
\pm 0.1
84.5
\pm 0.2
1.6
\pm 0.2
5.2
\pm 0.5
3.6
\pm 0.4
0.17
\pm 0.00
0.45
\pm 0.01
0.06
\pm 0.00
0.21
\pm 0.01
0.15
\pm 0.01
p<0.05
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{0,1}
R_{0,1}
R_{0,1}
R_{0,1}
R_{0,1}
R_{0,1}
R_{a}^{\text{clip}}\!-\!R_{b}^{\text{clip}}
R_{a}^{\text{dir}}\!-\!R_{b}^{\text{dir}}
R_{0}^{\text{clip}}\!>\!R_{1}^{\text{clip}}
R_{0}^{\text{dir}}\!-\!R_{1}^{\text{dir}}
\ell
a\in[K]
t
\|\theta_{t+1}-\theta_{t}\|
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
\displaystyle R_{a}^{\textup{clip}}\approx\,{\eta_{t}}\left\langle g_{D_{a}},%
\mathbb{E}\left[\left(1-\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}\right)g_{B}\right]%
\right\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[\left(\tfrac{\|\bar{g}_{B%
}\|^{2}}{\|g_{B}\|^{2}}-1\right)g_{B}^{T}H_{\ell}^{a}g_{B}\right]
\displaystyle R_{a}^{\textup{clip}}
\displaystyle\approx\,{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\left(1%
-\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}\right)g_{B}\right]\right\rangle+\tfrac{%
\eta_{t}^{2}}{2}\mathbb{E}\left[\left(\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2%
}}-1\right)g_{B}^{T}H_{\ell}^{a}g_{B}\right]
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
\displaystyle+{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\tfrac{\|\bar{g%
}_{B}\|}{\|g_{B}\|}(g_{B}{-}M_{B}g_{B})\right]\right\rangle+\tfrac{\eta_{t}^{2%
}}{2}\mathbb{E}\left[\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{%
B})^{T}H^{a}_{\ell}(M_{B}g_{B}){-}g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right],
\displaystyle+{\eta_{t}}\left\langle g_{D_{a}},\mathbb{E}\left[\tfrac{\|\bar{g%
}_{B}\|}{\|g_{B}\|}(g_{B}{-}M_{B}g_{B})\right]\right\rangle+\tfrac{\eta_{t}^{2%
}}{2}\mathbb{E}\left[\tfrac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{%
B})^{T}H^{a}_{\ell}(M_{B}g_{B}){-}g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right],
g_{D_{a}}
\bar{g}_{D_{a}}
a
t
H^{a}_{\ell}
a
M_{B}
\bar{g}_{B}
M_{B}g_{B}
M_{B}
\bar{g}_{B}=M_{B}\left(\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right)
\|\bar{g}_{B}\|=\left\|\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right\|
g_{B}
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
a
t
\mathbb{E}\left[\mathcal{L}\left(\theta_{t}-\eta_{t}\frac{\|\bar{g}_{B}\|}{\|g%
_{B}\|}g_{B};D_{a}\right)-\mathcal{L}\left(\theta_{t}-\eta_{t}g_{B};D_{a}%
\right)\right],
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
g_{B}
\mathbb{E}\left[\mathcal{L}\left(\theta_{t}-\eta_{t}\frac{\|\bar{g}_{B}\|}{\|g%
_{B}\|}g_{B};D_{a}\right)\right]
\displaystyle\mathbb{E}\left[\mathcal{L}\left(\theta_{t}-\eta_{t}\frac{\|\bar{%
g}_{B}\|}{\|g_{B}\|}g_{B};D_{a}\right)\right]\approx\mathcal{L}\left(\theta_{t%
};D_{a}\right)-\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_%
{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}{2}\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a}g_{B}%
\right].
\displaystyle\mathbb{E}\left[\mathcal{L}\left(\theta_{t}-\eta_{t}\frac{\|\bar{%
g}_{B}\|}{\|g_{B}\|}g_{B};D_{a}\right)\right]
\displaystyle\approx\mathcal{L}\left(\theta_{t};D_{a}\right)-\eta_{t}\left%
\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right%
]\right\rangle+\frac{\eta_{t}^{2}}{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}%
}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a}g_{B}\right].
\displaystyle R_{a}^{\text{clip}}=\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}%
\rangle+\frac{\eta_{t}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar%
{g}_{B}]-\mathbb{E}[g_{B}^{T}H^{a}_{\ell}g_{B}]\right)
\displaystyle R_{a}^{\text{clip}}
\displaystyle=\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}\rangle+\frac{\eta_{t%
}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}]-\mathbb{E}[g%
_{B}^{T}H^{a}_{\ell}g_{B}]\right)
\displaystyle=\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}\rangle+\frac{\eta_{t%
}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}]-\mathbb{E}[g%
_{B}^{T}H^{a}_{\ell}g_{B}]\right)
\displaystyle=\eta_{t}\langle g_{D_{a}},g_{D}-\bar{g}_{D}\rangle+\frac{\eta_{t%
}^{2}}{2}\left(\mathbb{E}[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}]-\mathbb{E}[g%
_{B}^{T}H^{a}_{\ell}g_{B}]\right)
\displaystyle\hskip 42.67912pt-\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}%
{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^%
{a}g_{B}\right]
\displaystyle\hskip 42.67912pt-\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}%
{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^%
{a}g_{B}\right]
\displaystyle\hskip 42.67912pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle-\frac{\eta_{t}^{2}}%
{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^%
{a}g_{B}\right]
\displaystyle\hskip 42.67912pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle-\frac{\eta_{t}^{2}}%
{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^%
{a}g_{B}\right]
\displaystyle=\eta_{t}\left\langle g_{D_{a}},g_{D}-\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}{2}\left%
(\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a%
}g_{B}\right]-\mathbb{E}\left[g_{B}^{T}H_{\ell}^{a}g_{B}\right]\right)
\displaystyle=\eta_{t}\left\langle g_{D_{a}},g_{D}-\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}{2}\left%
(\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a%
}g_{B}\right]-\mathbb{E}\left[g_{B}^{T}H_{\ell}^{a}g_{B}\right]\right)
\displaystyle\hskip 14.22636pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]-\bar{g}_{D}\right\rangle+\frac{%
\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}%
\right]-\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{%
\ell}^{a}g_{B}\right]\right)
\displaystyle\hskip 14.22636pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]-\bar{g}_{D}\right\rangle+\frac{%
\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}%
\right]-\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{%
\ell}^{a}g_{B}\right]\right)
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
R_{a}^{\text{mag}}
\displaystyle=\eta_{t}\left\langle g_{D_{a}},g_{D}-\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}{2}%
\mathbb{E}\left[\left(\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}-1\right)g_{B}^%
{T}H_{\ell}^{a}g_{B}\right]
\displaystyle=\eta_{t}\left\langle g_{D_{a}},g_{D}-\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]\right\rangle+\frac{\eta_{t}^{2}}{2}%
\mathbb{E}\left[\left(\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}-1\right)g_{B}^%
{T}H_{\ell}^{a}g_{B}\right]
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
R_{a}^{\text{dir}}
\displaystyle\hskip 14.22636pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]-\bar{g}_{D}\right\rangle+\frac{%
\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}%
\right]-\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{%
\ell}^{a}g_{B}\right]\right).
\displaystyle\hskip 14.22636pt+\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[%
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right]-\bar{g}_{D}\right\rangle+\frac{%
\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\bar{g}_{B}^{T}H^{a}_{\ell}\bar{g}_{B}%
\right]-\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{%
\ell}^{a}g_{B}\right]\right).
R_{a}^{\text{dir}}
\bar{g}_{D}=\mathbb{E}[\bar{g}_{B}]
\bar{g}_{B}=M_{B}\left(\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right)
M_{B}
\displaystyle R_{a}^{\text{dir}}=\ \eta_{t}\left\langle g_{D_{a}},\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}-M_{B}\left(\frac{\|\bar{g}_{B}\|}%
{\|g_{B}\|}g_{B}\right)\right]\right\rangle
\displaystyle R_{a}^{\text{dir}}=
\displaystyle\ \eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_%
{B}\|}{\|g_{B}\|}g_{B}-M_{B}\left(\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right%
)\right]\right\rangle
\displaystyle+\frac{\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\frac{\|\bar{g}_{B}%
\|^{2}}{\|g_{B}\|^{2}}(M_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})\right]-\mathbb{%
E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a}g_{B}%
\right]\right)
\displaystyle+\frac{\eta_{t}^{2}}{2}\left(\mathbb{E}\left[\frac{\|\bar{g}_{B}%
\|^{2}}{\|g_{B}\|^{2}}(M_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})\right]-\mathbb{%
E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}g_{B}^{T}H_{\ell}^{a}g_{B}%
\right]\right)
\displaystyle=\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_{%
B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle+\frac{\eta_{t}^{2}}{2}%
\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T%
}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right].
\displaystyle=\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_{%
B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle+\frac{\eta_{t}^{2}}{2}%
\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T%
}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right].
\ell
\eta_{t}\leq(\max_{k\in[K]}\lambda_{k})^{-1}
\lambda_{k}
H_{\ell}^{k}
a,b\in[K]
R^{\textup{dir}}_{a}>R^{\textup{dir}}_{b}
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|},
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|},
\theta^{k}_{B}\!=\!\angle(g_{D_{k}},g_{B})
\bar{\theta}^{k}_{B}\!=\!\angle(g_{D_{k}},\bar{g}_{B})
k\!\in\![K]
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&=\eta_{t}%
\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}%
-M_{B}g_{B})\right]\right\rangle-\eta_{t}\left\langle g_{D_{b}},\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle%
\\
&\hskip 42.67912pt+\frac{\eta_{t}^{2}}{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|%
^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_%
{\ell}^{a}g_{B}\right)\right]\\
&\hskip 42.67912pt-\frac{\eta_{t}^{2}}{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|%
^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T}H^{b}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_%
{\ell}^{b}g_{B}\right)\right].\end{aligned}
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&=\eta_{t}%
\left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}%
-M_{B}g_{B})\right]\right\rangle-\eta_{t}\left\langle g_{D_{b}},\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle%
\\
&\hskip 42.67912pt+\frac{\eta_{t}^{2}}{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|%
^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_%
{\ell}^{a}g_{B}\right)\right]\\
&\hskip 42.67912pt-\frac{\eta_{t}^{2}}{2}\mathbb{E}\left[\frac{\|\bar{g}_{B}\|%
^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T}H^{b}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_%
{\ell}^{b}g_{B}\right)\right].\end{aligned}
\langle x,y\rangle=\|x\|\|y\|\cos(x,y)
\displaystyle\begin{aligned} \left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle&=\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}\left(\left\langle g_{D_{a}},g_{B}%
\right\rangle-\left\langle g_{D_{a}},M_{B}g_{B}\right\rangle\right)\right]\\
&=\|g_{D_{a}}\|\mathbb{E}\bigg{[}\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}\big{(}\|g_{%
B}\|\cos(g_{D_{a}},g_{B})\\
&\hskip 85.35826pt-\|M_{B}g_{B}\|\cos(g_{D_{a}},M_{B}g_{B})\big{)}\bigg{]}\\
&=\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right],\end{aligned}
\displaystyle\begin{aligned} \left\langle g_{D_{a}},\mathbb{E}\left[\frac{\|%
\bar{g}_{B}\|}{\|g_{B}\|}(g_{B}-M_{B}g_{B})\right]\right\rangle&=\mathbb{E}%
\left[\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}\left(\left\langle g_{D_{a}},g_{B}%
\right\rangle-\left\langle g_{D_{a}},M_{B}g_{B}\right\rangle\right)\right]\\
&=\|g_{D_{a}}\|\mathbb{E}\bigg{[}\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}\big{(}\|g_{%
B}\|\cos(g_{D_{a}},g_{B})\\
&\hskip 85.35826pt-\|M_{B}g_{B}\|\cos(g_{D_{a}},M_{B}g_{B})\big{)}\bigg{]}\\
&=\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right],\end{aligned}
\theta_{B}^{a}=\angle(g_{D_{a}},g_{B})
\bar{\theta}_{B}^{a}=\angle(g_{D_{a}},M_{B}g_{B})=\angle(g_{D_{a}},\bar{g}_{B})
M_{B}
\bar{g}_{B}
M_{B}g_{B}
\|g_{B}\|=\|M_{B}g_{B}\|
\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T%
}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right]
\ell
H^{a}_{\ell}
x^{T}H^{a}_{\ell}x\geq 0
x
\mathbb{E}[x^{T}H^{a}_{\ell}x]\geq 0
\displaystyle\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M%
_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right%
]\leq\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}(M_{B}g_{B})^{T}%
H^{a}_{\ell}(M_{B}g_{B})\right].
\displaystyle\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M%
_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right]
\displaystyle\leq\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}(M_{%
B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})\right].
\ell
H^{a}_{\ell}
x^{T}H^{a}_{\ell}x\leq\lambda_{a}\|x\|^{2}
\lambda_{a}
H^{a}_{\ell}
\|M_{B}g_{B}\|=\|g_{B}\|
\displaystyle\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M%
_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right%
]\leq\lambda_{a}\mathbb{E}\left[\|\bar{g}_{B}\|^{2}\right].
\displaystyle\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M%
_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right]
\displaystyle\leq\lambda_{a}\mathbb{E}\left[\|\bar{g}_{B}\|^{2}\right].
\mathbb{E}\left[\frac{\|\bar{g}_{B}\|^{2}}{\|g_{B}\|^{2}}\left((M_{B}g_{B})^{T%
}H^{a}_{\ell}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right)\right]\geq-\lambda%
_{a}\mathbb{E}[\|\bar{g}_{B}\|^{2}]
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&\geq\eta_{t%
}\left(\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos%
\bar{\theta}_{B}^{a})\right]-\|g_{D_{b}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]\right)\\
&\hskip 42.67912pt-\frac{\eta_{t}^{2}}{2}(\lambda_{a}+\lambda_{b})\mathbb{E}[%
\|\bar{g}_{B}\|^{2}],\end{aligned}
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&\geq\eta_{t%
}\left(\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos%
\bar{\theta}_{B}^{a})\right]-\|g_{D_{b}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]\right)\\
&\hskip 42.67912pt-\frac{\eta_{t}^{2}}{2}(\lambda_{a}+\lambda_{b})\mathbb{E}[%
\|\bar{g}_{B}\|^{2}],\end{aligned}
\eta_{t}\leq\frac{1}{\max_{k\in[K]}\lambda_{k}}
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&\geq\eta_{t%
}\left(\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos%
\bar{\theta}_{B}^{a})\right]\right.\\
&\hskip 71.13188pt-\left.\|g_{D_{b}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]-\mathbb{E}[\|\bar{g}_{B}\|^{2}%
]\right).\end{aligned}
\displaystyle\begin{aligned} R_{a}^{\text{dir}}-R_{b}^{\text{dir}}&\geq\eta_{t%
}\left(\|g_{D_{a}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos%
\bar{\theta}_{B}^{a})\right]\right.\\
&\hskip 71.13188pt-\left.\|g_{D_{b}}\|\mathbb{E}\left[\|\bar{g}_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]-\mathbb{E}[\|\bar{g}_{B}\|^{2}%
]\right).\end{aligned}
R_{a}^{\text{dir}}>R_{b}^{\text{dir}}
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|}.
\displaystyle\mathbb{E}\left[\|\bar{g}_{B}\|(\cos\theta_{B}^{a}-\cos\bar{%
\theta}_{B}^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|%
\bar{g}_{B}\|(\cos\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{%
\mathbb{E}[\|\bar{g}_{B}\|^{2}]}{\|g_{D_{a}}\|}.
g_{B}^{T}H_{\ell}^{a}g_{B}=0
(M_{B}g_{B})^{T}H^{a}_{\ell}(M_{B}g_{B})=\lambda_{a}\|M_{B}g_{B}\|^{2}
H_{\ell}^{a}
g_{B}
M_{B}
\eta_{t}\leq\frac{1}{\max_{k\in[K]}\lambda_{k}}
\eta_{t}=\frac{1}{\max_{k\in[K]}\lambda_{k}}
\bar{g}_{B}{=}M_{B}\left(\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}\right)
g_{B}
\bar{g}_{B}
g_{B}
\bar{g}_{B}
g_{B}
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
\gamma
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
\bar{g}_{B}
\lambda
\displaystyle R_{a}^{\text{mag}}=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}%
\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B};D_{a})-\mathcal{L}(\theta_{t}-\eta_{t}%
g_{B};D_{a})],
\displaystyle R_{a}^{\text{mag}}
\displaystyle=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}\tfrac{\|\bar{g}_{B}\|%
}{\|g_{B}\|}g_{B};D_{a})-\mathcal{L}(\theta_{t}-\eta_{t}g_{B};D_{a})],
\displaystyle R_{a}^{\text{dir}}=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}%
\bar{g}_{B};D_{a})-\mathcal{L}(\theta_{t}-\eta_{t}\tfrac{\|\bar{g}_{B}\|}{\|g_%
{B}\|}g_{B};D_{a})].
\displaystyle R_{a}^{\text{dir}}
\displaystyle=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}\bar{g}_{B};D_{a})-%
\mathcal{L}(\theta_{t}-\eta_{t}\tfrac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B};D_{a})].
g_{B}
M_{B}g_{B}
\alpha
M_{B}g_{B}
\bar{g}_{B}
\beta
\bar{g}_{B}
\displaystyle{R_{a}^{\text{dir}}}^{*}=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{%
t}M_{B}g_{B};D_{a})-\mathcal{L}(\theta_{t}-\eta_{t}g_{B};D_{a})],
\displaystyle{R_{a}^{\text{dir}}}^{*}
\displaystyle=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}M_{B}g_{B};D_{a})-%
\mathcal{L}(\theta_{t}-\eta_{t}g_{B};D_{a})],
\displaystyle{R_{a}^{\text{mag}}}^{*}=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{%
t}\bar{g}_{B};D_{a})-\mathcal{L}(\theta_{t}-\eta_{t}M_{B}g_{B};D_{a})].
\displaystyle{R_{a}^{\text{mag}}}^{*}
\displaystyle=\mathbb{E}[\mathcal{L}(\theta_{t}-\eta_{t}\bar{g}_{B};D_{a})-%
\mathcal{L}(\theta_{t}-\eta_{t}M_{B}g_{B};D_{a})].
\ell
a\in[K]
t
\|\theta_{t+1}-\theta_{t}\|
{R_{a}^{\text{mag}}}^{*}
{R_{a}^{\text{mag}}}^{*}
{R_{a}^{\text{mag}}}^{*}
\displaystyle R_{a}^{\textup{clip}}\approx\eta_{t}\left\langle g_{D_{a}},%
\mathbb{E}\left[\left(\tfrac{\|g_{B}\|}{\|\bar{g}_{B}\|}{-}1\right)\bar{g}_{B}%
\right]\right\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[\left(1-\tfrac{\|g%
_{B}\|^{2}}{\|\bar{g}_{B}\|^{2}}\right)\bar{g}_{B}^{T}H_{\ell}^{a}\bar{g}_{B}%
\right],
\displaystyle R_{a}^{\textup{clip}}
\displaystyle\approx\eta_{t}\left\langle g_{D_{a}},\mathbb{E}\left[\left(%
\tfrac{\|g_{B}\|}{\|\bar{g}_{B}\|}{-}1\right)\bar{g}_{B}\right]\right\rangle+%
\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[\left(1-\tfrac{\|g_{B}\|^{2}}{\|\bar{g}%
_{B}\|^{2}}\right)\bar{g}_{B}^{T}H_{\ell}^{a}\bar{g}_{B}\right],
{R_{a}^{\text{dir}}}^{*}
{R_{a}^{\text{dir}}}^{*}
{R_{a}^{\text{dir}}}^{*}
\displaystyle+\mathbb{E}\left[\eta_{t}\left\langle g_{D_{a}},g_{D}-M_{B}g_{B}%
\right]\right\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[(M_{B}g_{B})^{T}H_%
{\ell}^{a}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right],
\displaystyle+\mathbb{E}\left[\eta_{t}\left\langle g_{D_{a}},g_{D}-M_{B}g_{B}%
\right]\right\rangle+\tfrac{\eta_{t}^{2}}{2}\mathbb{E}\left[(M_{B}g_{B})^{T}H_%
{\ell}^{a}(M_{B}g_{B})-g_{B}^{T}H_{\ell}^{a}g_{B}\right],
g_{D_{a}}
\bar{g}_{D_{a}}
a
t
H^{a}_{\ell}
a
M_{B}
\bar{g}_{B}
M_{B}g_{B}
\ell
\eta_{t}\leq(\max_{k\in[K]}\lambda_{k})^{-1}
\lambda_{k}
H_{\ell}^{k}
a,b\in[K]
R^{\textup{dir}}_{a}>R^{\textup{dir}}_{b}
\displaystyle\mathbb{E}\left[\|g_{B}\|(\cos\theta_{B}^{a}-\cos\bar{\theta}_{B}%
^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|g_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{\mathbb{E}[\|g_{B}\|]}{%
\|g_{D_{a}}\|}
\displaystyle\mathbb{E}\left[\|g_{B}\|(\cos\theta_{B}^{a}-\cos\bar{\theta}_{B}%
^{a})\right]>\frac{\|g_{D_{b}}\|}{\|g_{D_{a}}\|}\mathbb{E}\left[\|g_{B}\|(\cos%
\theta_{B}^{b}-\cos\bar{\theta}_{B}^{b})\right]+\frac{\mathbb{E}[\|g_{B}\|]}{%
\|g_{D_{a}}\|}
\theta^{k}_{B}=\angle(g_{D_{k}},g_{B})
\bar{\theta}^{k}_{B}=\angle(g_{D_{k}},\bar{g}_{B})
k\in[K]
\{\text{white},\text{non-white}\}
\sigma=1
C_{0}=0.5
\sigma=1
C_{0}=0.1
\sigma=0.8
C_{0}=1
\sigma_{2}=\sigma
\sigma_{1}=10\sigma_{2}
\lambda_{1}=\lambda_{2}=1
\eta_{t}=0.01
t
\eta_{t}=0.8
\eta_{t}=1
Z=50
\eta_{t}=2
Z=1
\eta_{t}=0.2
Z=100
\eta_{t}=0.1
Z=100
\sigma_{2}=10,Z=50,\eta_{Z}=0.1
Z=100
\eta_{t}=0.2,\tau=1
\eta=1,\tau=1
\eta=0.1,\tau=0.7
R_{a}^{\text{clip}}
R_{a}^{\text{noise}}
R_{a}^{\text{mag}}
R_{a}^{\text{dir}}
R_{a}^{\text{clip}}
R_{a}^{\text{noise}}
R_{a}^{\text{clip}}
R_{a}^{\text{noise}}
N=91650
N=120
N=80522
N=120722
H^{a}_{\ell}g_{B}
\text{Tr}(H_{\ell}^{a})=\sum_{i=1}^{N}I_{i}^{T}H_{\ell}^{a}I_{i}
I_{i}
i
N
a\in K
\text{Tr}(H_{\ell}^{a})=\mathbb{E}_{z}[z^{T}H_{\ell}^{a}z]
z
n
n
n=100
g_{D}
g_{D_{a}}
R_{a}^{\text{clip}}
R_{a}^{\text{noise}}
g_{D}
g_{D_{a}}
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
\|\bar{g}_{B}\|=\|g_{B}\|
g_{B}
\bar{g}_{B}
g_{B}
\frac{\|g_{B}\|}{\|\bar{g}_{B}\|}\bar{g}_{B}
g_{B}
\frac{\|\bar{g}_{B}\|}{\|g_{B}\|}g_{B}
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{clip}}=R_{a}^{\text{mag}}+R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{dir}}
\|g_{i}\|>C_{0}
Z
C_{0}/Z
C_{0}
\bar{g}_{B}
Z
\|g_{i}\|
Z
Z
\max_{i}\|g_{i}\|
C_{0}
Z
\tau\cdot Z
\tau
\|g_{i}\|>C_{0}
(\epsilon,\delta)
T
D
q
C_{0}
\sigma_{1},\sigma_{2}
\eta_{t}
\theta_{0}
t\text{ in }0,\dots,T-1
B\leftarrow\text{Poisson sample of }D\text{ with rate }q
(x_{i},a_{i},y_{i})\text{ in }B
g_{i}\leftarrow\nabla_{\theta}\ell(f_{\theta_{t}}(x_{i}),y_{i})
k\text{ in }[K]
m^{k}\leftarrow\left|\left\{i:\|g_{i}^{k}\|>C_{0}\right\}\right|
o^{k}\leftarrow\left|\left\{i:\|g_{i}^{k}\|\leq C_{0}\right\}\right|
\left\{\tilde{m}^{k},\tilde{o}^{k}\right\}_{k\in[K]}\leftarrow\left\{m^{k},o^{%
k}\right\}_{k\in[K]}+\mathcal{N}(0,\sigma_{1}^{2}\mathbb{I})
\left\{\tilde{m}^{k},\tilde{o}^{k}\right\}_{k\in[K]}\leftarrow\left\{\max(%
\lfloor\tilde{m}^{k}\rfloor,0),\max(\lfloor\tilde{o}^{k}\rfloor,0)\right\}_{k%
\in[K]}
\tilde{m}=\sum_{k\in[K]}\tilde{m}^{k}
k\text{ in }[K]
\tilde{b}^{k}=\tilde{m}^{k}+\tilde{o}^{k}
C_{k}=C_{0}\cdot\left(1+\frac{\tilde{m}^{k}/\tilde{b}^{k}}{\tilde{m}/|B|}\right)
(x_{i},a_{i},y_{i})\text{ in }B
\bar{g}_{i}\leftarrow g_{i}\cdot\min\left(1,\frac{C_{k}}{\|g_{i}\|}\right)
k=a_{i}
\tilde{g}_{B}\leftarrow\frac{1}{|B|}\left(\sum_{i\in B}\bar{g}_{i}+\mathcal{N}%
(0,\sigma_{2}^{2}C_{0}^{2}\mathbb{I})\right)
\theta_{t+1}\leftarrow\theta_{t}-\eta_{t}\tilde{g}_{B}
R_{a}^{\text{clip}}
R_{a}^{\text{noise}}
R^{\text{noise}}
\ell
a
b
{\eta_{t}}^{-1}
{\eta_{t}}^{-1}
R_{a}^{\text{dir}}\!-\!R_{b}^{\text{dir}}
\tanh
T
D
q
C_{0}
\sigma
\eta_{t}
\gamma_{1}
\gamma_{2}
\theta_{0}
t\text{ in }0,\dots,T-1
B\leftarrow\text{Poisson sample of }D\text{ with rate }q
(x_{i},a_{i},y_{i})\text{ in }B
g_{i}\leftarrow\nabla_{\theta}\ell(f_{\theta_{t}}(x_{i}),y_{i})
\bar{g}_{i}\leftarrow g_{i}\cdot\min\left(1,\frac{C_{0}}{\|g_{i}\|}\right)
g_{B}\leftarrow\frac{1}{|B|}\sum_{i\in B}g_{i}
\bar{g}_{B}\leftarrow\frac{1}{|B|}\sum_{i\in B}\bar{g}_{i}
k\text{ in }\{a,b\}
g_{B_{k}}\leftarrow\frac{1}{|B_{k}|}\sum_{i\in B,a_{i}=k}g_{i}
f_{k}\leftarrow\frac{1}{|B_{k}|}\sum_{i\in B,a_{i}=k}f_{\theta_{t}}(x_{i})
R_{1}=|\langle g_{B_{a}}-g_{B_{b}},\bar{g}_{B}-g_{B}\rangle|
R_{2}=\frac{1}{2}(f_{a}\cdot(1-f_{a})+f_{b}\cdot(1-f_{b}))
\mathcal{L}=\ell(f_{\theta_{t}}(x_{i}),y_{i})+\gamma_{1}R_{1}+\gamma_{2}R_{2}
(x_{i},a_{i},y_{i})\text{ in }B
{g^{\prime}}_{i}\leftarrow\nabla_{\theta}\mathcal{L}(f_{\theta_{t}}(x_{i}),y_{%
i})
{\bar{g}^{\prime}}_{i}\leftarrow{g^{\prime}}_{i}\cdot\min\left(1,\frac{C_{0}}{%
\|{g^{\prime}}_{i}\|}\right)
{\tilde{g}^{\prime}}_{B}\leftarrow\frac{1}{|B|}\left(\sum_{i\in B}{\bar{g}^{%
\prime}}_{i}+\mathcal{N}(0,\sigma^{2}C_{0}^{2}\mathbb{I})\right)
\theta_{t+1}\leftarrow\theta_{t}-\eta_{t}{\tilde{g}^{\prime}}_{B}
\pi_{\textsc{M}}
\pi_{\textsc{F}}
\pi_{\textsc{M},\textsc{F}}
R_{\textsc{M}}
R_{\textsc{F}}
R_{\textsc{M},\textsc{F}}
80.5
\pm 0.4
92.2
\pm 0.1
0.40
\pm 0.00
0.19
\pm 0.00
69.9
\pm 0.4
88.5
\pm 0.1
10.6
\pm 0.3
3.6
\pm 0.1
6.9
\pm 0.3
0.78
\pm 0.01
0.40
\pm 0.01
0.39
\pm 0.00
0.21
\pm 0.01
0.17
\pm 0.01
68.8
\pm 0.4
88.5
\pm 0.1
11.7
\pm 0.2
3.7
\pm 0.1
7.9
\pm 0.2
0.57
\pm 0.00
0.42
\pm 0.00
0.18
\pm 0.00
0.23
\pm 0.00
0.05
\pm 0.00
78.0
\pm 0.6
89.4
\pm 0.1
2.5
\pm 0.3
2.7
\pm 0.1
0.2
\pm 0.3
0.49
\pm 0.00
0.31
\pm 0.01
0.09
\pm 0.00
0.12
\pm 0.00
0.02
\pm 0.01
78.5
\pm 0.5
89.9
\pm 0.1
2.0
\pm 0.2
2.2
\pm 0.1
0.2
\pm 0.2
0.43
\pm 0.00
0.25
\pm 0.00
0.04
\pm 0.00
0.05
\pm 0.00
0.02
\pm 0.00
80.7
\pm 0.4
92.3
\pm 0.1
-0.1
\pm 0.1
-0.1
\pm 0.1
0.0
\pm 0.1
0.39
\pm 0.00
0.18
\pm 0.00
0.00
\pm 0.00
0.00
\pm 0.00
0.00
\pm 0.00
\pi_{\textsc{M}}
\pi_{\textsc{F}}
\pi_{\textsc{M},\textsc{F}}
R_{\textsc{M}}
R_{\textsc{F}}
R_{\textsc{M},\textsc{F}}
79.9
\pm 0.2
86.9
\pm 0.0
0.499
\pm 0.000
0.447
\pm 0.000
76.0
\pm 0.2
86.4
\pm 0.1
3.8
\pm 0.3
0.4
\pm 0.0
3.4
\pm 0.4
0.520
\pm 0.001
0.450
\pm 0.001
0.021
\pm 0.001
0.003
\pm 0.001
0.018
\pm 0.002
78.6
\pm 0.3
86.9
\pm 0.1
1.3
\pm 0.2
-0.1
\pm 0.0
1.4
\pm 0.2
0.552
\pm 0.001
0.526
\pm 0.000
0.053
\pm 0.001
0.079
\pm 0.000
0.026
\pm 0.001
78.9
\pm 0.2
86.6
\pm 0.1
0.9
\pm 0.1
0.3
\pm 0.0
0.7
\pm 0.1
0.503
\pm 0.001
0.447
\pm 0.001
0.005
\pm 0.001
0.000
\pm 0.000
0.005
\pm 0.001
79.0
\pm 0.2
86.5
\pm 0.1
0.8
\pm 0.1
0.4
\pm 0.0
0.4
\pm 0.2
0.510
\pm 0.001
0.460
\pm 0.001
0.012
\pm 0.001
0.013
\pm 0.001
0.002
\pm 0.001
79.4
\pm 0.1
86.7
\pm 0.1
0.4
\pm 0.2
0.2
\pm 0.0
0.2
\pm 0.2
0.504
\pm 0.001
0.452
\pm 0.001
0.006
\pm 0.001
0.005
\pm 0.001
0.001
\pm 0.001
Z
\|g_{B}\|
\|g_{B}\|
\|g_{B}\|
\|g_{B}\|
\|g_{B}\|
\|g_{B}\|
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{dir}}
R_{a}^{\text{mag}}
R_{a}^{\text{noise}}=\tfrac{\eta_{t}^{2}}{2}\textup{Tr}(H^{a}_{\ell})C_{0}^{2}%
\sigma^{2}
\eta_{t}
\sigma
C_{0}
a
R_{k}^{\text{noise}}
