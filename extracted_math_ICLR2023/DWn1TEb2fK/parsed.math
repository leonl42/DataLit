n^{2}
n
-
\mathbf{30\times}
\mathbf{9\times}
{\bm{Q}},{\bm{K}},{\bm{V}}\in\mathbb{R}^{n\times d}
n
d
W^{Q},W^{K},W^{V}\in\mathbb{R}^{d\times d}
\text{Attention}({\bm{Q}},{\bm{K}},{\bm{V}})=\underbrace{\text{softmax}\bigg{[%
}\frac{{\bm{Q}}W^{Q}({\bm{K}}W^{K})^{T}}{\sqrt{d}}\bigg{]}}_{{\bm{A}}}\cdot{%
\bm{V}}W^{V}
{\bm{Q}},{\bm{K}},{\bm{V}}
{\bm{A}}
{\bm{V}}W^{V}
O(n^{2}d+d^{2}n)
cpqr
p\times q
q\times r
c(2n^{2}d+2d^{2}n)
n
{\bm{A}}
O(n^{2})
O(n^{1.5})
O(ns)
s
O(nk)
k
O(nr)
r
O(nh)
h
h
O(n^{2}d+n^{2})
O(knd+kn)
O(snd+sn)
O(rnd+n(r+d))
O(hnd+(2^{h+1}-1)d)
\mathcal{T}(\theta)
{\bm{h}}
2^{\bm{h}}
\theta_{\{l,j\}}
\{l,j\}
l\in\{0,1,\cdots,{\bm{h}}\}
j\in\{0,1,\cdots,2^{l}-1\}
l
{\bm{q}}
\textsc{sign}(f(\theta_{\{l,j\}};{\bm{q}}))
f_{\{l,j\}}({\bm{q}})=f(\theta_{\{l,j\}};{\bm{q}})=\langle{\bm{w}}_{\{l,j\}},{%
\bm{q}}\rangle+b_{\{l,j\}},
\theta_{\{l,j\}}=\{{\bm{w}}_{\{l,j\}};b_{\{l;j\}}\}
P_{\mathcal{T}}(l,{\bm{q}})
\mathcal{T}
{\bm{q}}
l
P_{\mathcal{T}}(h,{\bm{q}})
{\bm{q}}
S_{l,j}({\bm{K}})
{\bm{K}}
\{l,j\}
i\in S_{l,j}({\bm{K}})
j=P_{\mathcal{T}}(l,{\bm{k}}_{i})
{\bm{q}}_{i}
{\bm{A}}_{i}=\text{softmax}(\frac{1}{\sqrt{d}}{\bm{q}}_{i}^{T}W^{Q}(W^{K})^{T}%
{\bm{K}}^{T}){\bm{V}}W^{V}.
{\bm{q}}_{i}
{\bm{q}}_{i}
k
{\bm{q}}_{i}
{\bm{q}}
{\bm{q}}
\textsc{TF-Attention}({\bm{q}},{\bm{K}},{\bm{V}};\mathcal{T})=\text{softmax}%
\bigg{[}\frac{{\bm{q}}^{T}W^{Q}({\bm{K}}_{\bar{S}}W^{K})^{T}}{\sqrt{d}}\bigg{]%
}\cdot{\bm{V}}_{\bar{S}}W^{V},
\bar{S}=S_{h,P_{\mathcal{T}}(h,(W^{Q})^{T}{\bm{q}})}({\bm{K}}W^{K})
{\bm{K}}
P_{\mathcal{T}}(h,(W^{Q})^{T}{\bm{q}})
(W^{Q})^{T}{\bm{q}}
k
k
O(\frac{n^{2}d}{2^{h}})+2cd^{2}n\equiv O(nkd)+2cd^{2}n
k
O(log(\frac{n}{k}))
c
O(n^{2}d+d^{2}n)
\mathcal{T}
\textsc{TF-Attention}({\bm{Q}},{\bm{K}},{\bm{V}};\mathcal{T})=\text{Attention}%
({\bm{Q}},{\bm{K}},{\bm{V}})
k
k
h
l
b_{l}
l\in\{0,1,\cdots,h-1\}
\prod_{l=1}^{l=h-1}b_{l}
k
h=2
b=[100,10]
1000
{\bm{\nu}}_{l,j}
{\bm{\nu}}_{l,j}=\frac{1}{|S_{l,j}({\bm{K}}W^{K})|}\sum_{i\in S_{l,j}({\bm{K}}%
W^{K})}{\bm{V}}_{i}W^{V},
{l,j}
{\bm{\nu}}_{l,j}
\mathcal{T}
\theta
{\bm{q}}
\textsc{TC-Attention}({\bm{q}},{\bm{K}},{\bm{V}};\mathcal{T})=\sum_{l=0}^{h}%
\alpha_{l}\cdot{\bm{\nu}}_{\{l,P_{\mathcal{T}}(l,(W^{Q})^{T}{\bm{q}})\}}
\alpha_{l}
\alpha_{l}
cd^{2}n
O((2^{h+1}-1)d)
{\bm{Q}}
O(ndh)
O(n^{2}d+d^{2}n)
n
O(ndh+(2^{h+1}-1)d+d^{2}n)
h
\leq 10
n
h
L
j
L
{\bm{M}}_{\{j,\cdots,L\}}
{\bm{M}}_{\{j,\cdots,L\}}
{\bm{M}}_{\{i,\cdots,j,\cdots,L\}}
{\bm{M}}_{\{1,\cdots,L\}}
\{i,\cdots,j-1\}
M=M_{\{1,\cdots,L\}}(h_{s})
h_{s}
w
h_{f}
N
M_{\{1,\cdots,L\}}(h_{f})
i=1
\lceil\frac{L}{w}\rceil
\text{idx}=1+max(0,L-w\cdot i)
h=h_{s}+1
h_{f}
M_{\{\text{idx},\cdots,L\}}(h)
M
h-1
M_{\{\text{idx},\cdots,L\}}(h)
\frac{N}{\lceil\frac{L}{w}\rceil\cdot(h_{f}-h_{s})}
M=M_{\{\text{idx},\cdots,L\}}(h_{f})
k
\approx 1e6
k
\mathbf{>1\%}
\mathbf{1.3\%}
\leq 512
k
\mathbf{>1\%}
\mathbf{1.3\%}
\leq 512
k=128
k
k
\mathbf{33x}
k
\mathbf{3x}
\mathbf{33x}
k
\mathbf{3x}
k
\downarrow
\rightarrow
k
\#
327
37
3.7
561
2.5
8.2
1.5
592
h
512
512
12
12
12
12
768
768
1024
1024
0.1
0.1
0.1
0.1
10^{-4}
10^{-4}
8\times 16
8\times 16
128
16
16
48
3\times 10^{-5}
1\times 10^{-5}
2\times 10^{-5}
8\times 10^{-5}
4\times 4
4\times 2
4\times 2
2\times 2
h=2
h=10
h=6
h=6
2048
4096
8192
1024
6
6
6
6
\#
4
4
4
1
4
4
4
1
512
256
128
32
1024
1024
512
64
32
32
32
56
0.1
0.1
0.1
0.3
0.1
0.1
0.1
0.2
0.05
0.05
0.05
0.0005
\#
5000
20000
5000
35000
0.1
0.1
0.1
0.0
2\times 2
2\times 2
2\times 2
2\times 2
1,4,8,12
k=128
k
k
\leq 512
k
({\bm{w}}_{\{l,j\}};b_{\{l,j\}})
\mathcal{T}
\displaystyle{\bm{w}}_{\{l,j\}}=0\;\;\;\;\forall j=0,\cdots,2^{l}-1\;\;\;\;%
\forall l=0,\cdots,h
\displaystyle{\bm{w}}_{\{l,j\}}
\displaystyle=0\;\;\;\;\forall j=0,\cdots,2^{l}-1\;\;\;\;\forall l=0,\cdots,h
\displaystyle b_{\{l,j\}}=\epsilon,
\displaystyle b_{\{l,j\}}
\displaystyle=\epsilon,
\epsilon
\mathcal{T}_{0}
\mathcal{T}=\mathcal{T}_{0}
\textsc{TF-Attention}({\bm{Q}},{\bm{K}},{\bm{V}};\mathcal{T})=\text{Attention}%
({\bm{Q}},{\bm{K}},{\bm{V}})
