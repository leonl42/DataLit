18\%
8\%
\mathcal{M}=\langle\mathcal{S},\mathcal{A},p,P,R,\gamma\rangle
\mathcal{S}
\mathcal{A}
p(s_{1})
P(s_{t+1}|s_{t},a_{t})
R(s_{t},a_{t})
\gamma
t
s_{t}\in S
a_{t}\in\mathcal{A}
s_{t+1}\sim P(\cdot|s_{t},a_{t})
r_{t}=R(s_{t},a_{t})
\mathscr{T}_{\text{offline}}
\mathcal{T}
\tau
|\tau|
\tau
t
t
g_{t}=\scriptstyle\sum_{t^{\prime}=t}^{|\tau|}\textstyle r_{t^{\prime}}
g_{1}
r_{\tau}=\scriptstyle\sum_{t=1}^{|\tau|}\textstyle r_{t}
\tau=\left(g_{1},s_{1},a_{1},g_{2},s_{2},a_{2},\dots,g_{|\tau|},s_{|\tau|},a_{%
|\tau|}\right).
a_{t}
t
g_{t-K:t}
s_{t-K:t}
a_{t-K:t-1}
K
\mathcal{L}_{\text{DT}}(\theta)=\operatorname{\mathbb{E}}_{\tau\sim\mathcal{T}%
}\big{[}\textstyle\tfrac{1}{|\tau|}\sum_{t=1}^{|\tau|}\displaystyle\big{(}a_{t%
}-\pi_{\theta}(g_{t-K:t},s_{t-K:t},a_{t-K:t-1})\big{)}^{2}\big{]}.
s_{1}
g_{1}
t
a_{t}
r_{t}
s_{t+1}
g_{t+1}=g_{t}-r_{t}
a_{t+1}
\omega_{t}
\omega_{t}=\tfrac{1}{H-t+1}\textstyle\sum_{t^{\prime}=t}^{|\tau|}r_{t^{\prime}%
}=\tfrac{g_{t}}{H-t+1},
H
\omega_{t}
a_{t}
t
s_{t}
\omega_{t}
\mathcal{L}_{\text{RvS}}(\theta)=\operatorname{\mathbb{E}}_{\tau\sim\mathcal{T%
}}\big{[}\textstyle\tfrac{1}{|\tau|}\sum_{t=1}^{|\tau|}\displaystyle\big{(}a_{%
t}-\pi_{\theta}(s_{t},\omega_{t})\big{)}^{2}\big{]}.
\omega_{t+1}=(g_{t}-r_{t})/(H-t)
10
10
r_{\tau}
\tau
r^{\star}=\sup_{\tau}r_{\tau}
\mathcal{T}^{\star}
\mathcal{T}
\mathcal{T}^{\star}
\mathcal{T}
\widetilde{\mathcal{T}}
\mathcal{T}^{\star}
\widetilde{\mathcal{T}}
f_{\mathcal{T}}:\mathbb{R}\mapsto\mathbb{R}_{+}
r_{\tau}
\tau\sim\mathcal{T}
\widetilde{\mathcal{T}}
p_{\widetilde{\mathcal{T}}}
p_{\widetilde{\mathcal{T}}}(\tau)\ \propto\ \overbrace{\tfrac{f_{\mathcal{T}}(%
r_{\tau})}{f_{\mathcal{T}}(r_{\tau})+\lambda}\cdot\exp\big{(}-\tfrac{|r_{\tau}%
-r^{\star}|}{\kappa}\big{)}}^{\text{trajectory weight}},
\lambda,\kappa\in\mathbb{R}_{+}
\kappa
\lambda
(x,y)
\mathcal{T}
\widetilde{\mathcal{T}}
B=20
\lambda=0.01
\kappa=\widehat{r}^{\star}-\widehat{r}_{90}
\widehat{r}_{90}
90
\mathcal{T}
\widetilde{\mathcal{T}}
B=20
\lambda=0.01
\kappa=\widehat{r}^{\star}-\widehat{r}_{90}
\widehat{r}_{90}
90
\mathscr{T}_{\text{offline}}
p_{\widetilde{\mathcal{T}}}
\widetilde{\mathcal{T}}
\mathscr{T}_{\text{offline}}
B
r_{\tau}
b\in\left\{1,\ldots,B\right\}
b
|b|
b
\widebar{r}^{b}_{\tau}=1/|b|\sum_{\tau\in b}r_{\tau}
b
\widehat{r}^{\star}
\mathscr{T}_{\text{offline}}
f_{\mathscr{T}_{\text{offline}}}(b)=|b|/|\mathscr{T}_{\text{offline}}|
\operatorname{\mathbb{P}}_{\text{bin}}(b)\ \propto\ \tfrac{f_{\mathscr{T}_{%
\text{offline}}}(b)}{f_{\mathscr{T}_{\text{offline}}}(b)+\lambda}\cdot\exp\big%
{(}-\tfrac{|\widebar{r}^{b}_{\tau}-\widehat{r}^{\star}|}{\kappa}\big{)}.
\mathscr{T}_{\text{offline}}
B
\lambda,\kappa
r_{\tau}\leftarrow\sum_{t=1}^{|\tau|}r_{t},\;\forall\tau\in\mathscr{T}_{\text{%
offline}}
B
r_{\tau}
b\in[B]
\operatorname{\mathbb{P}}_{\text{bin}}(b)
\tau
b
\tau
\tau
\varepsilon\sim\mathcal{E}_{\tau}
\ell_{2}
\mathcal{E}
g_{1}+\varepsilon
\widehat{r}^{\star}
\widehat{r}_{q}
q
\varepsilon\sim\mathcal{E}_{\tau}
\tau
\varepsilon
g^{\varepsilon}_{t}=g_{t}+\varepsilon
t=1,\ldots,|\tau|
\mathcal{C}_{\text{RvS}}(\theta)=\operatorname{\mathbb{E}}_{\tau\sim\mathcal{T%
},\ \varepsilon\sim\mathcal{E}_{\tau}}\big{[}\mathbbm{1}_{r_{\tau}>\widehat{r}%
_{q}}\cdot\textstyle\tfrac{1}{|\tau|}\sum_{t=1}^{|\tau|}\displaystyle\big{(}a_%
{t}-\pi_{\theta}(s_{t},\omega^{\varepsilon}_{t})\big{)}^{2}\big{]},
\omega^{\varepsilon}_{t}=(g_{t}+\varepsilon)/(H-t+1)
t
95
\widehat{r}_{95}
\mathcal{E}_{\tau}=\text{Uniform}[l_{\tau},u_{\tau}]
l_{\tau}=\widehat{r}^{\star}-r_{\tau}
g^{\varepsilon}_{1}=r_{\tau}+\varepsilon
\widehat{r}^{\star}
u_{\tau}=\widehat{r}^{\star}-r_{\tau}+\sqrt{12\sigma^{2}}
\mathcal{E}_{\tau}
\sigma
\mathcal{L}_{\text{RvS}}(\theta)+\alpha\cdot\mathcal{C}_{\text{RvS}}(\theta)
\alpha
\mathscr{T}_{\text{offline}}
I
S
\alpha
\theta_{0}
i=1,\ldots,I
\mathcal{B}\leftarrow\{\tau^{(1)},\ldots,\tau^{(S)}\}
\mathscr{T}_{\text{offline}}
\tau^{(i)}
\varepsilon
g^{\varepsilon}_{t}\leftarrow g_{t}+\varepsilon
1\leq t\leq|\tau^{(i)}|
\theta
\widehat{\mathcal{L}}^{\mathcal{B}}_{\text{RvS}}(\theta)+\alpha\cdot\widehat{%
\mathcal{C}}^{\mathcal{B}}_{\text{RvS}}(\theta)
\pi_{\theta}
73.3\pm 5.7
73.6\pm 5.4
71.5\pm 3.9
70.4\pm 4.5
83.7
82.9
78.3
81.3\pm 8.0
54.0\pm 12.1
72.8\pm 7.5
53.4\pm 12.2
60.5\pm 8.9
81.8
86.1
73.9
79.4\pm 12.8
102.2\pm 2.3
107.6\pm 0.5
99.8\pm 21.3
108.2\pm 0.8
110.1
109.5
109.6
91.0\pm 10.8
56.6\pm 5.5
62.9\pm 3.6
59.9\pm 4.9
63.9\pm 4.4
59.3
64.6
66.3
67.4\pm 11.3
87.7\pm 9.7
87.7\pm 4.2
56.4\pm 20.1
76.9\pm 5.9
60.9
97.8
94.7
99.4\pm 12.6
108.8\pm 0.9
110.0\pm 2.8
95.4\pm 11.3
103.4\pm 9.0
98.0
102.0
91.5
106.0\pm 1.1
16.2\pm 4.5
42.2\pm 0.7
42.5\pm 0.6
41.6\pm 1.7
48.3
49.1
47.4
44.0\pm 1.2
-0.4\pm 2.7
40.4\pm 0.8
34.5\pm 4.2
36.9\pm 2.2
44.6
47.3
44.2
44.1\pm 3.5
83.4\pm 2.1
91.1\pm 2.0
87.2\pm 2.7
85.6\pm 2.0
90.7
85.8
86.7
40.8\pm 8.7
8
6
64.6
76.5
66.7
71.9
75.3
80.6
77.0
72.6
1
\frac{1}{3}
1
1
B=20
\lambda=0.01
\kappa
90
\widehat{r}^{\star}-\widehat{r}_{90}
q=95
\alpha=1
\lambda
\kappa
6/9
8\%
8/9
18\%
0.8\times
1.0\times
1.0\times
2.0\times
0.8\times
1.0\times
\ell_{2}
Q
Q
\mathcal{S}
\mathcal{A}
\tau
|\tau|
\mathcal{T}
\mathscr{T}_{\text{offline}}
\pi
\theta
s_{t}
t
a_{t}
t
r_{t}
t
r_{\tau}
\sum_{t=1}^{|\tau|}r_{t}
g_{t}
t
\sum_{t^{\prime}=t}^{|\tau|}r_{t}^{\prime}
H
\omega_{t}
t
g_{t}/(H-t+1)
\mathcal{L}_{\text{RvS}}
\mathcal{C}_{\text{RvS}}
f_{\mathcal{T}}(\tau)
\tau\sim\mathcal{T}
p_{\widetilde{\mathcal{T}}}(\tau)
\tau\sim\widetilde{\mathcal{T}}
b
|b|
b
f_{\mathscr{T}_{\text{offline}}}(b)
b
|b|/|\mathscr{T}_{\text{offline}}|
\operatorname{\mathbb{P}}_{\text{bin}}(b)
b
\bar{r}^{b}_{\tau}
b
\widehat{r}^{\star}
\widehat{r}_{q}
q
K
20
1
2
3
1024
128
0.0
0.1
q
95
\sigma
1000
\alpha
1.0
B
20
\lambda
0.01
\kappa
\widehat{r}^{\star}-\widehat{r}_{90}
64
1e-3
1e-4
1e-4
100000
1\times
32
32
64
8\times 8
4\times 4
3\times 3
4
2
1
4
1024
0.1
q
95
\sigma
50
500
\alpha
0.1
B
20
\lambda
0.1
\kappa
\widehat{r}^{\star}-\widehat{r}_{50}
128
6e-4
1e-4
25000
90
1\times
2500
5\times
20
1\times
1450
5\times
\lambda
\kappa
\kappa
\lambda
b
\operatorname{\mathbb{P}}_{\text{bin}}(b)\ \propto\ \tfrac{f_{\mathscr{T}_{%
\text{offline}}}(b)}{f_{\mathscr{T}_{\text{offline}}}(b)+\lambda}\cdot\exp\big%
{(}-\tfrac{|\widebar{r}^{b}_{\tau}-\widehat{r}^{\star}|}{\kappa}\big{)}.
\kappa
\lambda
\kappa
\kappa
\kappa
\kappa
\kappa
\kappa
\widehat{r}^{\star}
z
\kappa=\widehat{r}^{\star}-\widehat{r}_{z}
z
\kappa
\kappa
z\in\{99,90,50,0\}
\kappa
\kappa
\widehat{r}_{0}
\widehat{r}_{0}=\min_{\tau\in\mathscr{T}_{\text{offline}}}r_{\tau}
\kappa
\kappa
\kappa
\kappa
\widehat{r}_{99}
\widehat{r}_{90}
\widehat{r}_{50}
\widehat{r}_{0}
\kappa
\kappa
\kappa
\kappa
\lambda
\lambda
\operatorname{\mathbb{P}}_{\text{bin}}(b)\ \propto\ \overbrace{f_{\mathscr{T}_%
{\text{offline}}}(b)\exp\big{(}-\tfrac{|\widebar{r}^{b}_{\tau}-\widehat{r}^{%
\star}|}{\kappa}\big{)}}^{\text{T1}}\cdot\overbrace{\left\{1/\big{(}f_{%
\mathscr{T}_{\text{offline}}}(b)+\lambda\big{)}\right\}}^{\text{T2}}.
\lambda
\lambda=0
\operatorname{\mathbb{P}}_{\text{bin}}(b)\ \propto\ \exp\big{(}-\tfrac{|%
\widebar{r}^{b}_{\tau}-\widehat{r}^{\star}|}{\kappa}\big{)},
\lambda
f_{\mathscr{T}_{\text{offline}}}(b)
b\in[B]
\lambda\rightarrow\infty
\operatorname{\mathbb{P}}_{\text{bin}}(b)
f_{\mathscr{T}_{\text{offline}}}(b)
\lambda
\lambda=0
\lambda
\lambda
\lambda
\lambda
\lambda
q
q
q
q
0,50,95
99
q=0
q
q=95
q=99
q=50
q=0
q
q
q
\alpha
\alpha
\mathcal{L}_{\text{RvS}}+\alpha\cdot\mathcal{C}_{\text{RvS}}
\alpha
\alpha=0
\alpha=10
\alpha
\alpha
\alpha
4
500000
50
B=20
\lambda=0.1
\kappa=\widehat{r}^{\star}-\widehat{r}_{50}
\alpha=0.1
\widehat{r}_{95}
5\times\widehat{r}^{\star}
1\times\widehat{r}^{\star}
3
3
126.9\pm 38.0
120.1\pm 28.43
163.0\pm 50.4
237.3\pm 82.1
267.5\pm 97.5
211.1
138.9\pm 61.7
-0.4\pm 0.2
0.0\pm 0.4
12.4\pm 8.6
19.1\pm 2.7
15.4\pm 11.4
104.2
17.3\pm 14.7
75.7\pm 8.6
90.7\pm 6.4
84.1\pm 9.6
90.4\pm 1.9
106.1\pm 8.1
111.9
85.2\pm 20.0
0.2\pm 0.2
-0.1\pm 0.1
1.6\pm 0.2
1.4\pm 0.3
2.5\pm 0.4
1.7
2.1\pm 0.3
1
4
4
50.6
52.7
62.3
87.1
97.9
107.2
60.9
72\%
3
3
3
3
54.0\pm 13.56
65.0\pm 18.03
58.0\pm 8.72
65.0\pm 12.85
65.6
44.8
54.6
55.0\pm 15.65
46.0\pm 16.85
50.0\pm 10.95
42.0\pm 7.48
51.2
23.4
45.6
0.0\pm 0.0
26.0\pm 12.0
0.0\pm 0.0
25.0\pm 13.6
1.0
0.0
0.0
1.0\pm 3.0
24.0\pm 15.62
1.0\pm 3.0
23.0\pm 11.0
0.6
0.0
0.0
0.0\pm 0.0
4.0\pm 4.9
0.0\pm 0.0
5.0\pm 6.71
0.0
0.0
0.0
0.0\pm 0.0
10.0\pm 10.0
0.0\pm 0.0
17.0\pm 11.87
0.2
0.0
0.0
4
1
4
18.3
29.2
18.2
29.5
19.8
11.4
16.7
60\%
10\%
73.3\pm 5.7
54.5\pm 7.7
71.3\pm 4.9
73.6\pm 5.4
60.9\pm 4.9
68.2\pm 7.1
54.0\pm 12.1
61.2\pm 14.7
62.0\pm 13.5
72.8\pm 7.5
47.1\pm 7.7
53.9\pm 11.0
102.2\pm 2.3
104.1\pm 0.5
102.1\pm 10.2
107.6\pm 0.5
101.7\pm 3.3
105.4\pm 0.6
56.6\pm 5.5
62.5\pm 7.1
61.0\pm 5.3
62.9\pm 3.6
62.4\pm 5.0
65.7\pm 6.4
87.7\pm 9.7
92.4\pm 6.1
91.5\pm 3.5
87.7\pm 4.2
91.2\pm 5.3
92.1\pm 2.9
108.8\pm 0.9
108.4\pm 1.8
101.0\pm 13.4
110.0\pm 2.8
97.5\pm 15.0
105.8\pm 3.5
16.2\pm 4.5
4.0\pm 5.4
40.7\pm 1.0
42.2\pm 0.7
1.4\pm 3.3
36.2\pm 2.5
-0.4\pm 2.7
-0.8\pm 2.2
36.8\pm 1.5
40.4\pm 0.8
-0.1\pm 3.5
35.7\pm 2.8
83.4\pm 2.1
69.1\pm 3.7
91.2\pm 1.0
91.1\pm 2.0
46.0\pm 1.5
83.2\pm 5.0
4
6
9
3
5
64.6
61.7
73.1
76.5
56.5
71.8
12\%
90\%
75.0
73.3\pm 5.7
73.6\pm 5.4
56.9
56.6\pm 5.5
62.9\pm 3.6
42.5
16.2\pm 4.5
42.2\pm 0.7
58.1
48.7
59.6
62.5
54.0\pm 12.1
72.8\pm 7.5
75.9
87.7\pm 9.7
87.7\pm 5.2
40.6
-0.4\pm 2.7
40.4\pm 0.8
59.7
47.1
67.0
109.0
102.2\pm 2.3
107.6\pm 0.5
110.9
108.8\pm 0.9
110.0\pm 2.8
92.9\pm
83.4\pm 2.1
91.1\pm 2.0
104.3
98.1
102.9
74.0
64.6
76.5
\displaystyle\min_{\theta}\mathcal{L}_{p_{\mathcal{D}}}(\theta)=\mathbb{E}_{%
\tau\sim\mathcal{T}}\left[D(\tau,\pi_{\theta})\right]
\displaystyle\min_{\theta}\mathcal{L}_{p_{\mathcal{D}}}(\theta)
\displaystyle=\mathbb{E}_{\tau\sim\mathcal{T}}\left[D(\tau,\pi_{\theta})\right]
\displaystyle=\mathbb{E}_{r\sim p_{\mathcal{D}}(r),\tau\sim\mathcal{T}_{r}}%
\left[D(\tau,\pi_{\theta})\right].
\displaystyle=\mathbb{E}_{r\sim p_{\mathcal{D}}(r),\tau\sim\mathcal{T}_{r}}%
\left[D(\tau,\pi_{\theta})\right].
p_{\mathcal{D}}(r)
\mathcal{T}_{r}
r
D(\tau,\pi_{\theta})
\tau
D(\tau,\pi_{\theta})=\textstyle\tfrac{1}{|\tau|}\sum_{t=1}^{|\tau|}%
\displaystyle\big{(}a_{t}-\pi_{\theta}(g_{t-K:t},s_{t-K:t},a_{t-K:t-1})\big{)}%
^{2}
D(\tau,\pi_{\theta})=\textstyle\tfrac{1}{|\tau|}\sum_{t=1}^{|\tau|}%
\displaystyle\big{(}a_{t}-\pi_{\theta}(s_{t},\omega_{t})\big{)}^{2}
r
\tau
r
\tau
p^{\star}(r)
r^{\star}
\min_{\theta}\mathcal{L}_{p^{\star}}(\theta)=\mathbb{E}_{r\sim p^{\star}(r),%
\tau\sim\mathcal{T}_{r}}\left[D(\tau,\pi_{\theta})\right].
p_{\mathcal{D}}(r)
p^{\star}(r)
p_{\mathcal{D}}(r)
q(r)
p^{\star}(r)
q
\displaystyle\min_{\theta}\mathcal{L}_{q}(\theta)=\mathbb{E}_{r\sim q(r),\tau%
\sim\mathcal{T}_{r}}\left[D(\tau,\pi_{\theta})\right]
\displaystyle\min_{\theta}\mathcal{L}_{q}(\theta)
\displaystyle=\mathbb{E}_{r\sim q(r),\tau\sim\mathcal{T}_{r}}\left[D(\tau,\pi_%
{\theta})\right]
\displaystyle=\mathbb{E}_{r\sim p_{\mathcal{D}}(r),\tau\sim\mathcal{T}_{r}}%
\left[\frac{q(r)}{p_{\mathcal{D}}(r)}\cdot D(\tau,\pi_{\theta})\right]
\displaystyle=\mathbb{E}_{r\sim p_{\mathcal{D}}(r),\tau\sim\mathcal{T}_{r}}%
\left[\frac{q(r)}{p_{\mathcal{D}}(r)}\cdot D(\tau,\pi_{\theta})\right]
q(r)=\mathbbm{1}[r=r^{\star}]
r^{\star}
q
q
\ell_{2}
\mathcal{L}_{q}(\theta)
\mathcal{L}_{p^{\star}}(\theta)
C_{1},C_{2},C_{3}
\mathbb{E}\left[||\nabla_{\theta}\mathcal{L}_{q}(\theta)-\nabla_{\theta}%
\mathcal{L}_{p^{\star}}(\theta)||_{2}^{2}\right]\leq C_{1}\cdot\mathbb{E}_{r%
\sim q(r)}\left[\frac{1}{N_{r}}\right]+C_{2}\cdot\frac{d_{2}(q||p_{\mathcal{D}%
})}{|\mathcal{D}|}+C_{3}\cdot D_{\text{TV}}(p^{\star},q)^{2}.
N_{r}
\mathcal{D}
r
d_{2}
D_{\text{TV}}
q
p_{\mathcal{D}}
p^{\star}
q(r)\propto\frac{N_{r}}{N_{r}+K}\cdot\exp(-\frac{|r-r^{\star}|}{\kappa})
