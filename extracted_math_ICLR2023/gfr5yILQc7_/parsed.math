B
N
C
n
n
S_{i}
i
\mathbf{X}
s_{i}
S_{i}
\mathbf{X}_{p,n}
n
\hat{s}
M
\mathrm{MHA}(x)=\mathrm{Concat}(\mathrm{head}_{1},\dots,\mathrm{head}_{H})%
\mathbf{W}^{O},\quad\mathrm{head}_{i}=\mathrm{Att}(\mathbf{Q}_{i},\mathbf{K}_{%
i},\mathbf{V}_{i}),
\mathrm{Att}(\mathbf{Q},\mathbf{K},\mathbf{V})=\mathrm{softmax}\left(\frac{%
\mathbf{Q}\mathbf{K}^{\top}}{\sqrt{d_{k}}}\right)\mathbf{V},\quad x_{\mathrm{%
MHA}}=\mathrm{LayerNorm}(x+\mathrm{MHA}(x)),
\mathrm{Att}(\cdot)
\mathbf{Q},\mathbf{K},\mathbf{V}
x_{\mathrm{MHA}}
\mathrm{FFN}(x)=\max(0,x\mathbf{W}_{1}+\mathbf{b}_{1})\mathbf{W}_{2}+\mathbf{b%
}_{2},\quad x_{\mathrm{out}}=\mathrm{LayerNorm}(x_{\mathrm{MHA}}+\mathrm{FFN}(%
x_{\mathrm{MHA}})),
\mathbf{W}_{1},\mathbf{W}_{2},\mathbf{b}_{1},\mathbf{b}_{2}
\mathbf{X}\in\mathbb{R}^{[B,S_{1},S_{2},\dots,S_{K},C]}
B
S_{1},S_{2},\dots,S_{K}
K
C
\mathbf{X}_{\mathrm{reshape}}=\mathrm{Reshape}(\mathbf{X},[B\times\prod_{j\neq
i%
}S_{j},S_{i},C]).
i
\mathbf{X}_{\mathrm{reshape}}
\mathbf{X}_{\mathrm{out}}=\mathrm{transformer\_block}(\mathbf{X}_{\mathrm{%
reshape}}).
N
\mathbf{X}_{\mathrm{out}}
\mathbf{X}
\mathbf{X}\in\mathbb{R}^{[B,S_{1},S_{2},\dots,S_{K},C]}
N
S_{1},\dots,S_{K}
K
\mathbf{X}_{p,n}
\mathbf{X}
n
p
\min_{p}\sum_{n=1}^{N}\mathrm{CommCost}(\mathbf{X}_{p,n})\ \ s.t.\ \ \mathrm{%
Memory}(\mathbf{X}_{p,n})<Capacity.
\mathrm{Memory}(\mathbf{X}{p,n})
\mathbf{X}_{p,n}
n
\mathrm{CommCost}(\mathbf{X}_{p,n})
s_{i}
i
\hat{s}
M
N
s_{i}
i
\hat{s}
M
N
s_{i}
s_{i}
s_{i}
s_{j}
M/N
\hat{s}
s_{i}
0
s_{i}
\hat{s}
M
\mathbf{X}\in\mathbb{R}^{[B,S_{1},\dots,S_{i}/N,\dots,S_{j},\dots,S_{K},C]}
i
S_{i}/N
N
i
j
\mathbf{Y}=\text{DynamicSwitch}(\mathbf{X},i,j),
\mathbf{Y}
\mathbb{R}^{[B,S_{1},\dots,S_{i},\dots,S_{j}/N,\dots,S_{K},C]}
M
N
8M
M
N
4M/N
2M
2M/N
M
N
M
N
2M
8M
4M/N
2M/N
t
s
x
8M
M
N
4M/N
2M
2M/N
shard
shard
dsp\_dataloader
split
gather
dynamic\_switch
dynamic\_switch
split
gather
dsp\_dataloader
