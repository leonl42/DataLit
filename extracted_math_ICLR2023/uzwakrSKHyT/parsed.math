x=[x_{1},\dots,x_{n}]
q
z
\{1,\ldots,n\}
c
z\sim p(z\,|\,x,q)
p
x
q
c=\mathbb{E}_{z\sim p(z\,|\,x,q)}[f(x,z)]
f(x,z)
[\mathbf{x}_{1},\ldots,\mathbf{x}_{n}]
\mathbf{q}
q
z
p
p(z=i\,|\,x,q)=\operatorname{softmax}(\theta_{i})
\theta\in\mathbb{R}^{n}
\theta_{i}=\operatorname{MLP}([\mathbf{x}_{i};\mathbf{q}])
f(\mathbf{x},z)=\mathbf{x}_{z}
\mathbf{c}=\mathbb{E}_{z\sim p(z\,|\,x,q)}[f(x,z)]=\sum_{i=1}^{n}p(z=i\,|\,x,q%
)\mathbf{x}_{i}
[x_{1},\ldots,x_{n}]
q
f(x,z)
z\sim p
p
x
q
z
[z_{1},\ldots,z_{m}]
p(z\,|\,x,q)
z
m
\theta_{C}(z_{C})\in\mathbb{R}
z_{C}
z
C
p(z\,|\,x,q;\theta)=\operatorname{softmax}(\sum_{C}\theta_{C}(z_{C}))
\operatorname{softmax}
\operatorname{softmax}(g(z))=\frac{1}{Z}\exp(g(z))
Z=\sum_{z^{\prime}}\exp(g(z^{\prime}))
\theta
x,q
f
f(x,z)=\sum_{C}f_{C}(x,z_{C})
c=\mathbb{E}_{z\sim p(z\,|\,x,q)}[f(x,z)]=\sum_{C}\mathbb{E}_{z\sim p(z_{C}\,|%
\,x,q)}[f_{C}(x,z_{C})]
q
z_{1}
x_{1}
x_{2}
x_{3}
x_{4}
q
z_{1}
z_{2}
z_{3}
z_{4}
x_{1}
x_{2}
x_{3}
x_{4}
q
z_{1}
z_{2}
z_{3}
z_{4}
x_{1}
x_{2}
x_{3}
x_{4}
x
q
x
q
m=n
z
z=[z_{1},\dots,z_{n}]
z_{i}\in\{0,1\}
f(x,z)=\sum_{i=1}^{n}f_{i}(x,z_{i})
f_{i}(x,z_{i})=\mathbbm{1}\{z_{i}=1\}\mathbf{x}_{i}
\mathbb{E}_{z_{1},\dots,z_{n}}[f(x,z)]=\sum_{i=1}^{n}p(z_{i}=1\,|\,x,q)\mathbf%
{x}_{i}
[0,1]
z_{i}
z
\displaystyle p(z_{1},\dots,z_{n}\,|\,x,q)=\operatorname{softmax}\left(\sum_{i%
=1}^{n-1}\theta_{i,i+1}(z_{i},z_{i+1})\right)
\displaystyle p(z_{1},\dots,z_{n}\,|\,x,q)=\operatorname{softmax}\left(\sum_{i%
=1}^{n-1}\theta_{i,i+1}(z_{i},z_{i+1})\right)
\theta_{k,l}
z_{i}=k
z_{i+1}=l
p(z_{i}=1\,|\,x,q)=\operatorname{sigmoid}(\theta_{i})
x
q
p(z_{i}=1\,|\,x)
i
n
z_{ij}\in\{0,1\}
i\neq j
i
j
x_{i}\rightarrow x_{j}
z_{ij}
\theta_{ij}
x_{i}
x_{j}
z
x=[x_{1},\ldots,x_{n}]
p(z\,|\,x,q)=\operatorname{softmax}\left(\mathbbm{1}\{z\ \text{is valid}\}\sum%
_{i\neq j}\mathbbm{1}\{z_{ij}=1\}\theta_{ij}\right)
z
z_{ij}
i\neq j
p(z_{ij}=1\,|\,x,q)
i,j
O(n^{3})
\sum_{i=1}^{n}z_{ij}=1
j
\displaystyle f_{j}(x,z)=\sum_{i=1}^{n}\mathbbm{1}\{z_{ij}=1\}\mathbf{x}_{i}%
\mathbf{c}_{j}=\mathbb{E}_{z}[f_{j}(x,z)]=\sum_{i=1}^{n}p(z_{ij}=1\,|\,x,q)%
\mathbf{x}_{i}
\displaystyle f_{j}(x,z)=\sum_{i=1}^{n}\mathbbm{1}\{z_{ij}=1\}\mathbf{x}_{i}
\displaystyle\mathbf{c}_{j}=\mathbb{E}_{z}[f_{j}(x,z)]=\sum_{i=1}^{n}p(z_{ij}=%
1\,|\,x,q)\mathbf{x}_{i}
j
\theta
\alpha[0,\langle t\rangle]\leftarrow 0
\beta[n+1,\langle t\rangle]\leftarrow 0
i=1,\dots,n;c\in\mathcal{C}
\alpha[i,c]\leftarrow\bigoplus_{y}\alpha[i-1,y]\otimes\theta_{i-1,i}(y,c)
i=n,\dots,1;c\in\mathcal{C}
\beta[i,c]\leftarrow\bigoplus_{y}\beta[i+1,y]\otimes\theta_{i,i+1}(c,y)
A\leftarrow\alpha[n+1,\langle t\rangle]
i=1,\dots,n;c\in\mathcal{C}
p(z_{i}=c\,|\,x)\leftarrow\exp(\alpha[i,c]\otimes\beta[i,c]
\otimes-A)
p
\theta,p,\nabla^{\mathcal{L}}_{p}
\nabla^{\mathcal{L}}_{\alpha}\leftarrow\log p\otimes\log\nabla_{p}^{\mathcal{L%
}}\otimes\beta\otimes-A
\nabla^{\mathcal{L}}_{\beta}\leftarrow\log p\otimes\log\nabla_{p}^{\mathcal{L}%
}\otimes\alpha\otimes-A
\hat{\alpha}[0,\langle t\rangle]\leftarrow 0
\hat{\beta}[n+1,\langle t\rangle]\leftarrow 0
i=n,\dots 1;c\in\mathcal{C}
\hat{\beta}[i,c]\leftarrow\nabla^{\mathcal{L}}_{\alpha}[i,c]\oplus\bigoplus_{y%
}\theta_{i,i+1}(c,y)\otimes\hat{\beta}[i+1,y]
i=1,\dots,n;c\in\mathcal{C}
\hat{\alpha}[i,c]\leftarrow\nabla^{\mathcal{L}}_{\beta}[i,c]\oplus\bigoplus_{y%
}\theta_{i-1,i}(y,c)\otimes\hat{\alpha}[i-1,y]
i=1,\dots,n;y,c\in\mathcal{C}
\nabla^{\mathcal{L}}_{\theta_{i-1,i}(y,c)}\leftarrow\operatorname{signexp}(%
\hat{\alpha}[i,y]\otimes\beta[i+1,c]
\oplus\>\alpha[i,y]\otimes\hat{\beta}[i+1,c]
\oplus\>\alpha[i,y]\otimes\beta[i+1,c]\otimes-A)
\nabla^{\mathcal{L}}_{\theta}
\alpha
\beta
p
\theta
\nabla_{p}^{\cal L}
\mathcal{C}
\langle t\rangle
\nabla_{\log p}^{\mathcal{L}}=p\odot\nabla_{p}^{\mathcal{L}}
\nabla^{\mathcal{L}}_{\theta}=\nabla_{\log p}^{\mathcal{L}}\nabla^{\log p}_{\theta}
\odot
\mathbb{R}\cup\{\pm\infty\}
\oplus=\operatorname{logadd}
\otimes=+
\nabla_{p}^{\mathcal{L}}
\left[\mathbb{R}\cup\{\pm\infty\}\right]\times\{+,-\}
+
-
\operatorname{signexp}
\operatorname{signexp}(l_{a})=s_{a}\exp(l_{a})
\alpha
\beta
p
\theta
\nabla_{p}^{\cal L}
\mathcal{C}
\langle t\rangle
\nabla_{\log p}^{\mathcal{L}}=p\odot\nabla_{p}^{\mathcal{L}}
\nabla^{\mathcal{L}}_{\theta}=\nabla_{\log p}^{\mathcal{L}}\nabla^{\log p}_{\theta}
\odot
\mathbb{R}\cup\{\pm\infty\}
\oplus=\operatorname{logadd}
\otimes=+
\nabla_{p}^{\mathcal{L}}
\left[\mathbb{R}\cup\{\pm\infty\}\right]\times\{+,-\}
+
-
\operatorname{signexp}
\operatorname{signexp}(l_{a})=s_{a}\exp(l_{a})
p(z_{i}=1\,|\,x,q;\theta)
\theta
\mathcal{L}
\theta
\nabla_{\theta}^{\mathcal{L}}
\nabla_{p}^{\mathcal{L}}
\nabla^{a}_{b}
a
b
\oplus
\otimes
s_{a}
s_{b}
l_{a+b}
s_{a+b}
l_{a\cdot b}
s_{a\cdot b}
+
+
l_{a}+\log(1+d)
+
l_{a}+l_{b}
+
+
-
l_{a}+\log(1-d)
+
l_{a}+l_{b}
-
-
+
l_{a}+\log(1-d)
-
l_{a}+l_{b}
-
-
-
l_{a}+\log(1+d)
-
l_{a}+l_{b}
+
a
(l_{a},s_{a})
l_{a}=\log|a|
s_{a}=\operatorname{sign}(a)
a=s_{a}\exp(l_{a})
d=\exp(l_{b}-l_{a})
|a|>|b|
a
(l_{a},s_{a})
l_{a}=\log|a|
s_{a}=\operatorname{sign}(a)
a=s_{a}\exp(l_{a})
d=\exp(l_{b}-l_{a})
|a|>|b|
\mathbb{R}\cup\{\pm\infty\}
(\oplus=\operatorname{logadd},\otimes=+)
\nabla_{p}^{\mathcal{L}}
\left[\mathbb{R}\cup\{\pm\infty\}\right]\times\{+,-\}
+
-
n
n
\displaystyle(\,\,\,*\,\,\,(\,\,\,+\,\,\,(\,\,\,+\,\,\,15\,\,\,7\,\,\,)\,\,\,1%
\,\,\,8\,\,\,)\,\,\,(\,\,\,+\,\,\,19\,\,\,0\,\,\,11\,\,\,)\,\,\,)\,\,%
\Rightarrow(\,\,(\,\,15\,\,+\,\,7\,\,\,)\,\,+\,\,1\,\,+\,\,8\,\,\,)\,\,*\,\,(%
\,\,\,19\,\,+\,\,0\,\,+\,\,11\,\,\,)
\displaystyle(\,\,\,*\,\,\,(\,\,\,+\,\,\,(\,\,\,+\,\,\,15\,\,\,7\,\,\,)\,\,\,1%
\,\,\,8\,\,\,)\,\,\,(\,\,\,+\,\,\,19\,\,\,0\,\,\,11\,\,\,)\,\,\,)\,\,%
\Rightarrow(\,\,(\,\,15\,\,+\,\,7\,\,\,)\,\,+\,\,1\,\,+\,\,8\,\,\,)\,\,*\,\,(%
\,\,\,19\,\,+\,\,0\,\,+\,\,11\,\,\,)
\{(,),+,*\}
0
20
\$
15
2
4
3
5
4
1
2
6
200
\mathbf{x}_{j}
\hat{\mathbf{x}}_{j}
\hat{\mathbf{x}}_{j}=\mathbf{x}_{j}
\hat{\mathbf{x}}_{j}=[\mathbf{x}_{j};\mathbf{c}_{j}]
\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{softmax}(\theta_{ij})\mathbf{x}_{i}
\hat{\mathbf{x}}_{j}=[\mathbf{x}_{j};\mathbf{c}_{j}]
\mathbf{c}_{j}=\sum_{i=1}^{n}p(z_{ij}=1\,|\,x)\mathbf{x}_{i}
\mathbf{h}_{i}
\theta_{ij}=\tanh(\mathbf{s}^{\top}\tanh(\mathbf{W}_{1}\mathbf{h}_{i}+\mathbf{%
W}_{2}\mathbf{h}_{j}+\mathbf{b}))
\mathbf{s},\mathbf{b},\mathbf{W}_{1},\mathbf{W}_{2}
2
7.6
87.4
99.2
3
4.1
49.6
87.0
4
2.8
23.3
64.5
5
2.1
15.0
30.8
6
1.5
8.5
18.2
\$
\$
[\hat{\mathbf{x}}_{1},\dots,\hat{\mathbf{x}}_{n}]
500
3
50
50
10
j
\theta_{i}(k)=\begin{cases}\mathbf{h}_{i}\mathbf{W}\mathbf{h}_{j},&k=1\\
0,&k=0\end{cases}
[\mathbf{h}_{1},\dots,\mathbf{h}_{n}]
\mathbf{h}_{j}^{\prime}
j
\mathbf{b}
\theta_{i,i+1}(z_{i},z_{i+1})=\theta_{i}(z_{i})+\theta_{i+1}(z_{i+1})+\mathbf{%
b}_{z_{i},z_{i+1}}
4
\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{softmax}(\theta_{i})\mathbf{h}_{i}
\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{sigmoid}(\theta_{i})\mathbf{h}_{i}
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\frac{p(z_{i}=1\,|\,x,q)}{\gamma}%
\mathbf{h}_{i}\gamma=\frac{1}{\lambda}\sum_{i=1}^{n}p(z_{i}=1\,|\,x,q)
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\frac{p(z_{i}=1\,|\,x,q)}{\gamma}%
\mathbf{h}_{i}
\displaystyle\gamma=\frac{1}{\lambda}\sum_{i=1}^{n}p(z_{i}=1\,|\,x,q)
\gamma
\mathbf{c}_{j}=\sum_{i=1}^{n}p(z_{i}=1\,|\,x,q)\mathbf{h}_{i}
l_{2}
\lambda
\lambda=2
l_{2}
0.005
\mathbf{b}
12.6
13.1
14.6
14.1
13.8
14.3
\mathbf{b}
\mathbf{x}_{1},\dots,\mathbf{x}_{n}
n
\mathbf{q}
z_{k}
k
k
z_{k}\in\{1,\dots,n\}
z_{k}
p(z_{k}=i\,|\,x,q)=\operatorname{softmax}((\mathbf{x}_{i}^{k})^{\top}\mathbf{q%
}^{k})
\mathbf{c}^{k}=\sum_{i=1}^{n}p(z_{k}=i\,|\,x,q)\mathbf{o}_{i}^{k}
\mathbf{x}_{i}^{k},\mathbf{o}_{i}^{k}
i
k
k
\mathbf{q}^{k+1}=\mathbf{q}^{k}+\mathbf{c}^{k}
k=1,\dots,K
k=1
\mathbf{x}_{i}^{k}=\mathbf{x}_{i},\mathbf{q}^{k}=\mathbf{q},\mathbf{c}^{k}=%
\mathbf{0}
K
K
K
z_{1},\dots,z_{K}
n
K
K
K=2
n
\theta_{k}(i)=(\mathbf{x}_{i}^{k})^{\top}\mathbf{q}^{k}
\theta_{k,k+1}(i,j)=(\mathbf{x}_{i}^{k})^{\top}\mathbf{q}^{k}+(\mathbf{x}_{i}^%
{k})^{\top}\mathbf{x}_{j}^{k+1}+(\mathbf{x}_{j}^{k+1})^{\top}\mathbf{q}^{k+1}
\mathbf{c}=\sum_{z_{1},\ldots,z_{K}}p(z_{1},\ldots,z_{K}\,|\,x,q)f(x,z)
K
\mathbf{c}
n^{K}
K
K
f(x,z)
z
f(x,z)=\sum_{k=1}^{K}f_{k}(x,z_{k})
\mathbf{c}=\sum_{k=1}^{K}\sum_{i=1}^{n}p(z_{k}=i\,|\,x,q)f_{k}(x,z_{k})
f_{k}(x,z_{k})=\mathbf{o}_{z_{k}}^{k}
K
\%
\%
\%
\%
\%
\%
87.3
46.8
84.7
81.8
43.5
22.3
52.6
1.4
40.5
0.1
28.2
0.0
83.2
-
83.5
-
79.3
-
94.1
-
93.3
-
87.1
-
97.8
38.2
97.7
80.8
88.6
0.0
95.6
14.8
97.0
36.4
94.4
9.3
99.9
77.6
99.7
98.2
90.5
30.2
100.0
59.3
100.0
89.5
100.0
51.4
97.1
91.0
97.9
85.6
98.0
41.4
61.1
23.9
60.6
49.6
59.7
10.5
86.4
3.3
92.2
3.9
92.0
1.4
21.3
10.2
24.4
11.5
24.3
7.8
-
81.4
39.6
81.0
53.7
73.8
17.4
\%
\%
1
K
10
20
\%
\%
1
K
10
20
1
1
K
n
25
25
9
20
10\%
16
5\rightarrow 6\rightarrow 8
p(z_{k},z_{k+1}\,|\,x,q)
n
n=9
p(z_{1}=5,z_{2}=6,z_{3}=8\,|\,x,q)=0.0564,p(z_{1}=5,z_{2}=6,z_{3}=3\,|\,x,q)=0%
.0364,p(z_{1}=5,z_{2}=2,z_{3}=3\,|\,x,q)=0.0356
16
5\rightarrow 6\rightarrow 8
p(z_{k},z_{k+1}\,|\,x,q)
n
n=9
p(z_{1}=5,z_{2}=6,z_{3}=8\,|\,x,q)=0.0564,p(z_{1}=5,z_{2}=6,z_{3}=3\,|\,x,q)=0%
.0364,p(z_{1}=5,z_{2}=2,z_{3}=3\,|\,x,q)=0.0356
\%
\%
\hat{z}=\operatorname*{argmax}p(z_{1},\dots,z_{K}\,|\,x,q)
2
11
13
17
100\%
15
16
5\rightarrow 6\rightarrow 8
\hat{\mathbf{x}}_{j}=[\mathbf{x}_{j};\mathbf{x}_{\operatorname{head}(j)}]
\operatorname{head}(j)
x_{j}
\%
78.2
80.6
82.1
83.2
83.5
86.1
86.3
+
86.8
87.2
87.3
87.7
+
88.3
85.8
86.1
86.2
86.8
86.5
100
32
400
4
100
32
400
4
5\times
O(n)
[x_{1},\dots,x_{n}]
[\mathbf{x}_{1},\dots,\mathbf{x}_{n}]
i\in[1,\dots,n]
\displaystyle\mathbf{h}_{i}^{\text{fwd}}=\operatorname{LSTM}(\mathbf{x}_{i},%
\mathbf{h}_{i-1}^{\text{fwd}})\mathbf{h}_{i}^{\text{bwd}}=\operatorname{LSTM}(%
\mathbf{x}_{i},\mathbf{h}_{i+1}^{\text{bwd}})
\displaystyle\mathbf{h}_{i}^{\text{fwd}}=\operatorname{LSTM}(\mathbf{x}_{i},%
\mathbf{h}_{i-1}^{\text{fwd}})
\displaystyle\mathbf{h}_{i}^{\text{bwd}}=\operatorname{LSTM}(\mathbf{x}_{i},%
\mathbf{h}_{i+1}^{\text{bwd}})
\displaystyle\mathbf{h}_{i}=[\mathbf{h}_{i}^{\text{fwd}};\mathbf{h}_{i}^{\text%
{bwd}}]
\displaystyle\mathbf{h}_{i}=[\mathbf{h}_{i}^{\text{fwd}};\mathbf{h}_{i}^{\text%
{bwd}}]
x_{i}\rightarrow x_{j}
x_{i}
x_{j}
\theta_{ij}=\tanh(\mathbf{s}^{\top}\tanh(\mathbf{W}_{1}\mathbf{h}_{i}+\mathbf{%
W}_{2}\mathbf{h}_{j}+\mathbf{b}))
p(z_{ij}=1\,|\,x)
\mathbf{c}_{j}
x_{j}
p(z_{ij}=1\,|\,x)=\operatorname{softmax}(\theta_{ij})
[x_{1},\dots,x_{n}],[y_{1},\dots,y_{m}]
[\mathbf{x}_{1},\dots,\mathbf{x}_{n}],[\mathbf{y}_{1},\dots,\mathbf{y}_{m}]
\mathbf{x}_{i},\mathbf{y}_{j}\in\mathbb{R}^{l}
\mathbf{h}_{j}^{\prime}=\operatorname{LSTM}(\mathbf{y}_{j},\mathbf{h}_{j-1}^{%
\prime})
\mathbf{h}_{j}^{\prime}\in\mathbb{R}^{l}
\mathbf{W}\in\mathbb{R}^{l\times l}
\mathbf{m}_{i}
\displaystyle\alpha_{i}=\frac{\exp\mathbf{x}_{i}\mathbf{W}\mathbf{h}_{j}^{%
\prime}}{\sum_{k=1}^{n}\exp\mathbf{x}_{k}\mathbf{W}\mathbf{h}_{j}^{\prime}}%
\mathbf{m}_{i}=\sum_{i=1}^{n}\alpha_{i}\mathbf{x}_{i}
\displaystyle\alpha_{i}=\frac{\exp\mathbf{x}_{i}\mathbf{W}\mathbf{h}_{j}^{%
\prime}}{\sum_{k=1}^{n}\exp\mathbf{x}_{k}\mathbf{W}\mathbf{h}_{j}^{\prime}}
\displaystyle\mathbf{m}_{i}=\sum_{i=1}^{n}\alpha_{i}\mathbf{x}_{i}
\displaystyle\hat{\mathbf{h}}_{j}=\tanh(\mathbf{U}[\mathbf{m}_{i};\mathbf{h}_{%
j}^{\prime}])
\displaystyle\hat{\mathbf{h}}_{j}=\tanh(\mathbf{U}[\mathbf{m}_{i};\mathbf{h}_{%
j}^{\prime}])
\mathbf{W}\in\mathbb{R}^{l\times l}
\mathbf{U}\in\mathbb{R}^{2l\times l}
\hat{\mathbf{h}}_{j}
y_{j+1}
p(y_{j+1}\,|\,x_{1},\dots,x_{n},y_{1},\dots,y_{j})=\operatorname{softmax}(%
\mathbf{V}\hat{\mathbf{h}}_{j}+\mathbf{b})
j
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}p(z_{ki}=%
1\,|\,x)\,\mathbf{x}_{k}\right]\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_%
{k=1}^{n}\operatorname{softmax}(\theta_{ki})\,\mathbf{x}_{k}\right]
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}p(z_{ki}=%
1\,|\,x)\,\mathbf{x}_{k}\right]
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}%
\operatorname{softmax}(\theta_{ki})\,\mathbf{x}_{k}\right]
\theta_{ij}
\alpha_{i}
\mathbf{m}_{i}
\displaystyle\alpha_{i}=\frac{\exp\hat{\mathbf{x}}_{i}\mathbf{W}\mathbf{h}_{j}%
^{\prime}}{\sum_{k=1}^{n}\exp\hat{\mathbf{x}}_{k}\mathbf{W}\mathbf{h}_{j}^{%
\prime}}\mathbf{m}_{i}=\sum_{i=1}^{n}\alpha_{i}\hat{\mathbf{x}}_{i}
\displaystyle\alpha_{i}=\frac{\exp\hat{\mathbf{x}}_{i}\mathbf{W}\mathbf{h}_{j}%
^{\prime}}{\sum_{k=1}^{n}\exp\hat{\mathbf{x}}_{k}\mathbf{W}\mathbf{h}_{j}^{%
\prime}}
\displaystyle\mathbf{m}_{i}=\sum_{i=1}^{n}\alpha_{i}\hat{\mathbf{x}}_{i}
\mathbf{W}\in\mathbb{R}^{2l\times l}
\mathbf{U}\in\mathbb{R}^{3l\times l}
l=50
50
20
13
1.0
9
U[-0.1,0.1]
1
1
l_{2}
1
=5
[x_{1},\dots,x_{n}],[y_{1},\dots,y_{m}]
[\mathbf{x}_{1},\dots,\mathbf{x}_{n}],[\mathbf{y}_{1},\dots,\mathbf{y}_{m}]
[\mathbf{h}_{1},\dots,\mathbf{h}_{n}]
\mathbf{h}_{i}=\operatorname{LSTM}(\mathbf{x}_{i},\mathbf{h}_{i-1})
\mathbf{h}_{i}\in\mathbb{R}^{l}
\mathbf{h}_{j}^{\prime}\in\mathbb{R}^{l}
\mathbf{W}\in\mathbb{R}^{l\times l}
j
\displaystyle\theta_{i}=\mathbf{h}_{i}\mathbf{W}\mathbf{h}_{j}^{\prime}\mathbf%
{c}_{j}=\sum_{i=1}^{n}\operatorname{softmax}(\theta_{i})\mathbf{h}_{i}
\displaystyle\theta_{i}=\mathbf{h}_{i}\mathbf{W}\mathbf{h}_{j}^{\prime}
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{softmax}(\theta_{i})%
\mathbf{h}_{i}
\theta_{i}
\operatorname{sigmoid}
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{sigmoid}(\theta_{i})%
\mathbf{h}_{i}
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\operatorname{sigmoid}(\theta_{i})%
\mathbf{h}_{i}
\theta_{i}(k)=\begin{cases}\mathbf{h}_{i}\mathbf{W}\mathbf{h}_{j}^{\prime},&k=%
1\\
0,&k=0\end{cases}
\displaystyle\theta_{i,i+1}(z_{i},z_{i+1})=\theta_{i}(z_{i})+\theta_{i+1}(z_{i%
+1})+\mathbf{b}_{z_{i},z_{i+1}}
\displaystyle\theta_{i,i+1}(z_{i},z_{i+1})
\displaystyle=\theta_{i}(z_{i})+\theta_{i+1}(z_{i+1})+\mathbf{b}_{z_{i},z_{i+1}}
\mathbf{b}
p(z_{i}=1\,|\,x,q)
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\frac{p(z_{i}=1\,|\,x,q)}{\gamma}%
\mathbf{h}_{i}\gamma=\frac{1}{\lambda}\sum_{i}^{n}p(z_{i}=1\,|\,x,q)
\displaystyle\mathbf{c}_{j}=\sum_{i=1}^{n}\frac{p(z_{i}=1\,|\,x,q)}{\gamma}%
\mathbf{h}_{i}
\displaystyle\gamma=\frac{1}{\lambda}\sum_{i}^{n}p(z_{i}=1\,|\,x,q)
\lambda=2
l_{2}
0.005
\mathbf{b}
\displaystyle\hat{\mathbf{h}}_{j}=\tanh(\mathbf{U}[\mathbf{c}_{j};\mathbf{h}_{%
j}^{\prime}])
\displaystyle\hat{\mathbf{h}}_{j}=\tanh(\mathbf{U}[\mathbf{c}_{j};\mathbf{h}_{%
j}^{\prime}])
\hat{\mathbf{h}}_{j}
y_{j+1}
\displaystyle p(y_{j+1}\,|\,x_{1},\dots,x_{n},y_{1},\dots y_{j})=\operatorname%
{softmax}(\mathbf{V}\hat{\mathbf{h}}_{j}+\mathbf{b})
\displaystyle p(y_{j+1}\,|\,x_{1},\dots,x_{n},y_{1},\dots y_{j})=\operatorname%
{softmax}(\mathbf{V}\hat{\mathbf{h}}_{j}+\mathbf{b})
2
500
l=500
128
30
1.0
0.3
U[-0.1,0.1]
1
=5
x=[x_{1},\dots,x_{n}]
n
[\mathbf{x}_{1},\dots,\mathbf{x}_{n}]
\mathbf{q}
q
K
\displaystyle p(z_{k}=i\,|\,x,q)=\operatorname{softmax}((\mathbf{x}_{i}^{k})^{%
\top}\mathbf{q}^{k})
\displaystyle p(z_{k}=i\,|\,x,q)=\operatorname{softmax}((\mathbf{x}_{i}^{k})^{%
\top}\mathbf{q}^{k})
\displaystyle\mathbf{c}^{k}=\sum_{i=1}^{n}p(z_{k}=i\,|\,x,q)\mathbf{o}_{i}^{k}
\displaystyle\mathbf{c}^{k}=\sum_{i=1}^{n}p(z_{k}=i\,|\,x,q)\mathbf{o}_{i}^{k}
\displaystyle\mathbf{q}^{k+1}=\mathbf{q}^{k}+\mathbf{c}^{k}
\displaystyle\mathbf{q}^{k+1}=\mathbf{q}^{k}+\mathbf{c}^{k}
\displaystyle p(y\,|\,x,q)=\operatorname{softmax}(\mathbf{W}(\mathbf{q}^{K}+%
\mathbf{c}^{K}))
\displaystyle p(y\,|\,x,q)=\operatorname{softmax}(\mathbf{W}(\mathbf{q}^{K}+%
\mathbf{c}^{K}))
p(y\,|\,x,q)
\{\mathbf{x}_{i}^{k}\}
\{\mathbf{o}_{i}^{k}\}
\mathbf{X}^{k}
\mathbf{O}^{k}
\mathbf{X}^{k+1}=\mathbf{O}^{k},\mathbf{W}^{T}=\mathbf{O}^{K}
\mathbf{X}^{1}
k=1
\mathbf{x}_{i}^{k}=\mathbf{x}_{i},\mathbf{q}^{k}=\mathbf{q},\mathbf{c}^{k}=%
\mathbf{0}
\theta_{k}(i)=(\mathbf{x}_{i}^{k})^{\top}\mathbf{q}^{k}
\theta_{k,k+1}(i,j)=(\mathbf{x}_{i}^{k})^{\top}\mathbf{q}^{k}+(\mathbf{x}_{i}^%
{k})^{\top}\mathbf{x}_{j}^{k+1}+(\mathbf{x}_{j}^{k+1})^{\top}\mathbf{q}^{k+1}
\mathbf{q}^{k}
\mathbf{q}^{k+1}=\mathbf{Q}\mathbf{q}^{k}
\theta_{k,k+1}(i,i)=-\infty
i\in\{1,\dots,n\}
p(z_{k}=i,z_{k+1}=j\,|\,x,q)
\displaystyle\mathbf{c}=\sum_{z_{1},\ldots,z_{K}}p(z_{1},\ldots,z_{K}\,|\,x,q)%
f(x,z)f(x,z)=\sum_{k=1}^{K}f_{k}(x,z_{k})
\displaystyle\mathbf{c}=\sum_{z_{1},\ldots,z_{K}}p(z_{1},\ldots,z_{K}\,|\,x,q)%
f(x,z)
\displaystyle f(x,z)=\sum_{k=1}^{K}f_{k}(x,z_{k})
\displaystyle f_{k}(x,z_{k})=\mathbf{o}_{z_{k}}^{k}
\displaystyle f_{k}(x,z_{k})=\mathbf{o}_{z_{k}}^{k}
f(x,z)
z
\mathbf{c}
p(z_{k}\,|\,x,q)
\displaystyle p(y\,|\,x,q)=\operatorname{softmax}(\mathbf{W}(\mathbf{q}^{K}+%
\mathbf{c}))
\displaystyle p(y\,|\,x,q)=\operatorname{softmax}(\mathbf{W}(\mathbf{q}^{K}+%
\mathbf{c}))
0.01
2
25
100
25
20
40
\operatorname{softmax}(\cdot)
20
\log(\operatorname{softmax}(\cdot))
\mathbf{q}^{k}
20
[x_{1},\dots,x_{n}],[y_{1},\dots,y_{m}]
[\mathbf{x}_{1},\dots,\mathbf{x}_{n}],[\mathbf{y}_{1},\dots,\mathbf{y}_{m}]
300
840
300
100
0
1
\displaystyle e_{ij}=f(\mathbf{x}_{i})^{\top}f(\mathbf{y}_{j})\bar{\mathbf{x}}%
_{i}=\left[\mathbf{x}_{i};\sum_{j=1}^{m}\frac{\exp e_{ij}}{\sum_{k=1}^{m}\exp e%
_{ik}}\mathbf{y}_{j}\right]
\displaystyle e_{ij}=f(\mathbf{x}_{i})^{\top}f(\mathbf{y}_{j})
\displaystyle\bar{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{j=1}^{m}\frac{%
\exp e_{ij}}{\sum_{k=1}^{m}\exp e_{ik}}\mathbf{y}_{j}\right]
\displaystyle\bar{\mathbf{y}}_{j}=\left[\mathbf{y}_{j};\sum_{i=1}^{n}\frac{%
\exp e_{ij}}{\sum_{k=1}^{n}\exp e_{kj}}\mathbf{x}_{i}\right]
\displaystyle\bar{\mathbf{y}}_{j}=\left[\mathbf{y}_{j};\sum_{i=1}^{n}\frac{%
\exp e_{ij}}{\sum_{k=1}^{n}\exp e_{kj}}\mathbf{x}_{i}\right]
f(\cdot)
g(\cdot)
h(\cdot)
l
\displaystyle\bar{\mathbf{x}}=\sum_{i=1}^{n}g(\bar{\mathbf{x}}_{i})\hskip 56.9%
055pt\bar{\mathbf{y}}=\sum_{j=1}^{m}g(\bar{\mathbf{y}}_{j})
\displaystyle\bar{\mathbf{x}}
\displaystyle=\sum_{i=1}^{n}g(\bar{\mathbf{x}}_{i})\hskip 56.9055pt\bar{%
\mathbf{y}}=\sum_{j=1}^{m}g(\bar{\mathbf{y}}_{j})
\displaystyle p(l\,|\,x_{1},\dots,x_{n},y_{1},\dots,y_{m})=\operatorname{%
softmax}(\mathbf{V}h([\bar{\mathbf{x}};\bar{\mathbf{y}}])+\mathbf{b})
\displaystyle p(l\,|\,x_{1},
\displaystyle\dots,x_{n},y_{1},\dots,y_{m})=\operatorname{softmax}(\mathbf{V}h%
([\bar{\mathbf{x}};\bar{\mathbf{y}}])+\mathbf{b})
2
300
\operatorname{ReLU}
0.2
\theta_{ij}
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}p(z_{ki}=%
1\,|\,x)\mathbf{x}_{k}\right]
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}p(z_{ki}=%
1\,|\,x)\mathbf{x}_{k}\right]
\hat{\mathbf{x}}_{i}
\hat{\mathbf{y}}_{j}
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}\frac{%
\exp\theta_{ki}}{\sum_{l=1}^{n}\exp\theta_{li}}\mathbf{x}_{k}\right]
\displaystyle\hat{\mathbf{x}}_{i}=\left[\mathbf{x}_{i};\sum_{k=1}^{n}\frac{%
\exp\theta_{ki}}{\sum_{l=1}^{n}\exp\theta_{li}}\mathbf{x}_{k}\right]
100
32
100
0.05
0.1
0
0.01
5
0.01
\beta_{1}=0.9
\beta_{2}=0.999
\alpha
\beta
\alpha,\beta
n\times n\times 2\times 2
n
L
R
1
0
O(n^{3})
O(n^{3})
\mathcal{L}
\nabla^{\mathcal{L}}_{p}
\nabla^{\mathcal{L}}_{\theta}
\theta
\alpha,\beta\leftarrow-\infty
\alpha
\beta
i=1,\dots,n
\alpha[i,i,L,1]\leftarrow 0
\alpha[i,i,R,1]\leftarrow 0
\beta[1,n,R,1]\leftarrow 0
k=1,\dots,n
s=1,\dots,n-k
t\leftarrow s+k
\alpha[s,t,R,0]\leftarrow\bigoplus_{u\in[s,t-1]}\alpha[s,u,R,1]\otimes\alpha[u%
+1,t,L,1]\otimes\theta_{st}
\alpha[s,t,L,0]\leftarrow\bigoplus_{u\in[s,t-1]}\alpha[s,u,R,1]\otimes\alpha[u%
+1,t,L,1]\otimes\theta_{ts}
\alpha[s,t,R,1]\leftarrow\bigoplus_{u\in[s+1,t]}\alpha[s,u,R,0]\otimes\alpha[u%
,t,R,1]
\alpha[s,t,L,1]\leftarrow\bigoplus_{u\in[s,t-1]}\alpha[s,u,L,1]\otimes\alpha[u%
,t,L,0]
k=n,\dots,1
s=1,\dots,n-k
t\leftarrow s+k
u=s+1,\dots,t
\beta[s,u,R,0]\leftarrow_{\oplus}\beta[s,t,R,1]\otimes\alpha[u,t,R,1]
\beta[u,t,R,1]\leftarrow_{\oplus}\beta[s,t,R,1]\otimes\alpha[s,u,R,0]
s>1
u=s,\dots,t-1
\beta[s,u,L,1]\leftarrow_{\oplus}\beta[s,t,L,1]\otimes\alpha[u,t,L,0]
\beta[u,t,L,0]\leftarrow_{\oplus}\beta[s,t,L,1]\otimes\alpha[s,u,L,1]
u=s,\dots,t-1
\beta[s,u,R,1]\leftarrow_{\oplus}\beta[s,t,R,0]\otimes\alpha[u+1,t,L,1]\otimes%
\theta_{st}
\beta[u+1,t,L,1]\leftarrow_{\oplus}\beta[s,t,R,0]\otimes\alpha[s,u,R,1]\otimes%
\theta_{st}
s>1
u=s,\dots,t-1
\beta[s,u,R,1]\leftarrow_{\oplus}\beta[s,t,L,0]\otimes\alpha[u+1,t,L,1]\otimes%
\theta_{ts}
\beta[u+1,t,L,1]\leftarrow_{\oplus}\beta[s,t,L,0]\otimes\alpha[s,u,R,1]\otimes%
\theta_{ts}
A\leftarrow\alpha[1,n,R,1]
s=1,\dots,n-1
p[s,t]=p(z_{st}=1\,|\,x)
t=s+1,\dots,n
p[s,t]\leftarrow\exp(\alpha[s,t,R,0]\otimes\beta[s,t,R,0]\otimes-A)
s>1
p[t,s]\leftarrow\exp(\alpha[s,t,L,0]\otimes\beta[s,t,L,0]\otimes-A)
p
n
\oplus=\operatorname{logadd}
\otimes=+
a,b\leftarrow c
a\leftarrow c
b\leftarrow c
a\leftarrow_{\oplus}b
a\leftarrow a\oplus b
n
\oplus=\operatorname{logadd}
\otimes=+
a,b\leftarrow c
a\leftarrow c
b\leftarrow c
a\leftarrow_{\oplus}b
a\leftarrow a\oplus b
\theta,p,\nabla_{p}^{\mathcal{L}}
s,t=1,\dots,n;s\neq t
\nabla^{\mathcal{L}}_{\theta}=(p\odot\nabla_{p}^{\mathcal{L}})\nabla^{\log p}_%
{\theta}
\delta[s,t]\leftarrow\log p[s,t]\otimes\log\nabla_{p}^{\mathcal{L}}[s,t]
\delta=\log(p\odot\nabla_{p}^{\mathcal{L}})
\nabla_{\alpha}^{\mathcal{L}},\nabla_{\beta}^{\mathcal{L}},\log\nabla_{\theta}%
^{\mathcal{L}}\leftarrow-\infty
\nabla_{\alpha}^{\mathcal{L}}
\nabla_{\beta}^{\mathcal{L}}
\nabla^{\mathcal{L}}_{\theta}
s=1,\dots,n-1
\delta
\nabla_{\alpha}^{\mathcal{L}}
\nabla_{\beta}^{\mathcal{L}}
t=s+1,\dots,n
\nabla_{\alpha}^{\mathcal{L}}[s,t,R,0],\nabla_{\beta}^{\mathcal{L}}[s,t,R,0]%
\leftarrow\delta[s,t]
\nabla_{\alpha}^{\mathcal{L}}[1,n,R,1]\leftarrow_{\oplus}-\delta[s,t]
s>1
\nabla_{\alpha}^{\mathcal{L}}[s,t,L,0],\nabla_{\beta}^{\mathcal{L}}[s,t,L,0]%
\leftarrow\delta[t,s]
\nabla_{\alpha}^{\mathcal{L}}[1,n,R,1]\leftarrow_{\oplus}-\delta[s,t]
k=1,\dots,n
s=1,\dots,n-k
t\leftarrow s+k
\nu\leftarrow\nabla_{\beta}^{\mathcal{L}}[s,t,R,0]\otimes\beta[s,t,R,0]
\nu,\gamma
u=t,\dots,n
\nabla_{\beta}^{\mathcal{L}}[s,u,R,1],\nabla_{\alpha}^{\mathcal{L}}[t,u,R,1]%
\leftarrow_{\oplus}\nu\otimes\beta[s,u,R,1]\otimes\alpha[t,u,R,1]
s>1
\nu\leftarrow\nabla_{\beta}^{\mathcal{L}}[s,t,L,0]\otimes\beta[s,t,L,0]
u=1,\dots,s
\nabla_{\beta}^{\mathcal{L}}[u,t,L,1],\nabla_{\alpha}^{\mathcal{L}}[u,s,L,1]%
\leftarrow_{\oplus}\nu\otimes\beta[u,t,L,1]\otimes\alpha[u,s,L,1]
\nu\leftarrow\nabla_{\beta}^{\mathcal{L}}[s,t,L,1]\otimes\beta[s,t,L,1]
u=t,\dots,n
\nabla_{\beta}^{\mathcal{L}}[s,u,L,1],\nabla_{\alpha}^{\mathcal{L}}[t,u,L,0]%
\leftarrow_{\oplus}\nu\otimes\beta[s,u,L,1]\otimes\alpha[t,u,L,1]
u=1,\dots,s-1
\gamma\leftarrow\beta[u,t,R,0]\otimes\alpha[u,s-1,R,1]\otimes\theta_{ut}
\nabla_{\beta}^{\mathcal{L}}[u,t,R,0],\nabla_{\alpha}^{\mathcal{L}}[u,s-1,R,1]%
,\log\nabla_{\theta}^{\mathcal{L}}[u,t]\leftarrow_{\oplus}\nu\otimes\gamma
\gamma\leftarrow\beta[u,t,L,0]\otimes\alpha[u,s-1,R,1]\otimes\theta_{tu}
\nabla_{\beta}^{\mathcal{L}}[u,t,L,0],\nabla_{\alpha}^{\mathcal{L}}[u,s-1,R,1]%
,\log\nabla_{\theta}^{\mathcal{L}}[t,u]\leftarrow_{\oplus}\nu\otimes\gamma
\nu\leftarrow\nabla_{\beta}^{\mathcal{L}}[s,t,R,1]\otimes\beta[s,t,R,1]
u=1,\dots,s
\nabla_{\beta}^{\mathcal{L}}[u,t,R,1],\nabla_{\alpha}^{\mathcal{L}}[u,s,R,0]%
\leftarrow_{\oplus}\nu\otimes\beta[u,t,R,1]\otimes\alpha[u,s,R,0]
u=t+1,\dots,n
\gamma\leftarrow\beta[s,u,R,0]\otimes\alpha[t+1,u,L,1]\otimes\theta_{su}
\nabla_{\beta}^{\mathcal{L}}[s,u,R,0],\nabla_{\alpha}^{\mathcal{L}}[t+1,u,L,1]%
,\log\nabla_{\theta}^{\mathcal{L}}[s,u]\leftarrow_{\oplus}\nu\otimes\gamma
\gamma\leftarrow\beta[s,u,L,0]\otimes\alpha[t+1,u,L,1]\otimes\theta_{us}
\nabla_{\beta}^{\mathcal{L}}[s,u,L,0],\nabla_{\alpha}^{\mathcal{L}}[t+1,u,L,1]%
,\log\nabla_{\theta}^{\mathcal{L}}[u,s]\leftarrow_{\oplus}\nu\otimes\gamma
k=n,\dots,1
s=1,\dots,n-k
t\leftarrow s+k
\nu\leftarrow\nabla_{\alpha}^{\mathcal{L}}[s,t,R,1]\otimes\alpha[s,t,R,1]
u=s+1,\dots,t
\nabla_{\alpha}^{\mathcal{L}}[u,t,R,0],\nabla_{\alpha}^{\mathcal{L}}[u,t,R,1]%
\leftarrow_{\oplus}\nu\otimes\alpha[s,u,R,0]\otimes\alpha[u,t,R,1]
s>1
\nu\leftarrow\nabla_{\alpha}^{\mathcal{L}}[s,t,L,1]\otimes\alpha[s,t,L,1]
u=s,\dots,t-1
\nabla_{\alpha}^{\mathcal{L}}[s,u,L,1],\nabla_{\alpha}^{\mathcal{L}}[u,t,L,0]%
\leftarrow_{\oplus}\nu\otimes\alpha[s,u,L,1]\otimes\alpha[u,t,L,0]
\nu\leftarrow\nabla_{\alpha}^{\mathcal{L}}[s,t,L,0]\otimes\alpha[s,t,L,0]
u=s,\dots,t-1
\gamma\leftarrow\alpha[s,u,R,1]\otimes\alpha[u+1,t,L,1]\otimes\theta_{ts}
\nabla_{\alpha}^{\mathcal{L}}[s,u,R,1],\nabla_{\alpha}^{\mathcal{L}}[u+1,t,L,1%
],\log\nabla_{\theta}^{\mathcal{L}}[t,s]\leftarrow_{\oplus}\nu\otimes\gamma
\nu\leftarrow\nabla_{\alpha}^{\mathcal{L}}[s,t,R,0]\otimes\alpha[s,t,R,0]
u=s,\dots,t-1
\gamma\leftarrow\alpha[s,u,R,1]\otimes\alpha[u+1,t,L,1]\otimes\theta_{st}
\nabla_{\alpha}^{\mathcal{L}}[s,u,R,1],\nabla_{\alpha}^{\mathcal{L}}[u+1,t,L,1%
],\log\nabla_{\theta}^{\mathcal{L}}[s,t]\leftarrow_{\oplus}\nu\otimes\gamma
\operatorname{signexp}\log\nabla_{\theta}^{\mathcal{L}}
\nabla^{\mathcal{L}}_{\theta}
\nabla^{a}_{b}
a
b
\nabla^{\mathcal{L}}_{\theta}
\theta
a,b\leftarrow_{\oplus}c
a\leftarrow a\oplus c
b\leftarrow b\oplus c
\nabla^{a}_{b}
a
b
\nabla^{\mathcal{L}}_{\theta}
\theta
a,b\leftarrow_{\oplus}c
a\leftarrow a\oplus c
b\leftarrow b\oplus c
