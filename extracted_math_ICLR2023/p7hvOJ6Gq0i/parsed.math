75.67\%
\ell_{\infty}
\epsilon_{\infty}=8/255
+4.77\%
\ell_{\infty}
\epsilon_{\infty}=8/255
\ell_{2}
\epsilon_{2}=0.5
\bm{\mathbf{x}}
\hat{\bm{\mathbf{x}}}
p(y|\hat{\bm{\mathbf{x}}})
\log p_{\theta}(\hat{\bm{\mathbf{x}}}|y)
\bm{\mathbf{x}}
\hat{\bm{\mathbf{x}}}
p(y|\hat{\bm{\mathbf{x}}})
\log p_{\theta}(\hat{\bm{\mathbf{x}}}|y)
p(y|\bm{\mathbf{x}})
p_{\theta}(\bm{\mathbf{x}}|y)
p_{\theta}(\bm{\mathbf{x}}|y)
\ell_{\infty}
\epsilon_{\infty}=8/255
+4.77\%
+3.01\%
>30\%
p(y|\bm{\mathbf{x}})
\bm{\mathbf{x}}
p(\bm{\mathbf{x}}|y)
\log p(\bm{\mathbf{x}}|y)
p(y|\bm{\mathbf{x}})
\log p(\bm{\mathbf{x}},y)=\log p(\bm{\mathbf{x}})+\log p(y|\bm{\mathbf{x}})
\log p(\bm{\mathbf{x}})
\log p(y|\bm{\mathbf{x}})
p(y|\bm{\mathbf{x}})
\log p(\bm{\mathbf{x}},y)
p(y|\bm{\mathbf{x}})
\bm{\mathbf{x}}:=\bm{\mathbf{x}}_{0}
q(\bm{\mathbf{x}}_{0})
\{\bm{\mathbf{x}}_{t}\}_{t=1}^{T}
\{\alpha_{t}\}_{t=1}^{T}
\{\sigma_{t}\}_{t=1}^{T}
\displaystyle q(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}_{0})=\mathcal{N}(\bm{%
\mathbf{x}}_{t};\sqrt{\alpha_{t}}\bm{\mathbf{x}}_{0},\sigma_{t}^{2}\mathbf{I}).
\displaystyle q(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}_{0})=\mathcal{N}(\bm{%
\mathbf{x}}_{t};\sqrt{\alpha_{t}}\bm{\mathbf{x}}_{0},\sigma_{t}^{2}\mathbf{I}).
\text{SNR}(t)=\alpha_{t}/\sigma^{2}_{t}
\bm{\mathbf{x}}_{t}
\bm{\mathbf{x}}_{T}
q(\bm{\mathbf{x}}_{0})
p(\bm{\mathbf{x}}_{T})=\mathcal{N}(\bm{\mathbf{x}}_{T};\mathbf{0},\mathbf{I})
\displaystyle p_{\theta}(\bm{\mathbf{x}}_{0:T})=p(\bm{\mathbf{x}}_{T})\prod_{t%
=1}^{T}p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{t}),
\displaystyle p_{\theta}(\bm{\mathbf{x}}_{0:T})=p(\bm{\mathbf{x}}_{T})\prod_{t%
=1}^{T}p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{t}),
\displaystyle p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{t})=\mathcal{N%
}(\bm{\mathbf{x}}_{t-1};\bm{\mathbf{\mu}}_{\theta}(\bm{\mathbf{x}}_{t},t),%
\tilde{\sigma}_{t}^{2}\mathbf{I}),
\displaystyle p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{t})=\mathcal{N%
}(\bm{\mathbf{x}}_{t-1};\bm{\mathbf{\mu}}_{\theta}(\bm{\mathbf{x}}_{t},t),%
\tilde{\sigma}_{t}^{2}\mathbf{I}),
\bm{\mathbf{\mu}}_{\theta}
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)
\bm{\mathbf{\mu}}_{\theta}(\bm{\mathbf{x}}_{t},t)=\sqrt{\frac{\alpha_{t-1}}{%
\alpha_{t}}}\left(\bm{\mathbf{x}}_{t}-\frac{\sigma_{t}^{2}-\frac{\alpha_{t}}{%
\alpha_{t-1}}\sigma_{t-1}^{2}}{\sigma_{t}}\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t)\right).
\displaystyle\log p_{\theta}(\bm{\mathbf{x}})\geq\mathbb{E}_{q}[-D_{\mathrm{KL%
}}(q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0})\|p(\bm{\mathbf{x}}_{T}))+\log p_%
{\theta}(\bm{\mathbf{x}}_{0}|\bm{\mathbf{x}}_{1})
\displaystyle\log p_{\theta}(\bm{\mathbf{x}})\geq
\displaystyle\mathbb{E}_{q}[-D_{\mathrm{KL}}(q(\bm{\mathbf{x}}_{T}|\bm{\mathbf%
{x}}_{0})\|p(\bm{\mathbf{x}}_{T}))+\log p_{\theta}(\bm{\mathbf{x}}_{0}|\bm{%
\mathbf{x}}_{1})
\displaystyle-\sum_{t>1}D_{\mathrm{KL}}(q(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}%
}_{t},\bm{\mathbf{x}}_{0})\|p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{%
t}))]
\displaystyle-\sum_{t>1}D_{\mathrm{KL}}(q(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}%
}_{t},\bm{\mathbf{x}}_{0})\|p_{\theta}(\bm{\mathbf{x}}_{t-1}|\bm{\mathbf{x}}_{%
t}))]
\displaystyle=-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}\left[w_{t}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}\|_{2}^{2}%
\right]+C_{1},
\displaystyle=
\displaystyle-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}\left[w_{t}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}\|_{2}^{2}%
\right]+C_{1},
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(%
\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\bm{\mathbf{\epsilon}}
\mathcal{N}(\mathbf{0},\mathbf{I})
\bm{\mathbf{x}}_{t}=\sqrt{\alpha_{t}}\bm{\mathbf{x}}_{0}+\sigma_{t}\bm{\mathbf%
{\epsilon}}
C_{1}
w_{t}=\frac{\sigma_{t}\alpha_{t-1}}{2\tilde{\sigma}_{t}^{2}(1-\alpha_{t})%
\alpha_{t}}
w_{t}=1
p_{\theta}(\bm{\mathbf{x}}|y)
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)
p_{\theta}(\bm{\mathbf{x}})
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)=\bm{\mathbf{\epsilon}}_%
{\theta}(\bm{\mathbf{x}}_{t},t,y=\varnothing)
\log p_{\theta}(\bm{\mathbf{x}}|y)\geq-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}%
\left[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}\right]+C,
C
\bm{\mathbf{x}}
p_{\theta}(y|\bm{\mathbf{x}})
y\in\{1,2,..,K\}
K
\tilde{y}=\operatorname*{arg\,max}_{y}p_{\theta}(y|\bm{\mathbf{x}})
p_{\theta}(y|\bm{\mathbf{x}})
\bm{\mathbf{x}}^{*}
\bm{\mathbf{x}}
\ell_{p}
\|\bm{\mathbf{x}}^{*}-\bm{\mathbf{x}}\|_{p}\leq\epsilon_{p}
p_{\theta}(y|\bm{\mathbf{x}})\propto p_{\theta}(\bm{\mathbf{x}}|y)p(y)
p_{\theta}(y|\bm{\mathbf{x}})
p(y)=1/K
p_{\theta}(y|\bm{\mathbf{x}})
d(\bm{\mathbf{x}},y,\theta)=\log p_{\theta}(\bm{\mathbf{x}}|y)+\mathbb{E}_{\bm%
{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_%
{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
y
p(y)=\frac{1}{K}
d(\bm{\mathbf{x}},y,\theta)\to 0
y
p_{\theta}(y|\bm{\mathbf{x}})
p_{\theta}(y|\bm{\mathbf{x}})=\frac{\exp(-\mathbb{E}_{\bm{\mathbf{\epsilon}},t%
}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{%
\epsilon}}\|_{2}^{2}])}{\sum_{\hat{y}}\exp(-\mathbb{E}_{\bm{\mathbf{\epsilon}}%
,t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,\hat{y})-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}])}.
d(\bm{\mathbf{x}},y,\theta)
0
\bm{\mathbf{\epsilon}}
t
p(y)=1/K
\log p(y)
y
p(y)
D
D_{y}\subset D
y
\bm{\mathbf{\epsilon}}_{\theta_{D}^{*}}(\bm{\mathbf{x}}_{t},t,y)
D
\bm{\mathbf{\epsilon}}
\bm{\mathbf{\epsilon}}_{\theta_{D}^{*}}(\bm{\mathbf{x}}_{t},t,y)=\sum_{\bm{%
\mathbf{x}}^{(i)}\in D_{y}}\frac{1}{\sigma_{t}}s(\bm{\mathbf{x}}_{t},\bm{%
\mathbf{x}}^{(i)})\cdot(\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{%
(i)})
s(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}}^{(i)})
\bm{\mathbf{x}}_{t}
\bm{\mathbf{x}}^{(i)}
s(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}}^{(i)})=\frac{\exp(-\frac{1}{2\sigma_{t}^%
{2}}\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2})}{%
\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp(-\frac{1}{2\sigma_{t}^{2}}\|\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(j)}\|_{2}^{2})}
p_{\theta_{D}^{*}}(y|\bm{\mathbf{x}})
\bm{\mathbf{\epsilon}}_{\theta_{D}^{*}}(\bm{\mathbf{x}}_{t},t,y)
p_{\theta_{D}^{*}}(y|\bm{\mathbf{x}})=\mathrm{softmax}\left(f_{\theta_{D}^{*}}%
(\bm{\mathbf{x}})\right)_{y}
\displaystyle f_{\theta_{D}^{*}}(\bm{\mathbf{x}})_{y}=-\mathbb{E}_{\bm{\mathbf%
{\epsilon}},t}\left[\frac{\alpha_{t}}{\sigma_{t}^{2}}\Big{\|}\sum_{\bm{\mathbf%
{x}}^{(i)}\in D_{y}}s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{%
\epsilon}},t)\cdot(\bm{\mathbf{x}}-\bm{\mathbf{x}}^{(i)})\Big{\|}_{2}^{2}%
\right],
\displaystyle f_{\theta_{D}^{*}}(\bm{\mathbf{x}})_{y}=-\mathbb{E}_{\bm{\mathbf%
{\epsilon}},t}\left[\frac{\alpha_{t}}{\sigma_{t}^{2}}\Big{\|}\sum_{\bm{\mathbf%
{x}}^{(i)}\in D_{y}}s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{%
\epsilon}},t)\cdot(\bm{\mathbf{x}}-\bm{\mathbf{x}}^{(i)})\Big{\|}_{2}^{2}%
\right],
\displaystyle s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{\epsilon}},t%
)=\frac{\exp\left(-\frac{\|\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{%
\mathbf{\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{%
t}^{2}}\right)}{\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp\left(-\frac{\|\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-\sqrt{\alpha_{t}}%
\bm{\mathbf{x}}^{(j)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}.
\displaystyle s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{\epsilon}},t%
)=\frac{\exp\left(-\frac{\|\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{%
\mathbf{\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{%
t}^{2}}\right)}{\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp\left(-\frac{\|\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-\sqrt{\alpha_{t}}%
\bm{\mathbf{x}}^{(j)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}.
\ell_{2}
\bm{\mathbf{x}}
\bm{\mathbf{x}}^{(i)}
y
\bm{\mathbf{x}}
\tilde{y}
\bm{\mathbf{x}}
D_{\tilde{y}}
\ell_{2}
\frac{\alpha_{t}}{\sigma_{t}^{2}}
\frac{\alpha_{t}}{\sigma_{t}^{2}}
t
\ell_{\infty}
\epsilon_{\infty}=8/255
\ell_{2}
\epsilon_{2}=0.5
\ell_{\infty}
\ell_{2}
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(%
\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
p_{\theta}(\bm{\mathbf{x}}|y)
d(\bm{\mathbf{x}},y,\theta)\to 0
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(%
\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\bm{\mathbf{x}}
d(\bm{\mathbf{x}},y,\theta)
\bm{\mathbf{x}}
\min_{\hat{\bm{\mathbf{x}}}}\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{%
\mathbf{\epsilon}}_{\theta}(\hat{\bm{\mathbf{x}}}_{t},t)-\bm{\mathbf{\epsilon}%
}\|_{2}^{2}],\quad\text{s.t.}\;\|\hat{\bm{\mathbf{x}}}-\bm{\mathbf{x}}\|_{%
\infty}\leq\eta,
d(\bm{\mathbf{x}},\theta)
p(\bm{\mathbf{x}})
\ell_{\infty}
\hat{\bm{\mathbf{x}}}
\bm{\mathbf{x}}
\eta
\hat{\bm{\mathbf{x}}}
N
\hat{\bm{\mathbf{x}}}
\eta
y
\log p(\bm{\mathbf{x}})
\log p(\bm{\mathbf{x}}|y)
\hat{\bm{\mathbf{x}}}
\bm{\mathbf{\epsilon}}_{\theta}
\bm{\mathbf{x}}
\eta
\gamma
N
\mu
\bm{\mathbf{m}}=0,\hat{\bm{\mathbf{x}}}=\bm{\mathbf{x}}
n=0
N-1
\bm{\mathbf{g}}=\nabla_{\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[%
w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\hat{\bm{\mathbf{x}}}_{t},t)-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}]
t
\bm{\mathbf{\epsilon}}
\bm{\mathbf{m}}=\mu\cdot\bm{\mathbf{m}}-\frac{\bm{\mathbf{g}}}{\|\bm{\mathbf{g%
}}\|_{1}}
\hat{\bm{\mathbf{x}}}
\hat{\bm{\mathbf{x}}}=\mathrm{clip}_{\bm{\mathbf{x}},\eta}(\hat{\bm{\mathbf{x}%
}}+\gamma\cdot\bm{\mathbf{m}})
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(%
\hat{\bm{\mathbf{x}}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
y\in\{1,2,...,K\}
p_{\theta}(y|\bm{\mathbf{x}})
\tilde{y}=\operatorname*{arg\,max}_{y}p_{\theta}(y|\bm{\mathbf{x}})
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
t^{*}=0.125
t^{*}=0.1
t
t
\small\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{%
\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]=\frac{\sum_%
{t=1}^{T}\mathbb{E}_{\bm{\mathbf{\epsilon}}}[w_{t}\|\bm{\mathbf{\epsilon}}_{%
\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]}{T}.
\bm{\mathbf{\epsilon}}
\bm{\mathbf{\epsilon}}
K\times T
K
K\times 3
T
O(N\times T)
O(N)
N=5
\mu=1
\eta=8/255
\gamma=0.1
\bm{\mathbf{\epsilon}}
\mathbb{E}_{\bm{\mathbf{\epsilon}}}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm%
{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\ell_{\infty}
\epsilon_{\infty}=8/255
\ell_{2}
\epsilon_{2}=0.5
100
0.05
1/255
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
\ell_{2}
\ell_{\infty}
N
N
N
\eta
\eta
T^{\prime}
T^{\prime}
\eta
T^{\prime}
\eta
T^{\prime}
N
N=1
N=1
69.53\%
0.39\%
\log p(\bm{\mathbf{x}})
\vspace{-1ex}\log p_{\theta}(y|\bm{\mathbf{x}})+l\cdot\mathbb{E}_{\bm{\mathbf{%
\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-%
\bm{\mathbf{\epsilon}}\|_{2}^{2}],
p_{\theta}(y|\bm{\mathbf{x}})
l=0,1,10
\ell_{\infty}
\epsilon_{\infty}=8/255
\eta
\eta
\eta
\eta
\bm{\mathbf{x}}
\eta
\bm{\mathbf{x}}
\eta
\eta=8/255
T^{\prime}
\{i\}_{i=1}^{T^{\prime}}
\{iT/T^{\prime}\}_{i=1}^{T^{\prime}}
T^{\prime}
\bm{\mathbf{\epsilon}}
\mathbb{E}_{\bm{\mathbf{\epsilon}}}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm%
{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\bm{\mathbf{\epsilon}}
\bm{\mathbf{\epsilon}}
T
t
\bm{\mathbf{\epsilon}}
\bm{\mathbf{\epsilon}}
\displaystyle p_{\theta}(y|\bm{\mathbf{x}})=\frac{p_{\theta}(\bm{\mathbf{x}},y%
)}{\sum_{\hat{y}}p_{\theta}(\bm{\mathbf{x}},\hat{y})}
\displaystyle p_{\theta}(y|\bm{\mathbf{x}})
\displaystyle=\frac{p_{\theta}(\bm{\mathbf{x}},y)}{\sum_{\hat{y}}p_{\theta}(%
\bm{\mathbf{x}},\hat{y})}
\displaystyle=\frac{p_{\theta}(\bm{\mathbf{x}}|y)p_{\theta}(y)}{\sum_{y}p_{%
\theta}(\bm{\mathbf{x}}|\hat{y})p_{\theta}(\hat{y})}
\displaystyle=\frac{p_{\theta}(\bm{\mathbf{x}}|y)p_{\theta}(y)}{\sum_{y}p_{%
\theta}(\bm{\mathbf{x}}|\hat{y})p_{\theta}(\hat{y})}
\displaystyle=\frac{p_{\theta}(\bm{\mathbf{x}}|y)}{\sum_{\hat{y}}p_{\theta}(%
\bm{\mathbf{x}}|\hat{y})}
\displaystyle=\frac{p_{\theta}(\bm{\mathbf{x}}|y)}{\sum_{\hat{y}}p_{\theta}(%
\bm{\mathbf{x}}|\hat{y})}
\displaystyle=\frac{e^{\log p_{\theta}(\bm{\mathbf{x}}|y)}}{\sum_{\hat{y}}e^{%
\log p_{\theta}(\bm{\mathbf{x}}|\hat{y})}}
\displaystyle=\frac{e^{\log p_{\theta}(\bm{\mathbf{x}}|y)}}{\sum_{\hat{y}}e^{%
\log p_{\theta}(\bm{\mathbf{x}}|\hat{y})}}
\displaystyle=\frac{\exp\Big{(}\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}%
}\|_{2}^{2}]+\log p_{\theta}(\bm{\mathbf{x}}|y)-\mathbb{E}_{\bm{\mathbf{%
\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}{\sum_{\hat{y}}\exp\Big{(}\mathbb{E}_%
{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{%
x}}_{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2}^{2}]+\log p_{\theta}(\bm{%
\mathbf{x}}|\hat{y})-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2%
}^{2}]\Big{)}}
\displaystyle=\frac{\exp\Big{(}\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}%
}\|_{2}^{2}]+\log p_{\theta}(\bm{\mathbf{x}}|y)-\mathbb{E}_{\bm{\mathbf{%
\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}{\sum_{\hat{y}}\exp\Big{(}\mathbb{E}_%
{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{%
x}}_{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2}^{2}]+\log p_{\theta}(\bm{%
\mathbf{x}}|\hat{y})-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2%
}^{2}]\Big{)}}
\displaystyle=\frac{\exp\Big{(}d(\bm{\mathbf{x}},y,\theta)\Big{)}\exp\Big{(}-%
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}{\sum_{\hat{y}}%
\exp\Big{(}d(\bm{\mathbf{x}},\hat{y},\theta)\Big{)}\exp\Big{(}-\mathbb{E}_{\bm%
{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_%
{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}.
\displaystyle=\frac{\exp\Big{(}d(\bm{\mathbf{x}},y,\theta)\Big{)}\exp\Big{(}-%
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}{\sum_{\hat{y}}%
\exp\Big{(}d(\bm{\mathbf{x}},\hat{y},\theta)\Big{)}\exp\Big{(}-\mathbb{E}_{\bm%
{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_%
{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}.
\forall\hat{y},\;d(\bm{\mathbf{x}},\hat{y},\theta)\to 0
\displaystyle\forall\hat{y},\,\;\exp\Big{(}\mathbb{E}_{\bm{\mathbf{\epsilon}},%
t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,\hat{y})-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}]+\log p_{\theta}(\bm{\mathbf{x}}|\hat{y})\Big{)}%
\to 1.
\displaystyle\forall\hat{y},\,\;\exp\Big{(}\mathbb{E}_{\bm{\mathbf{\epsilon}},%
t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,\hat{y})-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}]+\log p_{\theta}(\bm{\mathbf{x}}|\hat{y})\Big{)}%
\to 1.
p_{\theta}(y|\bm{\mathbf{x}})=\frac{\exp\Big{(}-\mathbb{E}_{\bm{\mathbf{%
\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}{\sum_{\hat{y}}\exp\Big{(}-\mathbb{E}%
_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf%
{x}}_{t},t,\hat{y})-\bm{\mathbf{\epsilon}}\|_{2}^{2}]\Big{)}}.
\mathbb{E}_{\bm{\mathbf{x}},t,y}[\|\bm{\mathbf{\epsilon}}(\bm{\mathbf{x}}_{t},%
t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
(\bm{\mathbf{x}}_{t},t,y)
(\bm{\mathbf{x}}_{t},t,y)
\mathbb{E}_{\bm{\mathbf{x}}^{(i)}\sim p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_%
{t},y)}[\|\bm{\mathbf{\epsilon}}_{\theta_{D}^{*}}(\bm{\mathbf{x}}_{t},t,y)-\bm%
{\mathbf{\epsilon}}_{i}\|_{2}^{2}]=\min_{\theta}\mathbb{E}_{\bm{\mathbf{x}}^{(%
i)}\sim p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)}[\|\bm{\mathbf{\epsilon%
}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}_{i}\|_{2}^{2}],
\bm{\mathbf{\epsilon}}_{i}=\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}^{(i)}}{\sigma_{t}}
p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)=\frac{p(\bm{\mathbf{x}}^{(i)}|y%
)p(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}^{(i)},y)}{p(\bm{\mathbf{x}}_{t}|y)}=%
\frac{p(\bm{\mathbf{x}}^{(i)}|y)q(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}^{(i)})}{%
p(\bm{\mathbf{x}}_{t}|y)}.
\displaystyle p(\bm{\mathbf{x}}^{(i)}|y)=\left\{\begin{array}[]{ll}\frac{1}{|D%
_{y}|}&,\bm{\mathbf{x}}^{(i)}\in D_{y}\\
0&,\bm{\mathbf{x}}^{(i)}\notin D_{y}\end{array}\right.
\displaystyle p(\bm{\mathbf{x}}^{(i)}|y)=\left\{\begin{array}[]{ll}\frac{1}{|D%
_{y}|}&,\bm{\mathbf{x}}^{(i)}\in D_{y}\\
0&,\bm{\mathbf{x}}^{(i)}\notin D_{y}\end{array}\right.
\frac{\partial}{\partial\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,%
y)}\mathbb{E}_{\bm{\mathbf{x}}^{(i)}\sim p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x%
}}_{t},y)}[\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{%
\mathbf{\epsilon}}_{i}\|_{2}^{2}]=0
\displaystyle\mathbb{E}_{\bm{\mathbf{x}}^{(i)}\sim p(\bm{\mathbf{x}}^{(i)}|\bm%
{\mathbf{x}}_{t},y)}[\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\bm{\mathbf{\epsilon}}_{i}]=0,
\displaystyle\mathbb{E}_{\bm{\mathbf{x}}^{(i)}\sim p(\bm{\mathbf{x}}^{(i)}|\bm%
{\mathbf{x}}_{t},y)}[\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\bm{\mathbf{\epsilon}}_{i}]=0,
\displaystyle\sum_{x^{(i)}\in D}p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)=\sum_{\bm{\mathbf{x}}%
^{(i)}\in D_{y}}p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)\bm{\mathbf{%
\epsilon}}_{i}.
\displaystyle\sum_{x^{(i)}\in D}p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)=\sum_{\bm{\mathbf{x}}%
^{(i)}\in D_{y}}p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)\bm{\mathbf{%
\epsilon}}_{i}.
\bm{\mathbf{\epsilon}}_{i}
\displaystyle\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)=\sum_{%
\bm{\mathbf{x}}^{(i)}\in D_{y}}p(\bm{\mathbf{x}}^{(i)}|\bm{\mathbf{x}}_{t},y)%
\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}p(\bm{\mathbf{x}}^{(i)}|\bm%
{\mathbf{x}}_{t},y)\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)q(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}^{(i)})}{p(\bm{\mathbf{x}}_{t}|y)}%
\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)q(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}}^{(i)})}{p(\bm{\mathbf{x}}_{t}|y)}%
\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}p(\mathcal{N}(\bm{\mathbf{x}}_{t}|\sqrt{\alpha%
_{t}}\bm{\mathbf{x}}^{(i)},\sigma_{t}^{2}I)=\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}})\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}p(\mathcal{N}(\bm{\mathbf{x}}_{t}|\sqrt{\alpha%
_{t}}\bm{\mathbf{x}}^{(i)},\sigma_{t}^{2}I)=\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}})\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}\exp{(%
-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}%
{2\sigma_{t}^{2}})}\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{p(\bm{\mathbf{x}}^{(i%
)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}\exp{(%
-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}%
{2\sigma_{t}^{2}})}\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(i)}}{\sigma_{t}}
\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}
\frac{p(\bm{\mathbf{x}}^{(i)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}
\displaystyle\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)=\sum_{%
\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{\frac{p(\bm{\mathbf{x}}^{(i)}|y)}{p(\bm{%
\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}\exp{(-\frac{\|\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{t}^%
{2}})}}{\sum_{j=1}^{|D_{y}|}p(\bm{\mathbf{x}}_{j}|\bm{\mathbf{x}}_{t},y)}\frac%
{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{\sigma_{t}}
\displaystyle\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{\frac{p(\bm{\mathbf{x%
}}^{(i)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}%
\exp{(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2%
}^{2}}{2\sigma_{t}^{2}})}}{\sum_{j=1}^{|D_{y}|}p(\bm{\mathbf{x}}_{j}|\bm{%
\mathbf{x}}_{t},y)}\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(i)}}{\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{\frac{p(\bm{\mathbf{x%
}}^{(i)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}%
\exp{(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2%
}^{2}}{2\sigma_{t}^{2}})}}{\sum_{j=1}^{|D_{y}|}\frac{p(\bm{\mathbf{x}}_{j}|y)}%
{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}\exp{(-\frac%
{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}_{j}\|_{2}^{2}}{2\sigma%
_{t}^{2}})}}\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{%
\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{\frac{p(\bm{\mathbf{x%
}}^{(i)}|y)}{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}%
\exp{(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2%
}^{2}}{2\sigma_{t}^{2}})}}{\sum_{j=1}^{|D_{y}|}\frac{p(\bm{\mathbf{x}}_{j}|y)}%
{p(\bm{\mathbf{x}}_{t}|y)}\frac{1}{(2\pi\sigma_{t})^{\frac{n}{2}}}\exp{(-\frac%
{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}_{j}\|_{2}^{2}}{2\sigma%
_{t}^{2}})}}\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}}{%
\sigma_{t}}
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{1}{\sigma_{t}}(\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)})\frac{\exp(-\frac{1}{2%
\sigma_{t}^{2}}\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_%
{2}^{2})}{\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp(-\frac{1}{2\sigma_{t}^{2}}%
\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(j)}\|_{2}^{2})}.
\displaystyle=\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}\frac{1}{\sigma_{t}}(\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)})\frac{\exp(-\frac{1}{2%
\sigma_{t}^{2}}\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_%
{2}^{2})}{\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp(-\frac{1}{2\sigma_{t}^{2}}%
\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(j)}\|_{2}^{2})}.
\displaystyle f_{\theta_{D}^{*}}(\bm{\mathbf{x}})_{y}
\displaystyle f_{\theta_{D}^{*}}(\bm{\mathbf{x}})_{y}
\displaystyle=-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\bm{\mathbf{\epsilon}}_%
{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=
\displaystyle-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\bm{\mathbf{\epsilon}}_{%
\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{%
(i)}\in D_{y}}[\frac{(\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i%
)})}{\sigma_{t}}\frac{\exp(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{t}^{2}})}{\sum_{\bm{\mathbf{x}}^{(j)}\in
D%
_{y}}\exp(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(j)}%
\|_{2}^{2}}{2\sigma_{t}^{2}})}]-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=
\displaystyle-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{(%
i)}\in D_{y}}[\frac{(\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)%
})}{\sigma_{t}}\frac{\exp(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{t}^{2}})}{\sum_{\bm{\mathbf{x}}^{(j)}\in
D%
_{y}}\exp(-\frac{\|\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(j)}%
\|_{2}^{2}}{2\sigma_{t}^{2}})}]-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{%
(i)}\in D_{y}}[\frac{(\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{%
\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)})}{\sigma_{t}}\frac{\exp\left%
(-\frac{\|\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-%
\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}{%
\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp\left(-\frac{\|\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(j)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}]-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=
\displaystyle-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{(%
i)}\in D_{y}}[\frac{(\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{%
\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)})}{\sigma_{t}}\frac{\exp\left%
(-\frac{\|\sqrt{\alpha_{t}}\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-%
\sqrt{\alpha_{t}}\bm{\mathbf{x}}^{(i)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}{%
\sum_{\bm{\mathbf{x}}^{(j)}\in D_{y}}\exp\left(-\frac{\|\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}^%
{(j)}\|_{2}^{2}}{2\sigma_{t}^{2}}\right)}]-\bm{\mathbf{\epsilon}}\|_{2}^{2}]
\displaystyle=-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{%
(i)}\in D_{y}}[\frac{1}{\sigma_{t}}(\sqrt{\alpha_{t}}\bm{\mathbf{x}}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)})s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{%
\mathbf{\epsilon}},t)+\bm{\mathbf{\epsilon}}\sum_{\bm{\mathbf{x}}^{(i)}\in D_{%
y}}s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{\epsilon}},t)]
\displaystyle=
\displaystyle-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{(%
i)}\in D_{y}}[\frac{1}{\sigma_{t}}(\sqrt{\alpha_{t}}\bm{\mathbf{x}}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)})s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{%
\mathbf{\epsilon}},t)+\bm{\mathbf{\epsilon}}\sum_{\bm{\mathbf{x}}^{(i)}\in D_{%
y}}s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{\mathbf{\epsilon}},t)]
\displaystyle=-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{%
(i)}\in D_{y}}[\frac{1}{\sigma_{t}}(\sqrt{\alpha_{t}}\bm{\mathbf{x}}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)})s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{%
\mathbf{\epsilon}},t)]\|_{2}^{2}]
\displaystyle=
\displaystyle-\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}[\|\sum_{\bm{\mathbf{x}}^{(%
i)}\in D_{y}}[\frac{1}{\sigma_{t}}(\sqrt{\alpha_{t}}\bm{\mathbf{x}}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}^{(i)})s(\bm{\mathbf{x}},\bm{\mathbf{x}}^{(i)},\bm{%
\mathbf{\epsilon}},t)]\|_{2}^{2}]
\displaystyle=-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[\frac{\alpha_{t}}{\sigma_%
{t}^{2}}\|\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}s(\bm{\mathbf{x}},\bm{\mathbf{x%
}}^{(i)},\bm{\mathbf{\epsilon}},t)(\bm{\mathbf{x}}-\bm{\mathbf{x}}^{(i)})\|_{2%
}^{2}].
\displaystyle=
\displaystyle-\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[\frac{\alpha_{t}}{\sigma_{%
t}^{2}}\|\sum_{\bm{\mathbf{x}}^{(i)}\in D_{y}}s(\bm{\mathbf{x}},\bm{\mathbf{x}%
}^{(i)},\bm{\mathbf{\epsilon}},t)(\bm{\mathbf{x}}-\bm{\mathbf{x}}^{(i)})\|_{2}%
^{2}].
\displaystyle\log p_{\theta}(\bm{\mathbf{x}}_{0}|y)
\displaystyle\log p_{\theta}(\bm{\mathbf{x}}_{0}|y)
\displaystyle=\log\int\frac{p_{\theta}(\bm{\mathbf{x}}_{0:T}|y)q(\bm{\mathbf{x%
}}_{1:T}|\bm{\mathbf{x}}_{0},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y%
)}d\bm{\mathbf{x}}_{1:T}
\displaystyle=
\displaystyle\log\int\frac{p_{\theta}(\bm{\mathbf{x}}_{0:T}|y)q(\bm{\mathbf{x}%
}_{1:T}|\bm{\mathbf{x}}_{0},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)%
}d\bm{\mathbf{x}}_{1:T}
\displaystyle=\log\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)p_{\theta}(\bm{\mathbf{x}}_{0:{T-1}}|%
\bm{\mathbf{x}}_{T},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}]
\displaystyle=
\displaystyle\log\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)p_{\theta}(\bm{\mathbf{x}}_{0:{T-1}}|%
\bm{\mathbf{x}}_{T},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}]
\displaystyle\geq\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[%
\log\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)p_{\theta}(\bm{\mathbf{x}}_{0:{T-1}%
}|\bm{\mathbf{x}}_{T},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}]
\displaystyle\geq
\displaystyle\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)p_{\theta}(\bm{\mathbf{x}}_{0:{T-1}}|%
\bm{\mathbf{x}}_{T},y)}{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}]
\displaystyle=\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i+1}|%
\bm{\mathbf{x}}_{i},\bm{\mathbf{x}}_{0},y)}]
\displaystyle=
\displaystyle\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i+1}|%
\bm{\mathbf{x}}_{i},\bm{\mathbf{x}}_{0},y)}]
\displaystyle=\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}\frac{q(\bm{\mathbf{x}}_{i%
+1}|\bm{\mathbf{x}}_{0},y)q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{%
\mathbf{x}}_{0},y)}{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{0},y)}}]
\displaystyle=
\displaystyle\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}\frac{q(\bm{\mathbf{x}}_{i%
+1}|\bm{\mathbf{x}}_{0},y)q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{%
\mathbf{x}}_{0},y)}{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{0},y)}}]
\displaystyle=\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i}|\bm{%
\mathbf{x}}_{i+1},\bm{\mathbf{x}}_{0},y)}-\log q(\bm{\mathbf{x}}_{T}|\bm{%
\mathbf{x}}_{0},y)]
\displaystyle=
\displaystyle\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{p_{\theta}(\bm{\mathbf{x}}_{T}|y)\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf%
{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i}|\bm{%
\mathbf{x}}_{i+1},\bm{\mathbf{x}}_{0},y)}-\log q(\bm{\mathbf{x}}_{T}|\bm{%
\mathbf{x}}_{0},y)]
\displaystyle=\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)%
}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{x}}%
_{0},y)}-\log\frac{q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)}{p_{\theta}(%
\bm{\mathbf{x}}_{T}|y)}]
\displaystyle=
\displaystyle\mathbb{E}_{q(\bm{\mathbf{x}}_{1:T}|\bm{\mathbf{x}}_{0},y)}[\log%
\frac{\prod_{i=0}^{T-1}p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)%
}{\prod_{i=0}^{T-1}q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{x}}%
_{0},y)}-\log\frac{q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)}{p_{\theta}(%
\bm{\mathbf{x}}_{T}|y)}]
\displaystyle=\sum_{i=0}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i},\bm{\mathbf{x}%
}_{i+1}|\bm{\mathbf{x}}_{0},y)}[\log\frac{p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{%
\mathbf{x}}_{i+1},y)}{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{%
x}}_{0},y)}]-D_{KL}(q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)\|p_{\theta}(%
\bm{\mathbf{x}}_{T}|y))
\displaystyle=
\displaystyle\sum_{i=0}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i},\bm{\mathbf{x}}%
_{i+1}|\bm{\mathbf{x}}_{0},y)}[\log\frac{p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{%
\mathbf{x}}_{i+1},y)}{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{%
x}}_{0},y)}]-D_{KL}(q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)\|p_{\theta}(%
\bm{\mathbf{x}}_{T}|y))
\displaystyle=\sum_{i=0}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i+1}|\bm{\mathbf{%
x}}_{0},y)}\mathbb{E}_{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf%
{x}}_{0},y)}[\log\frac{p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)%
}{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{x}}_{0},y)}]-D_{KL}(%
q(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)\|p_{\theta}(\bm{\mathbf{x}}_{T}|y))
\displaystyle=
\displaystyle\sum_{i=0}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i+1}|\bm{\mathbf{x%
}}_{0},y)}\mathbb{E}_{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{%
x}}_{0},y)}[\log\frac{p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y)}%
{q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{\mathbf{x}}_{0},y)}]-D_{KL}(q%
(\bm{\mathbf{x}}_{T}|\bm{\mathbf{x}}_{0},y)\|p_{\theta}(\bm{\mathbf{x}}_{T}|y))
\displaystyle=C_{4}-\sum_{i=1}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i+1}|\bm{%
\mathbf{x}}_{0},y)}[D_{KL}(q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{%
\mathbf{x}}_{0},y)\|p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y))]
\displaystyle=
\displaystyle C_{4}-\sum_{i=1}^{T-1}\mathbb{E}_{q(\bm{\mathbf{x}}_{i+1}|\bm{%
\mathbf{x}}_{0},y)}[D_{KL}(q(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},\bm{%
\mathbf{x}}_{0},y)\|p_{\theta}(\bm{\mathbf{x}}_{i}|\bm{\mathbf{x}}_{i+1},y))]
\displaystyle=-\mathbb{\mathbb{E}}_{\bm{\mathbf{\epsilon}},t}\left[w_{t}\|\bm{%
\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_%
{2}^{2}\right]+C.
\displaystyle=
\displaystyle-\mathbb{\mathbb{E}}_{\bm{\mathbf{\epsilon}},t}\left[w_{t}\|\bm{%
\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_%
{2}^{2}\right]+C.
p_{\theta}(\bm{\mathbf{x}})
p_{\theta}(\bm{\mathbf{x}}|y)
p_{\theta}(\bm{\mathbf{x}}|y)=\frac{\exp(-E_{\theta}(\bm{\mathbf{x}})_{y})}{Z(%
\theta,y)},
E_{\theta}(\bm{\mathbf{x}}):R^{D}\to R^{n}
Z(\theta,y)=\int\exp(-E_{\theta}(\bm{\mathbf{x}})_{y})d\bm{\mathbf{x}}
p_{\theta}(y|\bm{\mathbf{x}})=\frac{\exp(-E_{\theta}(\bm{\mathbf{x}})_{y})}{%
\sum_{\hat{y}}\exp(-E_{\theta}(\bm{\mathbf{x}})_{\hat{y}})}.
E_{\theta}(\bm{\mathbf{x}})_{y}\approx\mathbb{E}_{t,\bm{\mathbf{\epsilon}}}%
\left[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{%
\mathbf{\epsilon}}\|_{2}^{2}\right].
\bm{\mathbf{z}}\sim\mathcal{N}(\bm{\mathbf{\mu}},\bm{\mathbf{\Sigma}}),\;f:%
\mathbb{R}^{n_{i}}\to\mathbb{R}^{n_{o}}\in\mathcal{C}^{1},\,\;p:\mathbb{R}^{n_%
{i}}\to\mathbb{R}\in\mathcal{C}^{1}
\nabla_{\bm{\mathbf{\mu}}}\mathbb{E}_{\bm{\mathbf{z}}}[f(\bm{\mathbf{z}})]=%
\mathbb{E}_{\bm{\mathbf{z}}}[\nabla_{\bm{\mathbf{\mu}}}\log p(\bm{\mathbf{z}})%
f(\bm{\mathbf{z}})^{T}].
\displaystyle\nabla_{\bm{\mathbf{\mu}}}E[f(\bm{\mathbf{z}})]=\nabla_{\bm{%
\mathbf{\mu}}}\int f(\bm{\mathbf{z}})p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})d\bm{%
\mathbf{z}}
\displaystyle\nabla_{\bm{\mathbf{\mu}}}E[f(\bm{\mathbf{z}})]
\displaystyle=\nabla_{\bm{\mathbf{\mu}}}\int f(\bm{\mathbf{z}})p(\bm{\mathbf{z%
}}|\bm{\mathbf{\mu}})d\bm{\mathbf{z}}
\displaystyle=\lim_{d\bm{\mathbf{\mu}}\to\bm{\mathbf{0}}}\frac{\int f(\bm{%
\mathbf{z}})p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}}+d\bm{\mathbf{\mu}})d\bm{%
\mathbf{z}}-\int f(\bm{\mathbf{z}})p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})d\bm{%
\mathbf{z}}}{d\bm{\mathbf{\mu}}}
\displaystyle=\lim_{d\bm{\mathbf{\mu}}\to\bm{\mathbf{0}}}\frac{\int f(\bm{%
\mathbf{z}})p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}}+d\bm{\mathbf{\mu}})d\bm{%
\mathbf{z}}-\int f(\bm{\mathbf{z}})p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})d\bm{%
\mathbf{z}}}{d\bm{\mathbf{\mu}}}
\displaystyle=\int\nabla_{\bm{\mathbf{\mu}}}p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}%
})f(\bm{\mathbf{z}})^{T}d\bm{\mathbf{z}}
\displaystyle=\int\nabla_{\bm{\mathbf{\mu}}}p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}%
})f(\bm{\mathbf{z}})^{T}d\bm{\mathbf{z}}
\displaystyle=\int p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})\nabla_{\bm{\mathbf{\mu%
}}}\log p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})f(\bm{\mathbf{z}})^{T}d\bm{\mathbf%
{z}}
\displaystyle=\int p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})\nabla_{\bm{\mathbf{\mu%
}}}\log p(\bm{\mathbf{z}}|\bm{\mathbf{\mu}})f(\bm{\mathbf{z}})^{T}d\bm{\mathbf%
{z}}
\displaystyle=\mathbb{E}_{z}[\nabla_{\bm{\mathbf{\mu}}}\log p(\bm{\mathbf{z}}|%
\bm{\mathbf{\mu}})f(\bm{\mathbf{z}})^{T}].
\displaystyle=\mathbb{E}_{z}[\nabla_{\bm{\mathbf{\mu}}}\log p(\bm{\mathbf{z}}|%
\bm{\mathbf{\mu}})f(\bm{\mathbf{z}})^{T}].
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}%
\|_{2}^{2}]
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}%
\|_{2}^{2}]
\displaystyle=\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\|\bm%
{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{\mathbf{x}}_{t}-%
\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]
\displaystyle=
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\|\bm{%
\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{\mathbf{x}}_{t}-%
\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]
\displaystyle=\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[g(\bm%
{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[g(\bm{%
\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=\frac{\partial}{\partial\bm{\mathbf{x}}_{t}}\mathbb{E}_{\bm{%
\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]\frac{\partial\bm{%
\mathbf{x}}_{t}}{\partial\bm{\mathbf{x}}}+\frac{\partial}{\partial\bm{\mathbf{%
x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=
\displaystyle\frac{\partial}{\partial\bm{\mathbf{x}}_{t}}\mathbb{E}_{\bm{%
\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]\frac{\partial\bm{%
\mathbf{x}}_{t}}{\partial\bm{\mathbf{x}}}+\frac{\partial}{\partial\bm{\mathbf{%
x}}}\mathbb{E}_{\bm{\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}g(\bm{\mathbf{x}}_{t%
},\bm{\mathbf{x}},t)]+\frac{\partial}{\partial\bm{\mathbf{x}}}\mathbb{E}_{\bm{%
\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=
\displaystyle\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{\mathbf%
{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}g(\bm{\mathbf{x}}_{t},\bm{%
\mathbf{x}},t)]+\frac{\partial}{\partial\bm{\mathbf{x}}}\mathbb{E}_{\bm{%
\mathbf{x}}_{t}}[g(\bm{\mathbf{x}}_{t},\bm{\mathbf{x}},t)]
\displaystyle=\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]+\mathbb{E}_{\bm{\mathbf{x}}%
_{t}}[2(\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}})\frac{\sqrt{%
\alpha_{t}}}{\sigma_{t}}]
\displaystyle=
\displaystyle\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{\mathbf%
{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{\epsilon}}_{%
\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{%
\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]+\mathbb{E}_{\bm{\mathbf{x}}_{t}}[2(\bm{%
\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\frac{\bm{\mathbf{x}}_{t}-%
\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}})\frac{\sqrt{\alpha_{t}}}{\sigma_%
{t}}]
\displaystyle=\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]+%
\mathbb{E}_{\bm{\mathbf{\epsilon}}}[(\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}})\frac{2\sqrt{\alpha_{t}}}{\sigma_{t}%
}].
\displaystyle=
\displaystyle\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]+%
\mathbb{E}_{\bm{\mathbf{\epsilon}}}[(\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t)-\bm{\mathbf{\epsilon}})\frac{2\sqrt{\alpha_{t}}}{\sigma_{t}%
}].
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}%
}\|_{2}^{2}]
\displaystyle\frac{d}{d\bm{\mathbf{x}}}\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\|%
\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}%
}\|_{2}^{2}]
\displaystyle=\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\frac{\bm{\mathbf{x}}_{t}-\sqrt{%
\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]+\mathbb{E}_{\bm{\mathbf{x}}%
_{t}}[(\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\frac{\bm{%
\mathbf{x}}_{t}-\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}})\frac{2\sqrt{%
\alpha_{t}}}{\sigma_{t}}]
\displaystyle=
\displaystyle\mathbb{E}_{\bm{\mathbf{x}}_{t}}[\frac{\partial\log p(\bm{\mathbf%
{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{\epsilon}}_{%
\theta}(\bm{\mathbf{x}}_{t},t,y)-\frac{\bm{\mathbf{x}}_{t}-\sqrt{\alpha_{t}}%
\bm{\mathbf{x}}}{\sigma_{t}}\|_{2}^{2}]+\mathbb{E}_{\bm{\mathbf{x}}_{t}}[(\bm{%
\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\frac{\bm{\mathbf{x}}_{t}%
-\sqrt{\alpha_{t}}\bm{\mathbf{x}}}{\sigma_{t}})\frac{2\sqrt{\alpha_{t}}}{%
\sigma_{t}}]
\displaystyle=\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]%
+\mathbb{E}_{\bm{\mathbf{\epsilon}}}[(\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}})\frac{2\sqrt{\alpha_{t}}}{\sigma_{%
t}}].
\displaystyle=
\displaystyle\mathbb{E}_{\bm{\mathbf{\epsilon}}}[\frac{\partial\log p(\bm{%
\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf{x}}}\|\bm{\mathbf{%
\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}}\|_{2}^{2}]%
+\mathbb{E}_{\bm{\mathbf{\epsilon}}}[(\bm{\mathbf{\epsilon}}_{\theta}(\bm{%
\mathbf{x}}_{t},t,y)-\bm{\mathbf{\epsilon}})\frac{2\sqrt{\alpha_{t}}}{\sigma_{%
t}}].
\frac{\partial\log p(\bm{\mathbf{x}}_{t}|\bm{\mathbf{x}})}{\partial\bm{\mathbf%
{x}}}
\bm{\mathbf{x}}_{t}=\bm{\mathbf{x}}+\sigma_{t}\bm{\mathbf{\epsilon}}
\bm{\mathbf{x}}-\bm{\mathbf{x}}_{t}
\bm{\mathbf{x}}_{t}
\bm{\mathbf{x}}
\bm{\mathbf{x}}
\times
\times
O(K\times T)
O(T)
(1+\text{cfg})\cdot\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-%
\text{cfg}\cdot\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t)
\bm{\mathbf{\epsilon}}_{\theta}
\mathcal{D}
\bm{\mathbf{\epsilon}}_{\phi}
\bm{\mathbf{x}}_{0},y\sim D
t\sim
\{1,2,...,T\}
\bm{\mathbf{\epsilon}}\sim\mathcal{N}(\bm{\mathbf{0}},\bm{\mathbf{I}})
y=0
K-1
\nabla_{\phi}\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[w_{t}\|\bm{\mathbf{\epsilon%
}}_{\theta}(\hat{\bm{\mathbf{x}}}_{t},t,y)-\bm{\mathbf{\epsilon}}_{\phi}(\hat{%
\bm{\mathbf{x}}}_{t},t,y)\|_{2}^{2}]
\bm{\mathbf{x}}_{t}
y
(\bm{\mathbf{x}}_{t},t,y)
p(\bm{\mathbf{x}}_{t},t,y)=\int p(\bm{\mathbf{x}}|y)p(t)p(\bm{\mathbf{x}}_{t}|%
\bm{\mathbf{x}})p(y)d\bm{\mathbf{x}}
\ell_{\infty}
\ell_{2}
\ell_{\infty}
1
\ell_{2}
1
\ell_{\infty}
1
\ell_{2}
1
1
t^{*}=0.125
126
t^{*}=0.1
101
30TK
1
1
9
KN
KN
1+NT
1+N
TK
NT+TK
N+TK
N+T
\frac{1}{D}\|g\|_{1}
7.7\times 10^{-6}
1.1\times 10^{-5}
6.6\times 10^{-6}
9.8\times 10^{-6}
8.2\times 10^{-6}
\frac{1}{D}\|g\|_{1}
\ell_{\infty}
\epsilon_{\infty}=8/255
\ell_{\infty}
\epsilon_{\infty}=8/255
N
K
K
\ell_{\infty}
\ell_{2}
1+NT
1+N
1+NT
1+NT
1+N
N=1
1+NT
\mathbb{E}_{\bm{\mathbf{\epsilon}}}[f(\bm{\mathbf{x}}+\nabla_{\bm{\mathbf{x}}}%
\mathbb{E}_{t}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)%
-\bm{\mathbf{\epsilon}}\|_{2}^{2}])]
1+N
\mathbb{E}_{\bm{\mathbf{\epsilon}},t}[f(\bm{\mathbf{x}}+\nabla_{\bm{\mathbf{x}%
}}[w_{t}\|\bm{\mathbf{\epsilon}}_{\theta}(\bm{\mathbf{x}}_{t},t,y)-\bm{\mathbf%
{\epsilon}}\|_{2}^{2}])]
T
1+N
f
t
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
\ell_{\infty}
\ell_{2}
\ell_{2}
\ell_{\infty}
\epsilon_{\infty}=8/255
\ell_{\infty}
\epsilon_{\infty}=4/255
\ell_{\infty}
\epsilon_{\infty}=8/255
N+T
T
