\mathcal{M}_{G}
\mathcal{M}=\langle\mathcal{S},\mathcal{A},\mathcal{P},R,\gamma\rangle
\langle\mathcal{G},p_{g},\Phi\rangle
\mathcal{M}_{G}
\mathcal{S}
\mathcal{A}
\mathcal{P}:\mathcal{S}\times\mathcal{A}\times\mathcal{S}\rightarrow[0,1]
\gamma
R:\mathcal{S}\times\mathcal{A}\times\mathcal{G}\rightarrow\mathbb{R}
R:\mathcal{S}\times\mathcal{A}\times\mathcal{G}\rightarrow\mathbb{R}
R(s,a,g)=\mathds{1}{(}\Phi(s^{\prime}\sim\mathcal{P}(\cdot|s,a))=g)
\Phi:\mathcal{S}\rightarrow\mathcal{G}
s
g\in\mathcal{G}
\pi:\mathcal{S}\times\mathcal{G}\times\mathcal{A}\rightarrow[0,1]
\operatorname*{\mathbb{E}}_{g\sim p_{g}}\left[\sum_{t=0}^{T-1}\gamma^{t}R(s_{t%
},a_{t}\sim\pi(\cdot|s_{t},g),g)\right].
H
z
H
\tau^{\text{sub}}
\displaystyle\tau_{t:t+H}=(s_{t},\dots,s_{t+H},a_{t},\dots,a_{t+H-1})=(s_{0:H}%
,a_{0:H-1})
\displaystyle\tau_{t:t+H}
\displaystyle=(s_{t},\dots,s_{t+H},a_{t},\dots,a_{t+H-1})=(s_{0:H},a_{0:H-1})
\tau
\mathcal{L}_{\text{skill}}
\displaystyle\operatorname*{\mathbb{E}}_{\tau^{\text{sub}}\sim\tau}\Bigg{[}%
\sum_{i=0}^{H-1}\underbrace{(\pi_{\theta}^{L}\left(s_{i},z\right)-a_{i})^{2}}_%
{\text{action reconstruction}}+\underbrace{\beta\cdot KL(q_{\phi}(z|\tau^{%
\text{sub}})||P(z))}_{\text{regularization}}\Bigg{]}
\displaystyle\operatorname*{\mathbb{E}}_{\tau^{\text{sub}}\sim\tau}\Bigg{[}
\displaystyle\sum_{i=0}^{H-1}\underbrace{(\pi_{\theta}^{L}\left(s_{i},z\right)%
-a_{i})^{2}}_{\text{action reconstruction}}+\underbrace{\beta\cdot KL(q_{\phi}%
(z|\tau^{\text{sub}})||P(z))}_{\text{regularization}}\Bigg{]}
KL
P(z)\sim\mathcal{N}(0,I)
q_{\phi}
z
\pi_{\theta}^{L}
\pi(a|s,g)
\pi_{\theta}^{L}(a|s,z)
\pi_{\psi}^{Z}(z|s,g)
\pi(a|s,g)=\pi_{\theta}^{L}(a|s,z)\circ\pi_{\psi}^{Z}(z|s,g).
\pi_{\psi}^{Z}
p_{\theta}
\pi_{\theta}^{L},\pi_{\psi}^{Z}
p_{\theta}
\displaystyle\operatorname*{\mathbb{E}}_{g\sim p_{g}}\Bigg{[}\sum^{T-1}_{t=0}%
\Bigg{[}\sum_{k=tH}^{(t+1)H-1}\left[R(s_{k},a_{k}\sim\pi_{\theta}^{L}(\cdot|s_%
{k},z_{tH}),g)\right]
\displaystyle\operatorname*{\mathbb{E}}_{g\sim p_{g}}\Bigg{[}\sum^{T-1}_{t=0}%
\Bigg{[}
\displaystyle\sum_{k=tH}^{(t+1)H-1}\left[R(s_{k},a_{k}\sim\pi_{\theta}^{L}(%
\cdot|s_{k},z_{tH}),g)\right]
\displaystyle-KL(\pi_{\psi}^{Z}(z_{tH}|s_{tH},g)||p_{\theta}(z_{tH}|s_{tH}))%
\Bigg{]}\Bigg{]}
\displaystyle-KL(\pi_{\psi}^{Z}(z_{tH}|s_{tH},g)||p_{\theta}(z_{tH}|s_{tH}))%
\Bigg{]}\Bigg{]}
z_{tH}\sim\pi_{\psi}^{Z}(\cdot|s_{tH},g)
H
\pi_{\theta}^{L}
\pi_{\psi}^{Z}
\mathcal{P}_{\theta}^{-1}
\mathcal{P}_{\theta}
\mathcal{P}_{\phi}
q_{\phi}
p_{\theta}
E_{\theta}
D_{\phi}
\psi
\theta
\phi
q_{\phi}
D_{\phi}
\beta
z
q_{\phi}
\tau^{\text{sub}}
z
\pi_{\theta}^{L}
z
B=\{\tau^{\text{sub}}_{i}\}_{i=1}^{N}
\mathcal{D}
p_{\theta}
\mathcal{L}_{\text{prior}}
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\left[KL(p_{\theta}(%
z|\textbf{h}_{t})\>||\>\textbf{sg}(q_{\phi}(z|\tau^{\text{sub}})))\right]
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\left[KL(p_{\theta}(%
z|\textbf{h}_{t})\>||\>\textbf{sg}(q_{\phi}(z|\tau^{\text{sub}})))\right]
\textbf{h}_{t}=\textbf{sg}(E_{\theta}(s_{t}))
s_{t}
\tau^{\text{sub}}
p_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\phi}
E_{\theta}
\mathbb{H}
D_{\phi}
\mathcal{P}_{\phi}
\mathcal{P}_{\theta}
H
\mathcal{P}_{\theta}^{-1}
h_{0}
h_{H}
\mathcal{L}_{\text{model}}
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\Big{[}\sum_{k=0}^{H%
-1}\big{[}\underbrace{(D_{\phi}(h_{t+k})-s_{t+k})^{2}}_{\text{observation %
reconstruction}}+\underbrace{(\mathcal{P}_{\phi}(h_{t+k},z)-\bar{h}_{t+k+1})^{%
2}}_{\text{flat dynamics}}\big{]}
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\Big{[}\sum_{k=0}^{H%
-1}\big{[}\underbrace{(D_{\phi}(h_{t+k})-s_{t+k})^{2}}_{\text{observation %
reconstruction}}+\underbrace{(\mathcal{P}_{\phi}(h_{t+k},z)-\bar{h}_{t+k+1})^{%
2}}_{\text{flat dynamics}}\big{]}
\displaystyle+\underbrace{(\mathcal{P}_{\theta}(h_{t},z)-\bar{h}_{t+H})^{2}}_{%
\text{skill-step dynamics}}+\underbrace{KL(\textbf{sg}(z)\>||\>\mathcal{P}_{%
\theta}^{-1}(z|\textbf{h}_{t},\textbf{h}_{t+H}))}_{\text{inverse skill-step %
dynamics}}\Big{]}
\displaystyle+\underbrace{(\mathcal{P}_{\theta}(h_{t},z)-\bar{h}_{t+H})^{2}}_{%
\text{skill-step dynamics}}+\underbrace{KL(\textbf{sg}(z)\>||\>\mathcal{P}_{%
\theta}^{-1}(z|\textbf{h}_{t},\textbf{h}_{t+H}))}_{\text{inverse skill-step %
dynamics}}\Big{]}
h_{t}=E_{\theta}(s_{t})
\bar{h}_{t}=E_{\bar{\theta}}(s_{t})
\bar{\theta}
\theta
z=q_{\phi}(\tau^{\text{sub}})
q_{\phi}
(h\in\mathbb{H})
p_{\theta}
\mathcal{P}_{\phi}
h
z
(s,a)
D_{\phi}
\pi_{\theta}^{L}
\pi_{\psi}^{Z}
\pi_{\theta}^{L}
f_{\psi}
\mathcal{P}_{\theta}^{-1}
\pi_{\psi}^{Z}(s_{t},g)=\mathcal{P}_{\theta}^{-1}(z|\textbf{h}_{t},\hat{h}_{t+%
H})\circ f_{\psi}(\hat{h}_{t+H}|\textbf{h}_{t},g)\circ E_{\theta}(h_{t}|s_{t}).
s_{t}
g
\hat{h}_{t+H}
z
\pi_{\theta}^{L}
z
\mathcal{P}_{\theta}^{-1}
f_{\psi}
\mathcal{L}_{\text{sg}}
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\bigg{[}\underbrace{%
\left(\bar{h}_{t+H}-f_{\psi}(\textbf{h}_{t},g)\right)^{2}}_{\text{behavior %
cloning}}+\underbrace{\left(f_{\psi}(\textbf{h}_{t},g)-\mathcal{P}_{\theta}(%
\textbf{h}_{t},\hat{z})\right)^{2}}_{\text{sanity check}}\bigg{]}
\displaystyle\operatorname*{\mathbb{E}}_{B\sim\mathcal{D}}\bigg{[}\underbrace{%
\left(\bar{h}_{t+H}-f_{\psi}(\textbf{h}_{t},g)\right)^{2}}_{\text{behavior %
cloning}}+\underbrace{\left(f_{\psi}(\textbf{h}_{t},g)-\mathcal{P}_{\theta}(%
\textbf{h}_{t},\hat{z})\right)^{2}}_{\text{sanity check}}\bigg{]}
\bar{h}_{t+H}=E_{\bar{\theta}}(s_{t+H})
\hat{z}\sim\mathcal{P}_{\theta}^{-1}(\cdot|\textbf{h}_{t},f_{\psi}(h_{t},g))
\mathcal{L}=\mathcal{L}_{\text{skill}}\ +\mathcal{L}_{\text{prior}}+\mathcal{L%
}_{\text{model}}+\mathcal{L}_{\text{sg}}
f_{\psi}
f_{\psi}
\displaystyle\mathbb{E}_{B^{\prime}}\bigg{[}\underbrace{-Q(\textbf{h}_{t},\pi_%
{\psi}^{Z}(\textbf{h}_{t},g))}_{\text{reward maximization}}+\alpha\cdot%
\underbrace{KL(\pi_{\psi}^{Z}(z|\textbf{h}_{t},g)||p_{\theta}(z|\textbf{h}_{t}%
))}_{\text{prior regularization}}
\displaystyle\mathbb{E}_{B^{\prime}}\bigg{[}
\displaystyle\underbrace{-Q(\textbf{h}_{t},\pi_{\psi}^{Z}(\textbf{h}_{t},g))}_%
{\text{reward maximization}}+\alpha\cdot\underbrace{KL(\pi_{\psi}^{Z}(z|%
\textbf{h}_{t},g)||p_{\theta}(z|\textbf{h}_{t}))}_{\text{prior regularization}}
\displaystyle+\underbrace{\left(\mathcal{P}_{\theta}(h_{t+H}|\textbf{h}_{t},%
\pi_{\psi}^{Z}(\textbf{h}_{t},g))-f_{\psi}(h_{t+H}|\textbf{h}_{t},g)\right)^{2%
}}_{\text{state consistency regularization}}\bigg{]}
\displaystyle+\underbrace{\left(\mathcal{P}_{\theta}(h_{t+H}|\textbf{h}_{t},%
\pi_{\psi}^{Z}(\textbf{h}_{t},g))-f_{\psi}(h_{t+H}|\textbf{h}_{t},g)\right)^{2%
}}_{\text{state consistency regularization}}\bigg{]}
\textbf{h}_{t}=\textbf{sg}(E_{\theta}(s_{t}))
B^{\prime}
(s_{t},z,s_{t+H})
f_{\psi}(h_{t+H}|\textbf{h}_{t},g)
\theta
\phi
f_{\psi}
\begin{cases}\mathbb{I}\left[(\Phi(s)-g)^{2}\leq 1\right]\times 100&\text{for %
maze},\\
(\text{achieved\_obj}/\text{target\_obj})\times 100&\text{for kitchen}\end{cases}
\Phi
s
g
73.7\pm 2.0
46.2\pm 4.1
23.4\pm 6.4
98.8\pm 1.1
\textbf{100.0}\pm\textbf{0.0}
33.3\pm 4.0
15.2\pm 10.9
26.9\pm 3.0
74.9\pm 1.1
\textbf{89.5}\pm\textbf{2.0}
12.6\pm 5.2
14.4\pm 3.6
23.2\pm 5.2
74.0\pm 2.5
\textbf{84.2}\pm\textbf{7.3}
5.3\pm 3.9
1.3\pm 1.3
15.8\pm 3.9
32.5\pm 8.7
\textbf{66.7}\pm\textbf{7.0}
35.9\pm 4.8
69.6\pm 1.1
49.1\pm 2.5
66.6\pm 7.5
\textbf{98.7}\pm\textbf{1.3}
0.0\pm 0.0
44.7\pm 1.8
26.2\pm 8.5
54.8\pm 5.7
\textbf{88.6}\pm\textbf{1.3}
0.2\pm 0.2
31.4\pm 0.8
31.2\pm 1.7
47.7\pm 4.3
\textbf{86.8}\pm\textbf{1.7}
0.4\pm 0.2
18.3\pm 1.0
28.7\pm 7.0
41.7\pm 5.2
\textbf{72.2}\pm\textbf{3.4}
14.6
20.2
34.2
33.8
39.1
30.5
7.5\pm 5.2
16.2\pm 12.0
\textbf{67.1}\pm\textbf{14.4}
3.9\pm 0.0
15.8\pm 6.5
\textbf{74.1}\pm\textbf{5.7}
15.8\pm 15.5
40.8\pm 15.5
\textbf{73.7}\pm\textbf{5.7}
46.1\pm 27.8
61.0\pm 11.9
\textbf{76.3}\pm\textbf{5.5}
23.4\pm 1.7
18.6\pm 5.4
\textbf{68.0}\pm\textbf{5.9}
24.4\pm 2.9
20.3\pm 2.5
\textbf{78.4}\pm\textbf{4.2}
22.8\pm 3.1
34.8\pm 1.0
\textbf{83.5}\pm\textbf{8.8}
25.1\pm 2.8
54.2\pm 4.2
\textbf{92.5}\pm\textbf{2.3}
50.9
58.3
49.4
58.1
32.9
15.3
48.7
38.3
\mathcal{P}_{\theta}
\mathcal{P}_{\phi}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
78.4\pm 2.0
77.6\pm 4.2
\textbf{88.6}\pm\textbf{1.3}
64.7\pm 1.5
48.9\pm 3.3
\textbf{86.8}\pm\textbf{1.7}
57.7\pm 2.9
51.9\pm 6.7
\textbf{72.2}\pm\textbf{3.4}
\mathcal{P}_{\theta}
\mathcal{P}_{\theta}
H
H
H=10
H
\mathcal{P}_{\theta}
H=40
\mathcal{P}_{\theta}
f_{\psi}
44.8\pm 1.4
92.8\pm 1.9
\textbf{98.7}\pm\textbf{1.3}
90.1\pm 3.0
41.4\pm 1.5
87.4\pm 1.0
\textbf{88.6}\pm\textbf{1.3}
76.9\pm 1.1
32.1\pm 3.1
78.8\pm 1.1
\textbf{86.8}\pm\textbf{1.7}
65.8\pm 2.0
29.5\pm 1.6
66.7\pm 0.5
\textbf{72.2}\pm\textbf{3.4}
60.2\pm 2.5
H
H
f_{\psi}
f_{\psi}
f_{\psi}
52.3\pm 8.3
57.3\pm 7.6
\textbf{68.0}\pm\textbf{5.9}
56.0\pm 10.9
62.1\pm 8.9
\textbf{78.4}\pm\textbf{4.2}
58.9\pm 5.0
60.2\pm 5.9
\textbf{83.5}\pm\textbf{8.8}
63.9\pm 17.1
70.8\pm 4.6
\textbf{92.5}\pm\textbf{2.3}
\pi_{\psi}^{Z}
z
\pi_{\psi}^{Z}
f_{\psi}
95.6\pm 0.8
85.5\pm 2.4
\textbf{98.7}\pm\textbf{1.3}
87.7\pm 0.5
75.4\pm 2.3
\textbf{88.6}\pm\textbf{1.3}
75.7\pm 3.2
58.2\pm 4.6
\textbf{86.8}\pm\textbf{1.7}
67.3\pm 4.0
50.0\pm 0.5
\textbf{72.2}\pm\textbf{3.4}
