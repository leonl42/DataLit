\mathcal{S}
\mathcal{A}
t
s_{t}\in S
a_{t}\in\mathcal{A}
\pi
a_{t}\sim\pi(a_{t}\,|\,s_{t})
s_{t+1}\sim p(s_{t+1}\mid s_{t},a_{t})
r_{t}=r(s_{t},a_{t})\in\mathbb{R}
r
\pi^{\star}
\pi^{\star}=\operatorname*{arg\,max}_{\pi}\operatorname*{\mathbb{E}}\left[\sum%
_{t}{\gamma^{t}r_{t}}\right]
\gamma\in[0,1)
\rho_{\pi}
\pi
s_{t}
x_{t}\in\mathcal{X}
x_{t}\sim X(s_{t})
\pi
\pi(a_{t}\mid x_{1:t},a_{1:t-1})
c_{t}\in\mathbb{R}
c_{t}=c(s_{t},a_{t})
d\in\mathbb{R}
\displaystyle\begin{split}\pi^{\ast}=\operatorname*{arg\,max}_{\pi}%
\operatorname*{\mathbb{E}}\left[\sum_{t}{\gamma^{t}r_{t}}\right]\quad%
\operatorname*{s.t.}\quad\operatorname*{\mathbb{E}}\left[\sum_{t}{c_{t}}\right%
]<d.\end{split}
\displaystyle\begin{split}\pi^{\ast}=\operatorname*{arg\,max}_{\pi}%
\operatorname*{\mathbb{E}}\left[\sum_{t}{\gamma^{t}r_{t}}\right]\quad%
\operatorname*{s.t.}\quad\operatorname*{\mathbb{E}}\left[\sum_{t}{c_{t}}\right%
]<d.\end{split}
{\mathbf{z}}_{t}
p({\mathbf{z}}_{t+1}\,|\,{\mathbf{z}}_{t},{\mathbf{a}}_{t})
{\mathbf{x}}\sim p({\mathbf{x}}_{t}\,|\,{\mathbf{z}}_{t})
{\textnormal{r}}_{t}\sim p({\textnormal{r}}_{t}\,|\,{\mathbf{z}}_{t})
q({\mathbf{z}}_{t}\,|\,{\mathbf{x}}_{0:t},{\mathbf{a}}_{0:t})
{\mathbf{z}}
\psi
{\mathbf{z}}
{\mathbf{x}}
{\mathbf{a}}
\displaystyle\begin{split}{\mathbf{z}}^{1}_{1}&\sim p({\mathbf{z}}^{1}_{1}).\\
{\mathbf{z}}^{2}_{1}&\sim p_{\psi}({\mathbf{z}}^{2}_{1}\mid{\mathbf{z}}^{1}_{1%
}).\\
{\mathbf{z}}^{1}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{1}_{t+1}\mid{\mathbf{z}}^{2%
}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{z}}^{2}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{2}_{t+1}\mid{\mathbf{z}}^{1%
}_{t+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{x}}_{t}&\sim p_{\psi}({\mathbf{x}}_{t}\mid{\mathbf{z}}^{1}_{t},{%
\mathbf{z}}^{2}_{t}).\\
{\textnormal{r}}_{t}&\sim p_{\psi}({\textnormal{r}}_{t}\mid{\mathbf{z}}^{1}_{t%
},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t},{\mathbf{z}}^{1}_{t+1},{\mathbf{z}}^{2%
}_{t+1}).\\
\end{split}
\displaystyle\begin{split}{\mathbf{z}}^{1}_{1}&\sim p({\mathbf{z}}^{1}_{1}).\\
{\mathbf{z}}^{2}_{1}&\sim p_{\psi}({\mathbf{z}}^{2}_{1}\mid{\mathbf{z}}^{1}_{1%
}).\\
{\mathbf{z}}^{1}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{1}_{t+1}\mid{\mathbf{z}}^{2%
}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{z}}^{2}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{2}_{t+1}\mid{\mathbf{z}}^{1%
}_{t+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{x}}_{t}&\sim p_{\psi}({\mathbf{x}}_{t}\mid{\mathbf{z}}^{1}_{t},{%
\mathbf{z}}^{2}_{t}).\\
{\textnormal{r}}_{t}&\sim p_{\psi}({\textnormal{r}}_{t}\mid{\mathbf{z}}^{1}_{t%
},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t},{\mathbf{z}}^{1}_{t+1},{\mathbf{z}}^{2%
}_{t+1}).\\
\end{split}
\displaystyle\begin{split}{\mathbf{z}}^{1}_{1}&\sim q_{\psi}({\mathbf{z}}^{1}_%
{1}\mid{\mathbf{x}}_{1}).\\
{\mathbf{z}}^{2}_{1}&\sim p_{\psi}({\mathbf{z}}^{2}_{1}\mid{\mathbf{z}}^{1}_{1%
}).\\
{\mathbf{z}}^{1}_{t+1}&\sim q_{\psi}({\mathbf{z}}^{1}_{t+1}\mid{\mathbf{x}}_{t%
+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{z}}^{2}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{2}_{t+1}\mid{\mathbf{z}}^{1%
}_{t+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
\end{split}
\displaystyle\begin{split}{\mathbf{z}}^{1}_{1}&\sim q_{\psi}({\mathbf{z}}^{1}_%
{1}\mid{\mathbf{x}}_{1}).\\
{\mathbf{z}}^{2}_{1}&\sim p_{\psi}({\mathbf{z}}^{2}_{1}\mid{\mathbf{z}}^{1}_{1%
}).\\
{\mathbf{z}}^{1}_{t+1}&\sim q_{\psi}({\mathbf{z}}^{1}_{t+1}\mid{\mathbf{x}}_{t%
+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
{\mathbf{z}}^{2}_{t+1}&\sim p_{\psi}({\mathbf{z}}^{2}_{t+1}\mid{\mathbf{z}}^{1%
}_{t+1},{\mathbf{z}}^{2}_{t},{\mathbf{a}}_{t}).\\
\end{split}
\psi
D_{KL}
J_{M}(\psi)=\operatorname*{\mathbb{E}}_{\mathbf{z}_{1:\tau+1}\sim q_{\psi}}%
\left[\sum_{t=0}^{\tau}\begin{array}[]{l}-\log p_{\psi}(\mathbf{x}_{t+1}\mid%
\textbf{z}_{t+1})\\
-\log p_{\psi}(\mathbf{r}_{t+1}\mid\textbf{z}_{t+1})\\
+D_{KL}(q_{\psi}(\textbf{z}_{t+1}\mid\textbf{x}_{t+1},\textbf{z}_{t},\textbf{a%
}_{t})\ p_{\psi}(\mathbf{z}_{t+1}\mid\mathbf{z}_{t},\mathbf{a}_{t}))\end{array%
}\right].
q_{\psi}({\mathbf{z}}^{1}_{1}\,|\,{\mathbf{x}}_{1})
{\textnormal{c}}_{t}\sim p_{\psi}({\textnormal{c}}_{t}\,|\,{\mathbf{z}}_{t}^{1%
},{\mathbf{z}}_{t}^{2},{\mathbf{a}}_{t},{\mathbf{z}}_{t+1}^{1},{\mathbf{z}}_{t%
+1}^{2})
J_{M}(\psi)=\mathop{\operatorname*{\mathbb{E}}}_{{\mathbf{z}}_{1:\tau+1}\sim q%
_{\psi}}\left[\sum_{t=0}^{\tau}\begin{array}[]{rl}&-\log p_{\psi}({\mathbf{x}}%
_{t+1}\mid{\mathbf{z}}_{t+1})\\
&-\log p_{\psi}({\textnormal{r}}_{t+1}\mid{\mathbf{z}}_{t+1})\\
&-\log p_{\psi}({\mathbf{c}}_{t+1}\mid{\mathbf{z}}_{t+1})\\
&+D_{KL}(q_{\psi}({\mathbf{z}}_{t+1}\mid{\mathbf{x}}_{t+1},\textbf{z}_{t},{%
\mathbf{a}}_{t})\parallel p_{\psi}({\mathbf{z}}_{t+1}\mid{\mathbf{z}}_{t},{%
\mathbf{a}}_{t}))\end{array}\right].
Q^{r}
\theta
Q^{r}
\displaystyle J_{Q^{r}}(\theta)=\operatorname*{\mathbb{E}}_{\mathbf{z}_{1:\tau%
+1}\sim q_{\psi}}\left[\frac{1}{2}(Q^{r}_{\theta}(\mathbf{z}_{\tau},\mathbf{a}%
_{\tau})-(r_{\tau}+\gamma V_{\bar{\theta}}(\mathbf{z}_{\tau+1})))^{2}\right].
\displaystyle J_{Q^{r}}(\theta)=
\displaystyle\operatorname*{\mathbb{E}}_{\mathbf{z}_{1:\tau+1}\sim q_{\psi}}%
\left[\frac{1}{2}(Q^{r}_{\theta}(\mathbf{z}_{\tau},\mathbf{a}_{\tau})-(r_{\tau%
}+\gamma V_{\bar{\theta}}(\mathbf{z}_{\tau+1})))^{2}\right].
\displaystyle V_{\theta}(\mathbf{z}_{\tau+1})=\operatorname*{\mathbb{E}}_{%
\mathbf{a}_{\tau+1}\sim\pi_{\phi}}\left[Q^{r}_{\theta}(\mathbf{z}_{\tau+1},%
\mathbf{a}_{\tau+1})-\alpha\log\pi_{\phi}(\mathbf{a}_{\tau+1}\mid\mathbf{x}_{1%
:\tau+1},\mathbf{a}_{1:\tau})\right].
\displaystyle V_{\theta}(\mathbf{z}_{\tau+1})=
\displaystyle\operatorname*{\mathbb{E}}_{\mathbf{a}_{\tau+1}\sim\pi_{\phi}}%
\left[Q^{r}_{\theta}(\mathbf{z}_{\tau+1},\mathbf{a}_{\tau+1})-\alpha\log\pi_{%
\phi}(\mathbf{a}_{\tau+1}\mid\mathbf{x}_{1:\tau+1},\mathbf{a}_{1:\tau})\right].
Q^{c}
\zeta
J_{Q^{c}}(\zeta)=\operatorname*{\mathbb{E}}_{\mathbf{z}_{1:\tau+1}\sim q_{\psi%
}}\left[\frac{1}{2}(Q^{c}_{\zeta}(\mathbf{z}_{\tau},\mathbf{a}_{\tau})-(c_{%
\tau}+\gamma\operatorname*{\mathbb{E}}_{\mathbf{a}_{\tau+1}\sim\pi_{\phi}}Q^{c%
}_{\bar{\zeta}}(\mathbf{z}_{\tau+1},\mathbf{a}_{\tau+1})))^{2}\right].
Q^{r}_{\theta}
J_{\pi}(\phi)=\operatorname*{\mathbb{E}}_{\mathbf{z}_{t:\tau+1}\sim q_{\psi}}%
\left[\operatorname*{\mathbb{E}}_{\mathbf{a}_{\tau+1}\sim\pi_{\phi}}\left[%
\alpha\log\pi_{\phi}(\mathbf{a}_{\tau+1}\mid\mathbf{x}_{1:\tau+1},\mathbf{a}_{%
1:\tau})-Q^{r}_{\theta}(\mathbf{z}_{\tau+1},\mathbf{a}_{\tau+1})\right]\right].
Q^{c}_{\zeta}
\lambda
J_{\pi}(\phi)=\operatorname*{\mathbb{E}}_{\mathbf{z}_{t:\tau+1}\sim q_{\psi}}%
\left[\operatorname*{\mathbb{E}}_{\mathbf{a}_{\tau+1}\sim\pi_{\phi}}\left[%
\begin{array}[]{l}\alpha\log\pi_{\phi}(\mathbf{a}_{\tau+1}\mid\mathbf{x}_{1:%
\tau+1},\mathbf{a}_{1:\tau})\\
\quad-Q^{r}_{\theta}(\mathbf{z}_{\tau+1},\mathbf{a}_{\tau+1})\\
\quad+\lambda Q^{c}_{\zeta}(\mathbf{z}_{\tau+1},\mathbf{a}_{\tau+1})\end{array%
}\right]\right].
{\mathbf{z}}
\pi_{\phi}
\pi_{\phi}({\mathbf{a}}_{\tau+1}\,|\,{\mathbf{z}}_{\tau+1})
\pi_{\phi}({\mathbf{a}}_{t}\,|\,{\mathbf{z}}_{t})
\alpha
\lambda
\alpha
\lambda
\lambda
\lambda
J_{s}(\lambda)=\operatorname*{\mathbb{E}}_{\rho\sim\rho_{\pi}}\left[\lambda%
\sum_{t=1}^{T}c_{t}-d\right],
\rho
d
\mathcal{D}
\mathcal{E}
\psi
\theta_{1}
\theta_{2}
\zeta
\phi
W_{p}
W_{t}
W_{p}
\mathcal{E}
\mathcal{D}
W_{t}
\mathcal{D}
\psi
t
{\mathbf{a}}_{t}\sim\pi_{\phi}({\mathbf{a}}_{t}\,|\,{\mathbf{x}}_{1:t},{%
\mathbf{a}}_{1:t-1})
({\mathbf{x}}_{t+1},r_{t+1},c_{t+1})
{\mathbf{a}}_{t}
\mathcal{E}
\mathcal{D}\leftarrow\mathcal{D}\cup({\mathbf{x}}_{t+1},{\mathbf{a}}_{t},r_{t+%
1},c_{t+1})
\lambda
({\mathbf{x}}_{1:\tau+1},{\mathbf{a}}_{1:\tau},r_{1:\tau+1},c_{1:\tau+1})\sim%
\mathcal{D}
\theta_{1},\theta_{2}
\psi
\phi
\zeta
\bar{\theta_{1}}\leftarrow\nu\theta_{1}+(1-\nu)\bar{\theta_{1}}
\bar{\theta_{2}}\leftarrow\nu\theta_{2}+(1-\nu)\bar{\theta_{2}}
\bar{\zeta}\leftarrow\nu\zeta+(1-\nu)\bar{\zeta}
2*10^{-6}
6*10^{-6}
64\times 64\times 3
z^{1}
z^{2}
2*10^{5}
1*10^{-4}
2*10^{-4}
2e-4
\alpha
4*10^{-3}
\lambda
2*10^{-2}
60*10^{3}
30*10^{3}
40
5*10^{-3}
