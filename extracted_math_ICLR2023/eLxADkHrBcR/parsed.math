T_{1},T_{2},\dots
T_{1},T_{2},\dots
p_{\mathcal{T}}(\cdot)
\mathcal{T}
\mathcal{T}=({\mathcal{S}},{\mathcal{A}},r,\gamma,p_{0},p_{d})
{\mathcal{S}}
{\mathcal{A}}
r
\gamma
p_{0}({\mathbf{s}}_{0})
p_{d}({\mathbf{s}}_{t+1}\mid{\mathbf{s}}_{t},{\mathbf{a}}_{t})
\mathcal{D}
\mathcal{D}=\{{\mathbf{s}}_{i},{\mathbf{a}}_{i},r_{i},{\mathbf{s}}^{\prime}_{i%
}\}_{i=1}^{N_{\text{size}}}
{\mathbf{h}}
{\mathbf{h}}\sim\mathcal{D}
{\mathbf{h}}
\mathcal{D}
{\mathbf{\tau}}
{\mathbf{\tau}}=({\mathbf{s}}_{1},{\mathbf{a}}_{1},{\mathbf{s}}_{2},\dots)
\mathcal{T}\sim p_{\mathcal{T}}(\cdot)
T
\pi_{\theta}
{\theta}
{\mathbf{h}}
{\mathbf{z}}=A_{\phi}({\mathbf{h}})
\pi_{\theta}({\mathbf{a}},\mid{\mathbf{s}},{\mathbf{z}})
\pi_{\theta}
A_{\phi}
{\mathbf{z}}
{\mathbf{z}}
\phi
{\theta}
\mathcal{T}
p(\mathcal{T})
{\mathbf{z}}
A_{\phi}
{\mathbf{z}}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
q_{\phi_{e}}
{\phi_{e}}
{\mathbf{h}}=\{{\mathbf{s}}_{i},{\mathbf{a}}_{i},r_{i},{\mathbf{s}}^{\prime}_{%
i}\}_{i=1}^{N_{\text{enc}}}
\pi_{\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})
{\mathbf{z}}
{\mathbf{z}}
{\mathbf{s}}
{\theta}
Q
Q_{w}({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})
{w}
{\mathcal{D}}
\pi_{\beta}
\mathcal{D}_{1},\dots,\mathcal{D}_{N_{\text{buff}}}
{\mathcal{D}}=\{\mathcal{D}_{i}\}_{i=1}^{N_{\text{buff}}}
{\mathbf{z}}
{\mathbf{z}}
\pi_{\theta}
A_{\phi}({\mathbf{h}})
\pi_{\beta}
\pi_{\theta}
\pi_{\beta}
{\mathbf{h}}
{\mathbf{z}}=A_{\phi}({\mathbf{h}})
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
{\mathbf{z}}
{\mathbf{h}}
\pi_{\theta}
\pi_{\beta}
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
p({\mathbf{z}})
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
p({\mathbf{z}})
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
p({\mathbf{z}}\mid{\mathbf{h}})\approx q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h%
}})
{\mathbf{h}}
p({\mathbf{z}}\mid{\mathbf{h}})
p_{\mathbf{z}}({\mathbf{z}})
{\mathbf{h}}
{\mathbf{z}}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}_{\text{online}}
\pi_{\theta}
{\mathbf{z}}
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
{\mathbf{z}}
z
{\mathbf{h}}_{\text{online}}
p({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}^{\prime}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}^{\prime})
{\mathbf{h}}
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}\sim p(z)
{\mathbf{h}}^{\prime}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}^{\prime})
{\mathbf{h}}
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}\sim p(z)
{\mathbf{z}}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
\displaystyle\begin{split}{\mathcal{L}}_{\text{critic}}({w})=\mathbb{E}_{({%
\mathbf{s}},{\mathbf{a}},r,{\mathbf{s}}^{\prime})\sim\mathcal{D}_{i},z\sim q_{%
\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}),{\mathbf{a}}^{\prime}\sim\pi_{\theta}(%
{\mathbf{a}}^{\prime}\mid{\mathbf{s}}^{\prime},{\mathbf{z}})}\Big{[}\\
(Q_{w}({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})-(r+\gamma Q_{\bar{w}}({\mathbf{%
s}}^{\prime},{\mathbf{a}}^{\prime},{\mathbf{z}})))^{2}\Big{]},\end{split}
\displaystyle\begin{split}{\mathcal{L}}_{\text{critic}}({w})=\mathbb{E}_{({%
\mathbf{s}},{\mathbf{a}},r,{\mathbf{s}}^{\prime})\sim\mathcal{D}_{i},z\sim q_{%
\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}),{\mathbf{a}}^{\prime}\sim\pi_{\theta}(%
{\mathbf{a}}^{\prime}\mid{\mathbf{s}}^{\prime},{\mathbf{z}})}\Big{[}\\
(Q_{w}({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})-(r+\gamma Q_{\bar{w}}({\mathbf{%
s}}^{\prime},{\mathbf{a}}^{\prime},{\mathbf{z}})))^{2}\Big{]},\end{split}
\bar{w}
Q({\mathbf{s}}^{\prime},{\mathbf{a}}^{\prime})
{\mathbf{a}}^{\prime}
\mathcal{D}
\displaystyle\begin{split}{\mathcal{L}}_{\text{actor}}({\theta})=&-\mathbb{E}_%
{{\mathbf{s}},{\mathbf{a}},{\mathbf{s}}^{\prime}\sim\mathcal{D},{\mathbf{z}}%
\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})}\Big{[}\log\pi_{\theta}({%
\mathbf{a}}\mid{\mathbf{s}})\times\\
&\exp{\left(\frac{Q({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})-V({\mathbf{s}}^{%
\prime},{\mathbf{z}})}{\lambda}\right)}\Big{]}.\end{split}
\displaystyle\begin{split}{\mathcal{L}}_{\text{actor}}({\theta})=&-\mathbb{E}_%
{{\mathbf{s}},{\mathbf{a}},{\mathbf{s}}^{\prime}\sim\mathcal{D},{\mathbf{z}}%
\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})}\Big{[}\log\pi_{\theta}({%
\mathbf{a}}\mid{\mathbf{s}})\times\\
&\exp{\left(\frac{Q({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})-V({\mathbf{s}}^{%
\prime},{\mathbf{z}})}{\lambda}\right)}\Big{]}.\end{split}
V({\mathbf{s}},{\mathbf{z}})=\mathbb{E}_{{\mathbf{a}}\sim\pi_{\theta}({\mathbf%
{a}}\mid{\mathbf{s}},{\mathbf{z}})}Q({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})
\lambda
{\mathbf{z}}
\pi_{\beta}
q_{\phi_{e}}
{\mathbf{h}}
{\mathbf{z}}
\pi_{\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})
{\mathbf{z}}
r_{\phi_{d}}({\mathbf{s}},{\mathbf{a}},{\mathbf{z}})
{\phi_{d}}
\phi=\{{\phi_{e}},{\phi_{d}}\}
{\mathbf{z}}
r_{\phi_{d}}
{\mathbf{z}}
q_{\phi_{e}}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
p_{\mathbf{z}}({\mathbf{z}})
{\mathbf{z}}
p_{\mathbf{z}}({\mathbf{z}})
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{h}})
\displaystyle\begin{split}{\mathcal{L}}_{\text{reward}}({\phi_{d}},{\phi_{e}},%
{\mathbf{h}},{\mathbf{z}})=&\sum_{\begin{subarray}{c}({\mathbf{s}},{\mathbf{a}%
},r)\in{\mathbf{h}}\end{subarray}}\left\|r-r_{\phi_{d}}({\mathbf{s}},{\mathbf{%
a}},{\mathbf{z}})\right\|_{2}^{2}\\
&+D_{\mathrm{KL}}\left(q_{\phi_{e}}(\cdot\mid{\mathbf{h}})\Big{|}\Big{|}%
\vphantom{q_{\phi_{e}}(\cdot\mid{\mathbf{h}})}\vphantom{p_{\mathbf{z}}(\cdot)}%
p_{\mathbf{z}}(\cdot)\right).\end{split}
\displaystyle\begin{split}{\mathcal{L}}_{\text{reward}}({\phi_{d}},{\phi_{e}},%
{\mathbf{h}},{\mathbf{z}})=&\sum_{\begin{subarray}{c}({\mathbf{s}},{\mathbf{a}%
},r)\in{\mathbf{h}}\end{subarray}}\left\|r-r_{\phi_{d}}({\mathbf{s}},{\mathbf{%
a}},{\mathbf{z}})\right\|_{2}^{2}\\
&+D_{\mathrm{KL}}\left(q_{\phi_{e}}(\cdot\mid{\mathbf{h}})\Big{|}\Big{|}%
\vphantom{q_{\phi_{e}}(\cdot\mid{\mathbf{h}})}\vphantom{p_{\mathbf{z}}(\cdot)}%
p_{\mathbf{z}}(\cdot)\right).\end{split}
\tau
\pi_{\theta}
p({\mathbf{z}})
\tau
\mathcal{D}_{i}
{\mathcal{D}}
{\mathbf{h}}_{\text{offline}}\sim\mathcal{D}_{i}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
r_{\text{generated}}
({\mathbf{s}},{\mathbf{a}})
\displaystyle r_{\text{generated}}=r_{\phi_{d}}({\mathbf{s}},{\mathbf{a}},{%
\mathbf{z}}),\text{ where }{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{%
\mathbf{h}}).
\displaystyle r_{\text{generated}}=r_{\phi_{d}}({\mathbf{s}},{\mathbf{a}},{%
\mathbf{z}}),\text{ where }{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{%
\mathbf{h}}).
r_{\phi_{d}}
q_{\phi_{e}}
{\mathbf{z}}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}_{\text{online}})
{\mathbf{z}}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}}_{\text{offline}})
{\mathcal{D}}=\{\mathcal{D}_{i}\}_{i=1}^{N_{\text{buff}}}
\mathcal{D}_{i}\sim{\mathcal{D}}
{\mathbf{h}}\sim\mathcal{D}_{i}
q_{\phi_{e}}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
{\mathbf{h}}^{\prime}\sim\mathcal{D}_{i}
Q
\lambda_{\text{pearl}}
{\mathbf{z}}
376
T=3
200
\mathcal{T}\sim p(\mathcal{T})
0
-1
1200
6
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}
\log\pi_{\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})
\pi_{\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}
{\mathcal{D}}=\{\mathcal{D}_{i}\}_{i=1}^{N_{\text{buff}}}
\pi_{\theta}
Q_{w}
q_{\phi_{e}}
r_{\phi_{d}}
n=1,2,\dots,N_{\text{offline}}
\triangleright
\mathcal{D}_{i}\sim{\mathcal{D}}
{\mathbf{h}},{\mathbf{h}}^{\prime}\sim\mathcal{D}_{i}
{\mathbf{h}}
{\mathbf{z}}
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{h}})
\pi_{\theta}
Q_{w}
q_{\phi_{e}}
r_{\phi_{d}}
{\mathcal{L}}_{\text{actor}}
{\mathcal{L}}_{\text{critic}}
{\mathcal{L}}_{\text{reward}}
{\mathbf{z}},{\mathbf{h}}^{\prime}
n=1,2,\dots,N_{\text{online}}
\triangleright
{\mathbf{\tau}}
\pi_{\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})
{\mathbf{z}}_{t}\sim p({\mathbf{z}})
\mathcal{D}_{i}\sim{\mathcal{D}}
{\mathbf{h}}_{\text{offline}}\sim\mathcal{D}_{i}
{\mathbf{h}}_{\text{offline}}
{\mathbf{\tau}}
\mathcal{D}_{i}
\mathcal{D}_{i}\sim{\mathcal{D}}
{\mathbf{h}},{\mathbf{h}}^{\prime}\sim\mathcal{D}_{i}
{\mathbf{z}}=q_{\phi_{e}}({\mathbf{h}})
\pi_{\theta}
Q_{w}
{\mathcal{L}}_{\text{actor}}
{\mathcal{L}}_{\text{critic}}
{\mathbf{z}},{\mathbf{h}}^{\prime}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}_{\text{offline}}
{\mathbf{h}}_{\text{online}}
{\mathbf{h}}_{\text{offline}}
{\mathbf{z}}
-1
0
1
0.2
0.25
\mathbb{R}^{20}
[-1,1]^{8}
[0,3]
{\mathbf{z}}\sim p_{\mathbf{z}}({\mathbf{z}})
{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
[0,3]
\mathbb{R}^{20}
z
[-1,1]^{6}
0
[1.5^{-3},1.5^{3}]
1
10^{-3}\times\lVert a\rVert^{2}
\lVert a\rVert
\ell_{2}
50000
({\mathbf{s}},{\mathbf{a}},r,{\mathbf{s}}^{\prime})
{\mathbf{h}}
q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})
(\text{RL batch size})\times(\text{meta batch size})
(\text{RL batch size})\times(\text{encoder batch size})
256
64
4
[300,300,300]
[300,300,300]
[64,64]
[200,200,200]
{\mathbf{z}}
{d_{z}}
5
\gamma
0.99
\eta
0.005
3\times 10^{-4}
\beta
\lambda_{\text{pearl}}
\displaystyle q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})\propto\prod_{{\mathbf%
{s}},{\mathbf{a}},r\in{\mathbf{h}}}\Phi({\mathbf{z}}\mid{\mathbf{s}},{\mathbf{%
a}},r),
\displaystyle q_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})\propto\prod_{{\mathbf%
{s}},{\mathbf{a}},r\in{\mathbf{h}}}\Phi({\mathbf{z}}\mid{\mathbf{s}},{\mathbf{%
a}},r),
\mathbb{R}^{d_{z}}
\displaystyle\Phi_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{s}},{\mathbf{a}},r)={%
\mathcal{N}}(\mu_{\phi_{e}}({\mathbf{s}},{\mathbf{a}},r),\sigma_{\phi_{e}}({%
\mathbf{s}},{\mathbf{a}},r)).
\displaystyle\Phi_{\phi_{e}}({\mathbf{z}}\mid{\mathbf{s}},{\mathbf{a}},r)={%
\mathcal{N}}(\mu_{\phi_{e}}({\mathbf{s}},{\mathbf{a}},r),\sigma_{\phi_{e}}({%
\mathbf{s}},{\mathbf{a}},r)).
2\times{d_{z}}
\lambda_{\text{pearl}}
\displaystyle{\mathcal{L}}_{\text{actor}}^{\text{self-supervised}}({\theta})={%
\mathcal{L}}_{\text{actor}}({\theta})+\lambda_{\text{pearl}}\cdot{\mathcal{L}}%
_{\text{actor}}^{\text{PEARL}}({\theta}),
\displaystyle{\mathcal{L}}_{\text{actor}}^{\text{self-supervised}}({\theta})
\displaystyle={\mathcal{L}}_{\text{actor}}({\theta})+\lambda_{\text{pearl}}%
\cdot{\mathcal{L}}_{\text{actor}}^{\text{PEARL}}({\theta}),
{\mathcal{L}}_{\text{actor}}^{\text{PEARL}}
\displaystyle{\mathcal{L}}_{\text{actor}}^{\text{PEARL}}({\theta})=\mathbb{E}_%
{{\mathbf{s}}\sim\mathcal{D}_{i},{\mathbf{z}}\sim q_{\phi_{e}}({\mathbf{z}}%
\mid{\mathbf{h}})}\left[D_{\mathrm{KL}}\left(\pi_{\theta}({\mathbf{a}}\mid{%
\mathbf{s}},{\mathbf{z}})\Big{|}\Big{|}\vphantom{\pi_{\theta}({\mathbf{a}}\mid%
{\mathbf{s}},{\mathbf{z}})}\vphantom{\frac{\exp{Q_{w}({\mathbf{s}},{\mathbf{a}%
},{\mathbf{z}})}}{Z({\mathbf{s}})}}\frac{\exp{Q_{w}({\mathbf{s}},{\mathbf{a}},%
{\mathbf{z}})}}{Z({\mathbf{s}})}\right)\right].
\displaystyle{\mathcal{L}}_{\text{actor}}^{\text{PEARL}}({\theta})
\displaystyle=\mathbb{E}_{{\mathbf{s}}\sim\mathcal{D}_{i},{\mathbf{z}}\sim q_{%
\phi_{e}}({\mathbf{z}}\mid{\mathbf{h}})}\left[D_{\mathrm{KL}}\left(\pi_{\theta%
}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})\Big{|}\Big{|}\vphantom{\pi_{%
\theta}({\mathbf{a}}\mid{\mathbf{s}},{\mathbf{z}})}\vphantom{\frac{\exp{Q_{w}(%
{\mathbf{s}},{\mathbf{a}},{\mathbf{z}})}}{Z({\mathbf{s}})}}\frac{\exp{Q_{w}({%
\mathbf{s}},{\mathbf{a}},{\mathbf{z}})}}{Z({\mathbf{s}})}\right)\right].
\lambda_{\text{pearl}}
