\log q(\bm{x})
\bm{z}
\bm{x}
g_{\theta}(.)
\bm{z}\sim p_{z}
\bm{x}=g_{\theta}(\bm{z})
\bm{x}\sim p
q_{\phi}(\bm{x})
p
p
q_{\phi}
\displaystyle\mathcal{D}_{FD}(p,q_{\phi})\coloneqq\mathbb{E}_{\bm{x}\sim p}%
\biggl{\{}\|\nabla_{\bm{x}}\log p(\bm{x})\|_{2}^{2}+\|\nabla_{\bm{x}}\log q_{%
\phi}(\bm{x})\|_{2}^{2}
\displaystyle\mathcal{D}_{FD}(p,q_{\phi})\coloneqq
\displaystyle\mathbb{E}_{\bm{x}\sim p}\biggl{\{}\|\nabla_{\bm{x}}\log p(\bm{x}%
)\|_{2}^{2}+\|\nabla_{\bm{x}}\log q_{\phi}(\bm{x})\|_{2}^{2}
\displaystyle-2\langle\nabla_{\bm{x}}\log p(\bm{x}),\nabla_{\bm{x}}\log q_{%
\phi}(\bm{x})\rangle\biggl{\}}.
\displaystyle-2\langle\nabla_{\bm{x}}\log p(\bm{x}),\nabla_{\bm{x}}\log q_{%
\phi}(\bm{x})\rangle\biggl{\}}.
\displaystyle\mathcal{L}(\phi)=\mathbb{E}_{p}\biggl{\{}\|\nabla_{\bm{x}}\log q%
_{\phi}(\bm{x})\|_{2}^{2}+2\Delta_{\bm{x}}\log q_{\phi}(\bm{x})\biggl{\}}.
\displaystyle\mathcal{L}(\phi)=\mathbb{E}_{p}\biggl{\{}
\displaystyle\|\nabla_{\bm{x}}\log q_{\phi}(\bm{x})\|_{2}^{2}+2\Delta_{\bm{x}}%
\log q_{\phi}(\bm{x})\biggl{\}}.
p
q_{\phi}
\bm{s}_{\phi}(\bm{x})\colon\mathbb{R}^{D}\to\mathbb{R}^{D}
\Delta_{\bm{x}}\log q_{\phi}(\bm{x})
\bm{x}\sim p
\bm{x}_{\sigma}=\bm{x}+\sigma\epsilon,~{}~{}\epsilon\sim\mathcal{N}(\bm{0},%
\mathcal{I})
\sigma
p_{\sigma}
\bm{x}_{\sigma}
p
\bm{x}_{0}
p(\bm{x}_{\sigma}|\bm{x}_{0})
q_{\phi}
\bm{s}_{\phi}(.)
\displaystyle\mathcal{L}_{DSM}(\phi)=\mathbb{E}_{\bm{x}_{0}\sim p,\atop\bm{x}_%
{\sigma}|\bm{x}_{0}\sim p(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\|\nabla_{\bm{x%
}_{\sigma}}\log q(\bm{x}_{\sigma})
\displaystyle\mathcal{L}_{DSM}(\phi)=
\displaystyle\mathbb{E}_{\bm{x}_{0}\sim p,\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim p%
(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\|\nabla_{\bm{x}_{\sigma}}\log q(\bm{x}_%
{\sigma})
\displaystyle-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\|_{2}%
^{2}\bigg{\}}.
\displaystyle-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\|_{2}%
^{2}\bigg{\}}.
g_{\theta}(\cdot)\colon\mathbb{R}^{D_{Z}}\to\mathbb{R}^{D_{X}}
p_{z}
p_{\theta}
\bm{x}=g_{\theta}(\bm{z})
q(\bm{x})
g_{\theta}
p_{\theta}(\bm{x})
q(\bm{x})
p_{\theta}(\bm{x})
q(\bm{x})
\displaystyle\bm{x}_{\sigma}\coloneqq\bm{x}_{0}+\sigma\epsilon,~{}~{}\bm{x}_{0%
}=g_{\theta}(\bm{z}),~{}~{}\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I})
\displaystyle\bm{x}_{\sigma}\coloneqq\bm{x}_{0}+\sigma\epsilon,~{}~{}\bm{x}_{0%
}=g_{\theta}(\bm{z}),~{}~{}\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I})
p(\bm{x}_{\sigma}|\bm{x}_{0})=\mathcal{N}(\bm{x}_{0},\sigma^{2}\mathcal{I})
\sigma
p_{\theta,\sigma}
\bm{x}_{\sigma}
p_{\theta}
\bm{x}_{0}
\bm{s}_{q}(\bm{x}_{\sigma})\coloneqq\nabla_{\bm{x}_{\sigma}}\log q(\bm{x}_{%
\sigma})
\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\coloneqq\nabla_{\bm{x}_{\sigma}}\log p%
_{\theta,\sigma}(\bm{x}_{\sigma})
p_{\sigma,\theta}(\bm{x})
q(\bm{x})
\displaystyle\mathcal{D}_{FD}(\theta)\coloneqq\mathbb{E}_{\bm{x}_{\sigma}\sim p%
_{\theta,\sigma}}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}
\displaystyle\mathcal{D}_{FD}(\theta)\coloneqq\mathbb{E}_{\bm{x}_{\sigma}\sim p%
_{\theta,\sigma}}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}
\bm{x}_{\sigma}(\theta)
\bm{x}_{\sigma}
\bm{x}_{\sigma}
\theta
\theta
\displaystyle\frac{\partial}{\partial\theta}\mathcal{D}_{FD}(\theta)=\frac{%
\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\|%
\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}
\displaystyle\frac{\partial}{\partial\theta}\mathcal{D}_{FD}(\theta)=\frac{%
\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\|%
\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}\frac%
{\partial}{\partial\bm{x}_{\sigma}}\big{\{}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s%
}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{\partial\bm{x}_{%
\sigma}(\theta)}{\partial\theta}
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}\frac%
{\partial}{\partial\bm{x}_{\sigma}}\big{\{}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s%
}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{\partial\bm{x}_{%
\sigma}(\theta)}{\partial\theta}
\displaystyle-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(%
\bm{x}_{\sigma})\bigg{\}}
\displaystyle-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(%
\bm{x}_{\sigma})\bigg{\}}
\displaystyle=\operatorname{Grad}_{1}(\theta)+\operatorname{Grad}_{1}(\theta).
\displaystyle=\operatorname{Grad}_{1}(\theta)+\operatorname{Grad}_{1}(\theta).
\operatorname{Grad}_{1}(\theta)
\operatorname{Grad}_{2}(\theta)
\displaystyle\operatorname{Grad}_{1}(\theta)=\mathbb{E}_{p_{\sigma,\theta}}%
\bigg{\{}\frac{\partial}{\partial\bm{x}_{\sigma}}\big{\{}\|\bm{s}_{q}(\bm{x}_{%
\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{%
\partial\bm{x}_{\sigma}(\theta)}{\partial\theta}\bigg{\}},
\displaystyle\operatorname{Grad}_{1}(\theta)=\mathbb{E}_{p_{\sigma,\theta}}%
\bigg{\{}\frac{\partial}{\partial\bm{x}_{\sigma}}\big{\{}\|\bm{s}_{q}(\bm{x}_{%
\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{%
\partial\bm{x}_{\sigma}(\theta)}{\partial\theta}\bigg{\}},
\displaystyle\operatorname{Grad}_{2}(\theta)=\mathbb{E}_{p_{\sigma,\theta}}%
\bigg{\{}-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\bigg{\}}.
\displaystyle\operatorname{Grad}_{2}(\theta)=\mathbb{E}_{p_{\sigma,\theta}}%
\bigg{\{}-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\bigg{\}}.
\theta
\operatorname{Grad}_{1}(\theta)
\theta
\bm{s}_{\theta,\sigma}(.)
\bm{s}_{\operatorname{sg}[\theta],\sigma}(.)
\displaystyle\mathcal{L}_{1}(\theta)=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma%
,\theta}}\bigg{\{}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg}[%
\theta],\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\bigg{\}}
\displaystyle\mathcal{L}_{1}(\theta)
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}\|\bm%
{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{z}\sim p_{z},\epsilon\sim\mathcal{N}(\bm{0},%
\mathcal{I})\atop\bm{x}_{\sigma}=g_{\theta}(\bm{z})+\sigma\epsilon}\bigg{\{}\|%
\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{z}\sim p_{z},\epsilon\sim\mathcal{N}(\bm{0},%
\mathcal{I})\atop\bm{x}_{\sigma}=g_{\theta}(\bm{z})+\sigma\epsilon}\bigg{\{}\|%
\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}\bigg{\}}
\operatorname{Grad}_{2}(\theta)
\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(.)
\bm{s}_{\theta,\sigma}(.)
\theta
\operatorname{Grad}_{2}(\theta)
p_{\theta,\sigma}
\bm{s}_{q}(.)
\theta
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}-2\big%
{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\big{]}^%
{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\bigg%
{\}}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}-2\big%
{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\big{]}^%
{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\bigg%
{\}}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\bm{z}\sim p_{Z},\bm{%
x}_{0}=g_{\theta}(\bm{z}),\atop\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm%
{x}_{\sigma}=\bm{x}_{0}+\sigma\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{%
\sigma})-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\bm{z}\sim p_{Z},\bm{%
x}_{0}=g_{\theta}(\bm{z}),\atop\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm%
{x}_{\sigma}=\bm{x}_{0}+\sigma\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{%
\sigma})-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\operatorname{Grad}_{2}(\theta)
\bm{s}_{\operatorname{sg}[\theta],\sigma}(\cdot,\cdot)
\operatorname{Grad}_{2}(\theta)
\displaystyle\mathcal{L}_{2}(\theta)=\mathbb{E}_{\bm{z}\sim p_{Z},\bm{x}_{0}=g%
_{\theta}(\bm{z}),\atop\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm{x}_{%
\sigma}=\bm{x}_{0}+\sigma\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})%
-\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle\mathcal{L}_{2}(\theta)
\displaystyle=\mathbb{E}_{\bm{z}\sim p_{Z},\bm{x}_{0}=g_{\theta}(\bm{z}),\atop%
\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm{x}_{\sigma}=\bm{x}_{0}+\sigma%
\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg%
}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{z}\sim p_{Z},\bm{x}_{0}=g_{\theta}(\bm{z}),\atop%
\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm{x}_{\sigma}=\bm{x}_{0}+\sigma%
\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg%
}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle=\mathbb{E}_{\bm{z}\sim p_{Z},\bm{x}_{0}=g_{\theta}(\bm{z}),\atop%
\epsilon\sim\mathcal{N}(\bm{0},\mathcal{I}),\bm{x}_{\sigma}=\bm{x}_{0}+\sigma%
\epsilon}\bigg{\{}2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\operatorname{sg%
}[\theta],\sigma}(\bm{x}_{\sigma})\big{]}^{T}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\displaystyle\big{[}\bm{s}_{\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})%
-\nabla_{\bm{x}_{\sigma}}\log p(\bm{x}_{\sigma}|\bm{x}_{0})\big{]}\bigg{\}}
\displaystyle\mathcal{L}_{DFT}(\theta)=\mathcal{L}_{1}(\theta)+\mathcal{L}_{2}%
(\theta)
\displaystyle\mathcal{L}_{DFT}(\theta)=\mathcal{L}_{1}(\theta)+\mathcal{L}_{2}%
(\theta)
\mathcal{L}_{1}(\theta)
\mathcal{L}_{2}(\theta)
\log q(\bm{x})
p_{z}(\bm{z})
g_{\theta}(.)
\bm{s}_{\phi}(.)
(\theta^{(0)},\phi^{(0)})
t
\theta
\phi
x_{i}=\operatorname{sg}[g_{\theta^{(t)}}(\bm{z}_{i})],\bm{z}_{i}\sim p_{z}(\bm%
{z}),i=1,..,B
\phi
\theta
\phi
\theta
\theta
\bm{x}_{i}=g_{\theta^{(t)}}(\bm{z}_{i}),\bm{z}_{i}\sim p_{z}(\bm{z}),i=1,..,B
\theta
\theta^{(t+1)}
(\theta,\phi)
g_{\theta}(\cdot)
\bm{s}_{\phi}(\cdot)
\theta
g_{\theta}
\bm{s}_{\phi}
\phi
g_{\theta}
0.013\pm 0.001
0.044\pm 0.006
0.053\pm 0.002
0.057\pm 0.004
0.052\pm 0.001
0.024\pm 0.002
0.0367\pm 0.016
0.0545\pm 0.006
0.513\pm 0.040
0.0834\pm 0.007
0.0502\pm 0.002
0.0391\pm 0.006
0.776\pm 0.069
0.688\pm 0.027
1.498\pm 0.078
0.361\pm 0.023
0.189\pm 0.023
0.156\pm 0.017
1.681\pm 0.073
1.170\pm 0.030
2.673\pm 0.163
1.089\pm 0.035
0.612\pm 0.072
0.682\pm 0.045
0.107\pm 0.025
0.099\pm 0.008
0.152\pm 0.030
0.107\pm 0.020
0.116\pm 0.029
0.139\pm 0.030
0.141\pm 0.024
0.109\pm 0.020
0.284\pm 0.037
0.109\pm 0.021
0.144\pm 0.017
0.176\pm 0.057
0.277\pm 0.042
0.276\pm 0.018
0.691\pm 0.030
0.115\pm 0.024
0.231\pm 0.029
0.264\pm 0.055
0.669\pm 0.073
0.678\pm 0.016
1.198\pm 0.038
0.246\pm 0.037
0.387\pm 0.033
0.419\pm 0.046
0.094\pm 0.020
0.106\pm 0.020
0.134\pm 0.034
0.113\pm 0.020
0.135\pm 0.010
0.135\pm 0.033
0.109\pm 0.025
0.104\pm 0.018
0.137\pm 0.023
0.107\pm 0.016
0.132\pm 0.028
0.143\pm 0.024
0.114\pm 0.031
0.106\pm 0.018
0.205\pm 0.031
0.115\pm 0.017
0.129\pm 0.029
0.159\pm 0.038
0.199\pm 0.038
0.176\pm 0.033
0.501\pm 0.032
0.112\pm 0.019
0.176\pm 0.033
0.234\pm 0.046
0.102\pm 0.028
0.158\pm 0.019
0.150\pm 0.026
0.239\pm 0.013
0.269\pm 0.019
0.130\pm 0.026
0.206\pm 0.043
1.129\pm 0.197
1.531\pm 0.058
0.341\pm 0.039
0.396\pm 0.221
0.462\pm 0.065
0.091\pm 0.013
0.131\pm 0.011
0.121\pm 0.022
0.104\pm 0.013
0.129\pm 0.020
0.124\pm 0.018
0.095\pm 0.016
0.118\pm 0.013
0.157\pm 0.030
0.179\pm 0.028
7.837\pm 1.614
0.202\pm 0.037
0.099\pm 0.015
0.104\pm 0.015
0.123\pm 0.021
0.109\pm 0.015
0.115\pm 0.012
0.118\pm 0.024
0.098\pm 0.019
0.101\pm 0.025
0.121\pm 0.016
0.100\pm 0.013
0.081\pm 0.009
0.115\pm 0.018
\operatorname{Grad}_{2}(\theta)
\operatorname{Grad}_{2}(\theta)
p(w|\alpha)=\mathcal{N}(w;~{}0,\alpha^{-1})
\alpha
p(\alpha)=\text{Gamma}(\alpha;~{}1,0.01)
76.36\%
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\times
\times
\times
\times
\times
G
D
diffusion
energy\_fun
max\_iter
batch\_size
D
G
anneal
val\_interval
D\_steps
distill\_method
prefix
G
D
device\leftarrow^{\prime}cuda^{\prime}
Doptim\leftarrow Adam(D.parameters(),**D\_opt\_args)
Goptim\leftarrow Adam(G.parameters(),**G\_opt\_args)
iiter\in\{0,1,\ldots,max\_iter\}
distill\_method==^{\prime}dft-full^{\prime}
D.train().requires\_grad\_(True)
G.eval().requires\_grad\_(False)
\_\in\{1,2,\ldots,D\_steps\}
z\leftarrow\text{torch.randn}((batch\_size,G.latent\_dim,1,1)).cuda()
fake\_x\leftarrow G(z)
t\leftarrow\text{random choice from }\{1,2,\ldots,diffusion.T\}
fake\_t,t,noise,sigma\_t,g2\_t\leftarrow diffusion(fake\_x,t=t,return\_t=True)
wgt\leftarrow g2\_t/sigma\_t.square()
d\_loss\leftarrow 0.5\times wgt\times(D(fake\_t,t)+noise).square().sum([1,2,3])
d\_loss\leftarrow d\_loss.mean()
Doptim.zero\_grad()
d\_loss.backward()
Doptim.step()
d\_loss.item()
dlosses
D.eval().requires\_grad\_(False)
G.train().requires\_grad\_(True)
z\leftarrow\text{torch.randn}((batch\_size,G.latent\_dim,1,1)).to(device)
fake\_x\leftarrow G(z)
t\leftarrow\text{random choice from }\{7,8,\ldots,50\}
fake\_t,t,noise,sigma\_t,g2\_t\leftarrow diffusion(fake\_x,t=t,return\_t=True)
sigma\_t\leftarrow sigma\_t.view(-1,1,1,1)
{}_{f}ake\_t\leftarrow fake\_t.clone().detach().requires\_grad\_(True)
lam\leftarrow 1.0
score\_true\leftarrow\text{torch.autograd.grad}(energy\_fun(_{f}ake\_t,lam=lam%
).sum(),_{f}ake\_t,create\_graph=True,retain\_graph=True)[0]/sigma\_t
score\_fake\leftarrow D(_{f}ake\_t,t)/sigma\_t
score\_diff\leftarrow score\_fake-score\_true
cond\_score\leftarrow-noise/sigma\_t
dloss\_dx\leftarrow-2\times(score\_diff\times(score\_fake-cond\_score)).sum([1%
,2,3])
dloss\_dx\leftarrow sigma\_t**2\times\text{torch.autograd.grad}(dloss\_dx.sum(%
),_{f}ake\_t,create\_graph=False,retain\_graph=False)[0]
g\_loss\leftarrow g2\_t\times(dloss\_dx\times fake\_t).sum([1,2,3])
g\_loss\leftarrow g\_loss.mean()
Goptim.zero\_grad()
g\_loss.backward()
Goptim.step()
g\_loss.item()
glosses
iiter\mod val\_interval==0
\displaystyle\frac{\partial}{\partial\theta}\mathcal{D}_{FD}(\theta)=\frac{%
\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\|%
\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})\|_{2}^{2}
\displaystyle\frac{\partial}{\partial\theta}\mathcal{D}_{FD}(\theta)
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{\sigma}\sim p%
_{\theta,\sigma}}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\|_{2}^{2}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\epsilon\sim\mathcal{%
N}(0,\mathbf{I}),\atop\bm{z}\sim p_{z}}\|\bm{s}_{q}(g_{\theta}(\bm{z})+\sigma%
\epsilon)-\bm{s}_{\theta,\sigma}(g_{\theta}(\bm{z})+\sigma\epsilon)\|_{2}^{2}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\epsilon\sim\mathcal{%
N}(0,\mathbf{I}),\atop\bm{z}\sim p_{z}}\|\bm{s}_{q}(g_{\theta}(\bm{z})+\sigma%
\epsilon)-\bm{s}_{\theta,\sigma}(g_{\theta}(\bm{z})+\sigma\epsilon)\|_{2}^{2}
\displaystyle=\mathbb{E}_{\epsilon\sim\mathcal{N}(0,\mathbf{I}),\atop\bm{z}%
\sim p_{z}}\bigg{\{}\frac{\partial}{\partial}\big{\{}\|\bm{s}_{q}(=g_{\theta}(%
\bm{z})+\sigma\epsilon)-\bm{s}_{\theta,\sigma}(=g_{\theta}(\bm{z})+\sigma%
\epsilon)\|_{2}^{2}\big{\}}\frac{\partial g_{\theta}(\bm{z})+\sigma\epsilon}{%
\partial\theta}
\displaystyle=\mathbb{E}_{\epsilon\sim\mathcal{N}(0,\mathbf{I}),\atop\bm{z}%
\sim p_{z}}\bigg{\{}\frac{\partial}{\partial}\big{\{}\|\bm{s}_{q}(=g_{\theta}(%
\bm{z})+\sigma\epsilon)-\bm{s}_{\theta,\sigma}(=g_{\theta}(\bm{z})+\sigma%
\epsilon)\|_{2}^{2}\big{\}}\frac{\partial g_{\theta}(\bm{z})+\sigma\epsilon}{%
\partial\theta}
\displaystyle-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(%
\bm{x}_{\sigma})|_{\bm{x}_{\sigma}=g_{\theta}(\bm{z})+\sigma\epsilon}\bigg{\}}
\displaystyle-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(%
\bm{x}_{\sigma})|_{\bm{x}_{\sigma}=g_{\theta}(\bm{z})+\sigma\epsilon}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}\frac%
{\partial}{\partial}\big{\{}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,%
\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{\partial(\theta)}{\partial%
\theta}-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bigg{\{}\frac%
{\partial}{\partial}\big{\{}\|\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,%
\sigma}(\bm{x}_{\sigma})\|_{2}^{2}\big{\}}\frac{\partial(\theta)}{\partial%
\theta}-2\big{[}\bm{s}_{q}(\bm{x}_{\sigma})-\bm{s}_{\theta,\sigma}(\bm{x}_{%
\sigma})\big{]}^{T}\frac{\partial}{\partial\theta}\bm{s}_{\theta,\sigma}(\bm{x%
}_{\sigma})\bigg{\}}
\displaystyle=\operatorname{Grad}_{1}(\theta)+\operatorname{Grad}_{1}(\theta).
\displaystyle=\operatorname{Grad}_{1}(\theta)+\operatorname{Grad}_{1}(\theta).
\bm{u}(\cdot)
q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})=\mathcal{N}(\bm{x}_{\sigma};\bm{x}_{0},%
\sigma^{2}\mathcal{I})
\displaystyle\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta}\atop\bm{x}_{\sigma}|\bm{x%
}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bm{u}(\bm{x}_{\sigma},\theta%
)^{T}\bigg{\{}\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})-\nabla_{\bm{x}_{t}}\log q%
_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\bigg{\}}=0,~{}~{}~{}\forall\theta.
\displaystyle\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta}\atop\bm{x}_{\sigma}|\bm{x%
}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bm{u}(\bm{x}_{\sigma},\theta%
)^{T}\bigg{\{}\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})-\nabla_{\bm{x}_{t}}\log q%
_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\bigg{\}}=0,~{}~{}~{}\forall\theta.
p_{\sigma,\theta}
\bm{s}_{\theta,\sigma}
\displaystyle p_{\sigma,\theta}(\bm{x}_{\sigma})=\int q_{\sigma}(\bm{x}_{%
\sigma}|\bm{x}_{0})p_{\theta,0}(\bm{x}_{0})\mathrm{d}\bm{x}_{0}
\displaystyle p_{\sigma,\theta}(\bm{x}_{\sigma})
\displaystyle=\int q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{\theta,0}(\bm{x}_{%
0})\mathrm{d}\bm{x}_{0}
\displaystyle\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})=\int\nabla_{\bm{x}_{%
\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{q_{\sigma}(\bm{x}_{%
\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0})}{p_{\sigma,\theta}(\bm{x}_{\sigma}%
)}\mathrm{d}\bm{x}_{0}.
\displaystyle\bm{s}_{\theta,\sigma}(\bm{x}_{\sigma})
\displaystyle=\int\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{%
x}_{0})\frac{q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0})}{p%
_{\sigma,\theta}(\bm{x}_{\sigma})}\mathrm{d}\bm{x}_{0}.
\bm{u}
\bm{u}(\bm{x}_{\sigma},\theta)
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bm{u}^{T}\bm{s%
}_{\theta,\sigma}(\bm{x}_{\sigma})=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,%
\theta}}\bm{u}^{T}\int\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|%
\bm{x}_{0})\frac{q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0}%
)}{p_{\sigma,\theta}(\bm{x}_{\sigma})}\mathrm{d}\bm{x}_{0}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bm{u}^{T}\bm{s%
}_{\theta,\sigma}(\bm{x}_{\sigma})
\displaystyle=\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\sigma,\theta}}\bm{u}^{T}\int%
\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{q_{%
\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0})}{p_{\sigma,\theta}%
(\bm{x}_{\sigma})}\mathrm{d}\bm{x}_{0}
\displaystyle=\int p_{\sigma,\theta}(\bm{x}_{\sigma})\bm{u}^{T}\int\nabla_{\bm%
{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{q_{\sigma}(\bm{x%
}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0})}{p_{\sigma,\theta}(\bm{x}_{%
\sigma})}\mathrm{d}\bm{x}_{0}\mathrm{d}\bm{x}_{\sigma}
\displaystyle=\int p_{\sigma,\theta}(\bm{x}_{\sigma})\bm{u}^{T}\int\nabla_{\bm%
{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{q_{\sigma}(\bm{x%
}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}_{0})}{p_{\sigma,\theta}(\bm{x}_{%
\sigma})}\mathrm{d}\bm{x}_{0}\mathrm{d}\bm{x}_{\sigma}
\displaystyle=\int\int\bm{u}^{T}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}%
_{\sigma}|\bm{x}_{0})q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}%
_{0})\mathrm{d}\bm{x}_{0}\mathrm{d}\bm{x}_{\sigma}
\displaystyle=\int\int\bm{u}^{T}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}%
_{\sigma}|\bm{x}_{0})q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})p_{0,\theta}(\bm{x}%
_{0})\mathrm{d}\bm{x}_{0}\mathrm{d}\bm{x}_{\sigma}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bm{u}^{T}\nabla_{\bm{x}_{%
\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bm{u}^{T}\nabla_{\bm{x}_{%
\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})
\theta
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\frac{%
\partial}{\partial\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{%
\partial\theta}\bm{s}_{\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}+\mathbb{E}_{%
\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\frac{\partial}{\partial\bm{x}_{\sigma}}%
\bigg{\{}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\bm{s}_{\sigma,\theta}(\bm{x}_{%
\sigma})\bigg{\}}\frac{\partial\bm{x}_{\sigma}}{\partial\theta}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\frac{%
\partial}{\partial\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{%
\partial\theta}\bm{s}_{\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}+\mathbb{E}_{%
\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\frac{\partial}{\partial\bm{x}_{\sigma}}%
\bigg{\{}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\bm{s}_{\sigma,\theta}(\bm{x}_{%
\sigma})\bigg{\}}\frac{\partial\bm{x}_{\sigma}}{\partial\theta}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\frac{\partial}{\partial%
\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\nabla_{\bm{x}_{\sigma}}\log q_{%
\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})+\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},%
\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}%
\bigg{\{}\frac{\partial}{\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma%
},\theta)^{T}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0%
})\bigg{]}\frac{\partial\bm{x}_{\sigma}}{\partial\theta}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\frac{\partial}{\partial%
\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\nabla_{\bm{x}_{\sigma}}\log q_{%
\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})+\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},%
\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}%
\bigg{\{}\frac{\partial}{\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma%
},\theta)^{T}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0%
})\bigg{]}\frac{\partial\bm{x}_{\sigma}}{\partial\theta}
\displaystyle+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\bm{x}%
_{0}}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{%
\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\displaystyle+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\bm{x}%
_{0}}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\frac{%
\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\frac{\partial}{%
\partial\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\bigg{\}}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{%
\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\frac{\partial}{%
\partial\theta}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\nabla_{\bm{x}_{\sigma}}\log q%
_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})
\bm{u}(\bm{x}_{\sigma},\theta)
\frac{\partial}{\partial\theta}\bm{u}(\bm{x}_{\sigma},\theta)
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\bm{u}%
(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\theta}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\bigg{\}}+\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,%
\sigma}}\frac{\partial}{\partial\bm{x}_{\sigma}}\bigg{\{}\bm{u}(\bm{x}_{\sigma%
},\theta)^{T}\bm{s}_{\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}\frac{\partial\bm%
{x}_{\sigma}}{\partial\theta}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\bm{u}%
(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\theta}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\bigg{\}}+\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,%
\sigma}}\frac{\partial}{\partial\bm{x}_{\sigma}}\bigg{\{}\bm{u}(\bm{x}_{\sigma%
},\theta)^{T}\bm{s}_{\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}\frac{\partial\bm%
{x}_{\sigma}}{\partial\theta}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\frac{\partial}{%
\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\nabla_{\bm{%
x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\bigg{]}\frac{\partial%
\bm{x}_{\sigma}}{\partial\theta}+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{%
\partial}{\partial\bm{x}_{0}}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{%
\sigma}|\bm{x}_{0})\frac{\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\frac{\partial}{%
\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\nabla_{\bm{%
x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})\bigg{]}\frac{\partial%
\bm{x}_{\sigma}}{\partial\theta}+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{%
\partial}{\partial\bm{x}_{0}}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{%
\sigma}|\bm{x}_{0})\frac{\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\bm{u}%
(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\theta}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\bigg{\}}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}\bm{u}%
(\bm{x}_{\sigma},\theta)^{T}\frac{\partial}{\partial\theta}\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\frac{\partial}{%
\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\big{\{}%
\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\theta,\sigma}(\bm{x}_{\sigma})\big{\}}\bigg{]}\frac{\partial\bm{x}_{\sigma}}{%
\partial\theta}+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial\nabla_{\bm{x}%
_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}{\partial\bm{x}_{0}}%
\frac{\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\displaystyle=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},\atop\bm{x}_{\sigma}|\bm%
{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}\bigg{\{}\frac{\partial}{%
\partial\bm{x}_{\sigma}}\bigg{[}\bm{u}(\bm{x}_{\sigma},\theta)^{T}\big{\{}%
\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\theta,\sigma}(\bm{x}_{\sigma})\big{\}}\bigg{]}\frac{\partial\bm{x}_{\sigma}}{%
\partial\theta}+\bm{u}(\bm{x}_{\sigma},\theta)^{T}\frac{\partial\nabla_{\bm{x}%
_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}{\partial\bm{x}_{0}}%
\frac{\partial\bm{x}_{0}}{\partial\theta}\bigg{\}}
\displaystyle\mathcal{L}_{2}(\theta)=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},%
\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}%
\bigg{\{}\bm{u}(\bm{x}_{\sigma},\operatorname{sg}[\theta])^{T}\big{\{}\nabla_{%
\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})\big{\}}\bigg{\}}
\displaystyle\mathcal{L}_{2}(\theta)=\mathbb{E}_{\bm{x}_{0}\sim p_{0,\theta},%
\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})}%
\bigg{\{}\bm{u}(\bm{x}_{\sigma},\operatorname{sg}[\theta])^{T}\big{\{}\nabla_{%
\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\operatorname{sg}[\theta],\sigma}(\bm{x}_{\sigma})\big{\}}\bigg{\}}
\bm{u}(\bm{x}_{\sigma},\theta)=-2\big{\{}\nabla_{\bm{x}_{\sigma}}\log q_{%
\sigma}(\bm{x}_{\sigma})-\bm{s}_{\sigma,\theta}(\bm{x}_{\sigma})\big{\}}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}-2\big%
{\{}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma})-\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\big{\}}^{T}\frac{\partial}{\partial\theta}\bm{s}_{%
\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}
\displaystyle\mathbb{E}_{\bm{x}_{\sigma}\sim p_{\theta,\sigma}}\bigg{\{}-2\big%
{\{}\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma})-\bm{s}_{\sigma,%
\theta}(\bm{x}_{\sigma})\big{\}}^{T}\frac{\partial}{\partial\theta}\bm{s}_{%
\sigma,\theta}(\bm{x}_{\sigma})\bigg{\}}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{0}\sim p_{0,%
\theta},\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_%
{0})}\bigg{\{}\bm{u}(\bm{x}_{\sigma},\operatorname{sg}[\theta])^{T}\big{\{}%
\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\operatorname{sg}[\theta]}(\bm{x}_{\sigma},t)\big{\}}\bigg{\}}
\displaystyle=\frac{\partial}{\partial\theta}\mathbb{E}_{\bm{x}_{0}\sim p_{0,%
\theta},\atop\bm{x}_{\sigma}|\bm{x}_{0}\sim q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_%
{0})}\bigg{\{}\bm{u}(\bm{x}_{\sigma},\operatorname{sg}[\theta])^{T}\big{\{}%
\nabla_{\bm{x}_{\sigma}}\log q_{\sigma}(\bm{x}_{\sigma}|\bm{x}_{0})-\bm{s}_{%
\operatorname{sg}[\theta]}(\bm{x}_{\sigma},t)\big{\}}\bigg{\}}
p(w\mid\alpha)=\mathcal{N}\left(w;0,\alpha^{-1}\right)
p(\alpha)=\operatorname{Gamma}(\alpha;1,0.01)
0.0002
0.1/(t+1)^{0.55}
1e-07
E_{d}(.)
\sigma_{min}=0.3
\sigma_{max}=3.0
E_{\sigma}(\bm{x})=f(\bm{x})/\sigma
S_{\sigma}(\bm{x})\coloneqq S(\bm{x})/\sigma
\sigma
[\sigma_{min},\sigma_{max}]
\sigma^{2}
\beta_{0}=0.9
\beta_{1}=0.99
\beta_{0}=0
\beta_{1}=0.99
