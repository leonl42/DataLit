\mathcal{D}=\{(\mathbf{X}^{(k)},Y^{(k)})\}_{k=1}^{|\mathcal{D}|}
\mathbf{X}
L
\mathbf{X}=\{X_{l}\}_{l=0}^{L-1}
X_{l}
l
Y
N_{\mathbf{X}}
X_{l}
\mathbf{X}
X_{l}
N_{\mathbf{X}}
Y
N
\mathbf{X}
\Pr\big{(}Y=\{y_{n}\}_{n=1}^{N}\mid\mathbf{X}\big{)}
\mathbf{X}
\Phi
(L\times N_{\mathbf{X}})
\{(z_{l,0},\ldots,z_{l,N_{\mathbf{X}}-1})\}_{l=0}^{L-1}
z_{l,n}
\Phi
z\in\mathcal{Z}\subseteq\mathbb{R}^{d}
d
\widehat{Y}=\{\widehat{y}_{n}\}_{n=1}^{N}
\Psi
\widehat{Y}\sim\Psi\big{(}\cdot\mid z\big{)}:=\prod_{n=1}^{N}\Psi\big{(}%
\widehat{y}_{n}\mid\widehat{y}_{0},\ldots,\widehat{y}_{n-1};z\big{)}
\widehat{y}_{0}
z=\Phi(\mathbf{X})
\mathcal{M}=(\mathcal{S},\mathcal{A},P,r,s_{0},\gamma)
\mathcal{S}
s_{0}\in\mathcal{S}
\mathcal{A}
a\in\mathcal{A}
P
r
\pi^{*}
\pi^{*}\!\in\!\arg\max_{\pi}J_{\pi}
J_{\pi}\!:=\!\mathbb{E}[\sum_{k=0}^{\infty}\gamma^{t}r_{t}\!\mid\!P,s_{0},\pi]
\texttt{LM}_{0}:=(\Phi,\mathcal{G}_{0},\Psi)
\mathcal{G}_{0}\circ\Phi
\Phi
\mathbf{X}
\mathcal{Z}\subseteq\mathbb{R}^{d}
\mathcal{G}_{0}(z^{\prime}|z):=\mathcal{N}\big{(}\mu_{0}(z),\sigma_{0}^{2}(z)%
\mathbf{I}_{d\times d}\big{)}
\Psi
\texttt{LM}_{0}
\widehat{Y}_{0}
z^{\prime}
\Psi(\widehat{Y}_{0}|z^{\prime})
\;z^{\prime}\sim\mathcal{G}_{0}(\cdot|z)
\texttt{LM}_{0}(Y|\mathbf{X}):=\mathbb{E}_{z^{\prime}\sim\mathcal{G}_{0}(\cdot%
|z),z=\Phi(\mathbf{X})}[\Psi(Y|z^{\prime})]
\mathcal{Z}
\Phi
\Psi\circ\mathcal{G}_{i}
\forall i
\mu
Q
\Phi
\Psi\circ\mathcal{G}_{i}
\forall i
\mu
Q
\texttt{LM}_{0}
m
\{\mathcal{G}_{i}\}_{i=1}^{m},\;\mathcal{G}_{i}(z^{\prime}|z)=\mathcal{N}\big{%
(}\mu_{i}(z),\sigma_{i}^{2}(z)\mathbf{I}_{d\times d}\big{)}
\mathcal{Z}
m
\{\texttt{LM}_{i}\}_{i=1}^{m},\;\texttt{LM}_{i}:=(\Phi,\mathcal{G}_{i},\Psi)
\widehat{Y}_{i}
\mathbf{X}
\mu
z=\Phi(\mathbf{X})
\{\widehat{Y}_{i}\}_{i=0}^{m}
{Y}\sim\mu(\cdot\mid z,\{\widehat{Y}_{i}\}_{i=0}^{m})
s=\mathbf{X}
a=Y
\pi_{\text{MoE}}(a|s)=\int_{\{\hat{a}_{i},z^{\prime}_{i}\}_{i=0}^{m}}\!\!\mu%
\big{(}a|\Phi(s),\!\{\hat{a}_{i}\}_{i=0}^{m}\big{)}\;\prod_{i=0}^{m}d\Psi(\hat%
{a}_{i}|z_{i}^{\prime})\;d\mathcal{G}_{i}(z_{i}^{\prime}|\Phi(x)).
\texttt{LM}_{0}
\!\!\!\min_{(\Phi,\mathcal{G}_{0},\Psi),\rho}\,\,\widehat{\mathbb{E}}_{z^{%
\prime}\sim\rho(\cdot|z,Y),z=\Phi(\mathbf{X})}\big{[}-\log\Psi(Y|z^{\prime})%
\big{]}\,\,\,\,\text{s.t. }\,\widehat{\mathbb{E}}_{z=\Phi(\mathbf{X})}\!\big{[%
}\text{KL}\big{(}\rho(z^{\prime}|z,\!Y)||\mathcal{G}_{0}(z^{\prime}|z)\big{)}%
\big{]}\!\leq\!\epsilon_{\text{KL}}.
\widehat{\mathbb{E}}
(\mathbf{X},Y)
\mathcal{D}
\rho
z
Y
\epsilon_{\text{KL}}
\rho(\cdot|z,Y)
\mathcal{N}\big{(}\mu_{\rho}(z,\Phi_{\rho}(Y)),\sigma_{\rho}^{2}(z,\Phi_{\rho}%
(Y))\mathbf{I}_{d\times d}\big{)}
\Phi_{\rho}
Y
\mu_{\rho}(\cdot,\cdot)
\sigma_{\rho}^{2}(\cdot,\cdot)
Y
z^{\prime}
\mathcal{G}_{0}(\cdot|z)
\rho(\cdot|z,Y)
\{\texttt{LM}_{i}\}_{i=1}^{m}
\mathcal{D}
(\Phi,\Psi)
i
\mathcal{G}_{i}(\cdot|z)
\mathcal{Z}
\mathcal{G}_{i}(\cdot|z)
\min_{\mathcal{G}_{i}}\,\,\widehat{\mathbb{E}}_{z^{\prime}\sim\mathcal{G}_{i}(%
\cdot|z),z=\Phi(\mathbf{X}),Y\sim\Psi(\cdot|z^{\prime})}[-\ell_{i}(\mathbf{X},%
Y)],
\ell_{i}(\mathbf{X},Y)\in\mathbb{R}
i
\ell_{i}(\mathbf{X},Y)
Y
Y
i
\ell_{i}
i
\mathcal{Z}
\mathcal{G}_{i}
\{\mathcal{G}_{i}\}_{i=1}^{m}
(\mu_{i},\sigma_{i})
\alpha\cdot\mathbb{E}_{z^{\prime}\sim\mathcal{G}_{i}(\cdot|z),Y\sim\Psi(\cdot|%
z^{\prime})}[\ell_{i}(\mathbf{X},Y)\cdot\nabla_{\{\mu_{i},\sigma_{i}\}}\log%
\mathbb{P}_{\mathcal{G}_{i}}(z^{\prime}|z)]
\alpha>0
\mathcal{D}
(\mathbf{X},Y,X_{+})\sim\mathcal{D}
\mathcal{D}
X_{+}
s:=\mathbf{X}
a:=Y
r(X_{+})
s_{+}:=(\mathbf{X},Y,X_{+})
Q
\;\min_{Q}\;\mathbb{E}_{(s,a,r,s_{+})\sim\mathcal{D}}[(r+\gamma\max_{a_{+}}Q(s%
_{+},a_{+})-Q(s,a))^{2}]
Q
a_{+}
Q
\texttt{LM}_{0}
\mathcal{D}
(s,a,r,s_{+})
z=\Phi(s)
z_{a}=\Phi((s,a))
z_{+}=\Phi(s_{+})
\Phi(\mathcal{D})
(z,z_{a},r,z_{+})
V(z)
Q(z_{a})
\mathcal{G}(z^{\prime}|z)
\mathcal{G}_{0}
\displaystyle L_{Q}\!=\!\mathbb{E}_{(z,z_{a},r,z_{+})\sim\Phi(\mathcal{D})}[(r%
\!+\!\gamma V_{\text{tar}}(z_{+})\!-\!Q(z_{a}))^{2}]
\displaystyle L_{Q}
\displaystyle\!=\!\mathbb{E}_{(z,z_{a},r,z_{+})\sim\Phi(\mathcal{D})}[(r\!+\!%
\gamma V_{\text{tar}}(z_{+})\!-\!Q(z_{a}))^{2}]
\displaystyle L_{V}\!=\!\mathbb{E}_{z\sim\Phi(\mathcal{D}),(\hat{a},z^{\prime}%
)\sim\Psi\circ\mathcal{G}(.|z)}\!\left[Q_{\text{tar}}(z_{\hat{a}})-\alpha\log%
\mathcal{G}(z^{\prime}|z)\!-\!V(z)^{2}\right]
\displaystyle L_{V}
\displaystyle\!=\!\mathbb{E}_{z\sim\Phi(\mathcal{D}),(\hat{a},z^{\prime})\sim%
\Psi\circ\mathcal{G}(.|z)}\!\left[Q_{\text{tar}}(z_{\hat{a}})-\alpha\log%
\mathcal{G}(z^{\prime}|z)\!-\!V(z)^{2}\right]
\displaystyle L_{\mathcal{G}}\!=\!\mathbb{E}_{z\sim\Phi(\mathcal{D}),(\hat{a},%
z^{\prime})\sim\Psi\circ\mathcal{G}(.|z)}\!\left[Q(z_{\hat{a}})\!-\!\alpha\log%
\mathcal{G}(z^{\prime}|z)\right],
\displaystyle L_{\mathcal{G}}
\displaystyle\!=\!\mathbb{E}_{z\sim\Phi(\mathcal{D}),(\hat{a},z^{\prime})\sim%
\Psi\circ\mathcal{G}(.|z)}\!\left[Q(z_{\hat{a}})\!-\!\alpha\log\mathcal{G}(z^{%
\prime}|z)\right],
(V,Q)
\alpha>0
(V_{\text{tar}},Q_{\text{tar}})
z^{\prime}\sim\mathcal{G}(.|z)
\mathcal{G}
\hat{a}\sim\Psi(z^{\prime})
\Psi\circ\mathcal{G}
z_{\hat{a}}=\Phi((\mathbf{X},\hat{a}))
z^{\prime}
\Psi
\Psi
\log\mathcal{G}(z^{\prime}|z)
\log(\mathcal{G}(z^{\prime}|z)/\mathcal{G}_{0}(z^{\prime}|z))
(\Phi,\Psi)
Q
Q
Q
Q
Q
Q
Q
Q
V(z)
L_{V}=\mathbb{E}_{(z,z_{a})\sim\Phi(\mathcal{D})}[L_{2}^{\tau}(Q_{\text{tar}}(%
z_{a})-V(z))]
L^{\tau}_{2}
\tau
Q
Q(z_{a})\approx r+\gamma V(z_{+})
V
\tau
Q(z_{a})
z
\tau
\tau\rightarrow 1
Q
Q^{*}(z_{a})
\mathbb{E}_{(z_{a},r,z_{+})\sim\Phi(\mathcal{D})}[(r+\gamma\max_{a_{+}}Q^{*}(z%
_{+,a_{+}})-Q^{*}(z_{a}))^{2}]\rightarrow 0
z_{+,a_{+}}=\Phi((\mathbf{X},a,X_{+},a_{+}))
a_{+}
V
\hat{a}\sim\Psi\circ\mathcal{G}
\Psi\circ\mathcal{G}
\Psi_{\text{TF}}(a)\circ\mathcal{G}
a=Y
\mathcal{D}
\mathcal{G}
\hat{a}
\mu
z=\Phi(\mathbf{X})
m+1
\{\widehat{Y}_{i}\}_{i=0}^{m}
a\sim\mu(\cdot\mid z,\{\widehat{Y}_{i}\}_{i=0}^{m})
Q
{Q}(z_{a})
\mu
\mu(a\mid z,\{\widehat{Y}_{i}\}_{i=0}^{m})\propto\exp(\beta\cdot Q(z_{a}))
\beta>0
Q
\mu
\{\widehat{Y}_{i}\}_{i=0}^{m}
\Phi(D)=\{(z,z_{a},r,z_{+})\}
\{\mathcal{G}_{i}\}_{i=0}^{m}
V(z)
L_{V}=\tfrac{1}{m+1}\sum_{i=0}^{m}\mathbb{E}_{z,\hat{a}_{i}\sim\Psi\circ%
\mathcal{G}_{i}(\cdot|z)}\big{[}L_{2}^{\tau}\big{(}Q_{\text{tar}}(z_{\hat{a}_{%
i}})-V(z)\big{)}\big{]},
z_{\hat{a}_{i}}=\Phi((\mathbf{X},\hat{a}_{i}))
i
L^{\tau}_{2}
Q
m+1
\Phi(D)_{\text{SA}}=\{(z,z_{a},r,z_{+},\{z_{\widehat{Y}_{i}}\}_{i=0}^{m})\}
\{z_{\widehat{Y}_{i}}\}_{i=0}^{m}
\tfrac{1}{m+1}\sum_{i=0}^{m}\mathbb{E}_{(z,\{z_{\widehat{Y}_{i}}\}_{i=0}^{m})%
\sim\Phi(\mathcal{D})_{\text{SA}}}[L_{2}^{\tau}(Q_{\text{tar}}(z_{\widehat{Y}_%
{i}})-V(z))]
Q
Q
\bar{\mathcal{M}}=(\bar{\mathcal{S}},\bar{\mathcal{A}},\bar{P},\bar{r},\bar{s}%
_{0},\gamma)
\mathcal{Z}
m+1
\bar{\mathcal{S}}=\mathcal{Z}\times\mathcal{A}^{m+1}
m+1
\bar{\mathcal{A}}=\{0,\ldots,m\}
\bar{s}_{0}
\lambda
\;\lambda^{*}\in\arg\max_{\lambda}J_{\lambda}:=\mathbb{E}[\sum_{k=0}^{\infty}%
\gamma^{t}\bar{r}_{t}\mid\bar{P},\bar{s}_{0},\lambda]
\max_{\lambda\in\Delta^{m+1}}\sum_{i=0}^{m}\lambda(i)V^{i}(z)+\mathcal{U}(\bar%
{\mathcal{M}})
V^{i}
i^{\text{th}}
\mathcal{U}(\bar{\mathcal{M}})>0
(m+1)
L_{Q}=\sum_{i=0}^{m}\mathbb{E}_{z,z_{a},r,z_{+}}\big{[}(r+\gamma V^{i}_{\text{%
tar}}(z_{+})-Q^{i}(z_{a}))^{2}\big{]},\;\;\;L_{V}=\sum_{i=0}^{m}\mathbb{E}_{z,%
\hat{a}_{i}\sim\Psi\circ\mathcal{G}_{i}(\cdot|z)}\big{[}(Q^{i}_{\text{tar}}(z_%
{\hat{a}_{i}})-V^{i}(z))^{2}\big{]},
Q^{i}
V^{i}
i
\mathcal{D}
L_{V}=\sum_{i=0}^{m}\mathbb{E}_{z,z_{a},Y}\big{[}\mathbf{1}_{i=i(z,Y)}\cdot%
\big{(}Q^{i}_{\text{tar}}(z_{a})-V^{i}(z)\big{)}^{2}\big{]},
\mathbf{1}_{i=i(z,z_{a})}
i(z,Y):=\arg\max_{i}\log\Psi(Y|z^{i,\prime})
z^{i,\prime}\sim\mathcal{G}_{i}(\cdot|z)
\mu(a\mid z,\{\widehat{Y}_{i}\}_{i=0}^{m})\propto\exp(\beta Q^{i(z,a)}(z_{a}))
(m+1)
\Lambda
L_{\Lambda}=\mathbb{E}_{z,Y,r,z_{+}}\big{[}\big{(}r+\gamma\max_{i_{+}}\Lambda_%
{\text{tar}}(z_{+},i_{+})-\Lambda(z,i(z,Y))\big{)}^{2}\big{]},
\Lambda_{\text{tar}}
\Lambda
i_{+}
i(z,Y)
Y
\Lambda^{*}(z,i)
\lambda^{*}(z):=\arg\max_{i}\Lambda^{*}(z,i)
\mu(a\mid z,\{\widehat{Y}_{i}\}_{i=0}^{m})\propto\exp(\beta Q^{\lambda^{*}(z)}%
(z_{a}))
Q^{\lambda^{*}(z)}(z_{a})
r(X_{+}):=\ell_{\text{sent}}(X_{+})
\ell_{\text{sent}}(X)
[-1,1]
10
m=9
5
\gamma=0.8
5
\mathbb{E}_{\mathbf{X}_{0}\sim\mathcal{D}}[\sum_{i=0}^{4}\gamma^{i}r(X_{i+1})|%
Y_{i}\sim\text{LM}(.|\mathbf{X}_{i}),X_{i+1}\sim P_{\text{Dialog-GPT}}(.|%
\mathbf{X}_{i},Y_{i})]
Q
V
P_{\text{user}}(X_{+}|z_{Y})
L_{P_{\text{user}}}=\mathbb{E}_{(z_{a},r)\sim\mathcal{D},\hat{X}_{+}\sim P_{%
\text{user}}(.|z_{a})}[(r-r(\hat{X}_{+}))^{2}]
Q
Q(z_{a})\approx r(\hat{X}_{+})+\gamma V(\hat{z}_{+})
\hat{X}_{+}
P_{\text{user}}(.|z_{a})
0.53\pm 0.47
\mathbf{4.25\pm 0.12}
\mathbf{-1.32\pm 0.19}
\mathbf{1.47\pm 0.15}
\mathbf{0.97\pm 0.52}
4.13\pm 0.21
-1.55\pm 0.19
0.36\pm 0.26
0.10\pm 0.40
4.06\pm 0.25
-1.51\pm 0.20
0.21\pm 0.21
0.31\pm 0.46
3.69\pm 0.37
-1.46\pm 0.21
-0.07\pm 0.25
-0.65\pm 0.41
-2.18\pm 0.36
\mathbf{4.3\pm 0.16}
1.3\pm 0.17
0.97\pm 0.52
4.25\pm 0.12
-1.32\pm 0.19
1.47\pm 0.15
0.81\pm 0.42
\mathbf{4.65\pm 0.06}
-1.34\pm 0.25
2.61\pm 0.24
\mathbf{1.14\pm 0.49}
4.59\pm 0.07
\mathbf{-0.39\pm 0.24}
3.51\pm 0.19
0.72\pm 0.47
4.46\pm 0.10
-0.58\pm 0.24
\mathbf{3.62\pm 0.17}
\texttt{LM}_{0}=(\Phi,\mathcal{G}_{0},\Psi)
\mathcal{G}_{0}
\Phi,\Psi
\mu
Q
Q
Q
\mathcal{G}
\mathcal{G}_{0}
\mathbb{E}_{\mathcal{G}(\cdot|z)}[\log(\mathcal{G}(z^{\prime}|z)/\mathcal{G}_{%
0}(z^{\prime}|z))]
Q
Q
Q
\gamma=0
Q
Q
600
80
0.67\pm 0.26
0.24\pm 0.50
0.62\pm 0.27
0.66\pm 0.47
0.84\pm 0.24
0.72\pm 0.46
0.81\pm 0.19
0.57\pm 0.50
\mathbf{0.88\pm 0.24}
\mathbf{0.76\pm 0.48}
0.72\pm 0.28
0.70\pm 0.45
200
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\pm
\{\mathcal{G}_{i}\}
1.0
\{\mathcal{G}_{i}\}
\{\mathcal{G}_{i}\}
\{\mathcal{G}_{i}\}
Q
V
Q,V
2\times 10^{-3}
\tau
6
\ell_{\text{pos-sent}}(Y)
\ell_{\text{neg-sent}}(Y)
\ell_{\text{joy}}(Y)
\ell_{\text{optimism}}(Y)
\ell_{\text{anger}}(Y)
\ell_{\text{sadness}}(Y)
\ell_{\text{sent-coh}}(\mathbf{X},Y)
\ell_{\text{question}}(Y)
\ell_{\text{exp}}(\mathbf{X},Y)
\theta=42M
\phi=16M
\phi\textquoteright=12M
m
m
2\phi+(m+2)\theta
2\phi+(m+2)\theta
2\phi+(m+2)\theta
2\phi+(m+2)\theta
2\phi^{\prime}+(m+2)\theta
2\phi^{\prime}+(m+2)\theta
3\phi^{\prime}+(m+2)\theta
80
600
0
1
0
1
600
N
S_{\text{task}}(N)
[0,1]
N
S_{\text{task}}(N)/N
G(N)
N
(1-G(N))/N
N=100
S_{\text{task}}(N)
G(N)
