\mathcal{L}_{exp}
\mathcal{L}_{imp}
\mathcal{L}_{exp}
\mathcal{L}_{imp}
\mathcal{L}_{exp}
\mathcal{L}_{imp}
\mathcal{L}_{exp}
\mathcal{L}_{imp}
\mathcal{G}
\mathcal{G}=(\mathcal{E},\mathcal{R},\mathcal{T},\mathcal{D})
\mathcal{E}
\mathcal{R}
\mathcal{D}
\mathcal{D}_{e}
\mathcal{D}_{r}
e
r
\mathcal{T}=\{(h,r,t)|h,t\in\mathcal{E},r\in\mathcal{R}\}
(h,r,t)
r
h
t
E_{LLM}
\{(\mathcal{D}_{hr},\mathcal{D}_{t})\}_{i=1}^{N}
\mathcal{D}_{t}
\mathcal{D}_{hr}
(\mathcal{D}_{hr},\mathcal{D}_{t})
E_{LLM}
\mathcal{D}_{hr}
\mathcal{D}_{t}
E_{LLM}
\displaystyle e_{hr}=E_{LLM}(\texttt{[bos]}_{hr}\oplus\mathcal{D}_{hr}\oplus%
\texttt{[eos]}_{hr}),
\displaystyle e_{hr}=E_{LLM}(\texttt{[bos]}_{hr}\oplus\mathcal{D}_{hr}\oplus%
\texttt{[eos]}_{hr}),
\displaystyle e_{t}=E_{LLM}(\texttt{[bos]}_{t}\oplus\mathcal{D}_{t}\oplus%
\texttt{[eos]}_{t}),
\displaystyle e_{t}=E_{LLM}(\texttt{[bos]}_{t}\oplus\mathcal{D}_{t}\oplus%
\texttt{[eos]}_{t}),
\oplus
\mathcal{D}_{hr}=\mathcal{D}_{h}\oplus\mathcal{D}_{r}
\texttt{[bos]}_{hr}
\texttt{[eos]}_{hr}
\texttt{[bos]}_{t}
\texttt{[eos]}_{t}
\ell_{r}
\ell_{c}
\displaystyle\ell_{r}=-\log\frac{e^{(\phi(e_{hr},e_{t})-\gamma)/\tau}}{e^{(%
\phi(e_{hr},e_{t})-\gamma)/\tau}+\sum\nolimits_{i=1}^{\mathcal{N}}e^{\phi(e_{%
hr},e_{t_{i}^{\prime}})/\tau}},
\displaystyle\ell_{r}=-\log\frac{e^{(\phi(e_{hr},e_{t})-\gamma)/\tau}}{e^{(%
\phi(e_{hr},e_{t})-\gamma)/\tau}+\sum\nolimits_{i=1}^{\mathcal{N}}e^{\phi(e_{%
hr},e_{t_{i}^{\prime}})/\tau}},
\mathcal{N}
\tau
\phi
\gamma
\ell_{r}
\ell_{c}
\mathcal{L}_{exp}=\frac{1}{\mathcal{N}}\underset{(\mathcal{D}_{hr},\mathcal{D}%
_{t})}{\sum}(\ell_{r}+\ell_{c})/2.
\mathcal{D}_{hr}
\mathcal{D}_{t}
\mathcal{L}_{imp}=\frac{1}{\mathcal{M}}\underset{(\mathcal{D}_{hr},\mathcal{D}%
_{t})}{\sum}-\log P(\mathcal{D}_{t}|\texttt{inst},\mathcal{D}_{hr}),
\mathcal{M}
\mathcal{L}_{exp}
\mathcal{L}_{imp}
\mathcal{L}_{KaLM}=\mathcal{L}_{exp}+\lambda\cdot\mathcal{L}_{imp},
\lambda
\mathcal{N}
\mathcal{M}
f
E_{LLM}
\ell_{\texttt{align}}(f;\alpha)\triangleq\underset{(\mathcal{D}_{hr},\mathcal{%
D}_{t})\sim p_{\texttt{pos}}}{\mathbb{E}}\left[\|f(\mathcal{D}_{hr})-f(%
\mathcal{D}_{t})\|_{2}^{\alpha}\right],
\ell_{\texttt{uniform}}(f;t)\triangleq\log\underset{\mathcal{D}_{i},\mathcal{D%
}_{j}\stackrel{{\scriptstyle i.i.d.}}{{\sim}}p_{\texttt{data}}}{\mathbb{E}}%
\left[e^{-t\|f(\mathcal{D}_{i})-f(\mathcal{D}_{j})\|_{2}^{2}}\right],
p_{\texttt{pos}}
\{(\mathcal{D}_{hr},\mathcal{D}_{t})\}_{i=1}^{N}
p_{\texttt{data}}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\phi(e_{hr},e_{t})=f(x)^{\top}f(y)
\gamma
\begin{split}&\mathcal{L}_{\texttt{exp}}(f;\tau,\mathcal{N})\triangleq%
\underset{\begin{subarray}{c}(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt%
{pos}}\\
{\{\mathcal{D}_{t}{{}_{i}^{\prime}}\}_{i=1}^{\mathcal{N}}}\stackrel{{%
\scriptstyle i.i.d.}}{{\sim}}p_{\texttt{data}}\end{subarray}}{\mathbb{E}}\\
&\left[-\log\frac{e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}}{e^{f(%
\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}+\sum\limits_{i=1}^{\mathcal{N%
}}e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t}{{}_{i}^{\prime}})/\tau}}%
\right],\end{split}
\mathcal{L}_{\texttt{exp}}
\tau>0
\mathcal{N}\rightarrow\infty
\begin{split}&\lim_{\mathcal{N}\rightarrow\infty}\mathcal{L}_{\texttt{exp}}(f;%
\tau,\mathcal{N})-\log\mathcal{N}=\\
&\qquad-\frac{1}{\tau}\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{%
\texttt{pos}}}{\mathbb{E}}\left[f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})%
\right]\\
&\qquad+\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log\underset%
{\mathcal{D}_{i}^{-}\sim p_{\texttt{data}}}{\mathbb{E}}\left[e^{f(\mathcal{D}_%
{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right].\end{split}
E_{LLM}
E_{LLM}
\mathbf{E}
\{\mathcal{D}_{i}\}_{i=1}^{N}
i
\mathbf{E}
e_{i}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\texttt{anisotropy}_{\{\mathcal{D}\}}=\frac{1}{N(N-1)}\sum_{i=1}^{N}\sum_{j=1,%
j\neq i}^{N}e_{i}^{\top}e_{j}.
p_{data}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\begin{split}&\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log%
\underset{\mathcal{D}_{i}^{-}\sim p_{data}}{\mathbb{E}}\left[e^{f(\mathcal{D}_%
{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right]\\
&\quad\geq\frac{N-1}{\tau N}\cdot\texttt{anisotropy}_{\{\mathcal{D}\}}+\frac{1%
}{\tau N}.\end{split}
\{\mathcal{D}_{i}\}_{i=1}^{N}
(t,r^{-1},h)
(h,r,t)
r^{-1}
r
k
k\in\{1,3,10\}
\uparrow
\downarrow
\uparrow
\downarrow
(i,j)
i
j
(i,j)
i
j
\usym{1F5F9}
\usym{1F5F5}
\usym{1F5F9}
\usym{1F5F5}
\begin{split}&\mathcal{L}_{\texttt{exp}}(f;\tau,\mathcal{N})\triangleq%
\underset{\begin{subarray}{c}(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt%
{pos}}\\
{\{\mathcal{D}_{t}{{}_{i}^{\prime}}\}_{i=1}^{\mathcal{N}}}\stackrel{{%
\scriptstyle i.i.d.}}{{\sim}}p_{\texttt{data}}\end{subarray}}{\mathbb{E}}\\
&\left[-\log\frac{e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}}{e^{f(%
\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}+\sum\limits_{i=1}^{\mathcal{N%
}}e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t}{{}_{i}^{\prime}})/\tau}}%
\right].\end{split}
p
\begin{split}&\mathcal{L}_{\texttt{exp}}(f;\tau,\mathcal{N})=\\
&\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{pos}}}{\mathbb{E}%
}\left[-f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau\right]+\underset{%
\begin{subarray}{c}(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{pos}}\\
{\{\mathcal{D}_{t}{{}_{i}^{\prime}}\}_{i=1}^{\mathcal{N}}}\stackrel{{%
\scriptstyle i.i.d.}}{{\sim}}p_{\texttt{data}}\end{subarray}}{\mathbb{E}}\\
&\left[\log\left(e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}+\sum%
\limits_{i=1}^{\mathcal{N}}e^{f(\mathcal{D}_{t}{{}_{i}^{\prime}})^{\top}f(%
\mathcal{D}_{t})/\tau}\right)\right].\end{split}
\begin{split}&\lim_{\mathcal{N}\rightarrow\infty}\log\left(\frac{e^{f(\mathcal%
{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}}{\mathcal{N}}+\frac{\sum\limits_{i=1}%
^{\mathcal{N}}e^{f(\mathcal{D}_{t}{{}_{i}^{\prime}})^{\top}f(\mathcal{D}_{t})/%
\tau}}{\mathcal{N}}\right)\\
&=\log\underset{\mathcal{D}_{i}^{-}\sim p_{\texttt{data}}}{\mathbb{E}}f(%
\mathcal{D}_{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau.\end{split}
\begin{split}&\lim_{\mathcal{N}\rightarrow\infty}\mathcal{L}_{\texttt{exp}}(f;%
\tau,\mathcal{N})-\log\mathcal{N}\\
&=\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{pos}}}{\mathbb{E%
}}\left[-f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau\right]\\
&\quad+\lim_{\mathcal{N}\rightarrow\infty}\underset{\begin{subarray}{c}(%
\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{pos}}\\
{\{\mathcal{D}_{t}{{}_{i}^{\prime}}\}_{i=1}^{\mathcal{N}}}\stackrel{{%
\scriptstyle i.i.d.}}{{\sim}}p_{\texttt{data}}\end{subarray}}{\mathbb{E}}\\
&\quad\left[\log\left(\frac{e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/%
\tau}}{\mathcal{N}}+\frac{\sum\limits_{i=1}^{\mathcal{N}}e^{f(\mathcal{D}_{t}{%
{}_{i}^{\prime}})^{\top}f(\mathcal{D}_{t})/\tau}}{\mathcal{N}}\right)\right]\\
&=\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{pos}}}{\mathbb{E%
}}\left[-f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau\right]\end{split}
\begin{split}&\quad+\mathbb{E}\left[\lim_{\mathcal{N}\rightarrow\infty}\log%
\left(\frac{e^{f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})/\tau}}{\mathcal{N}%
}+\frac{\sum\limits_{i=1}^{\mathcal{N}}e^{f(\mathcal{D}_{t}{{}_{i}^{\prime}})^%
{\top}f(\mathcal{D}_{t})/\tau}}{\mathcal{N}}\right)\right]\\
&=-\frac{1}{\tau}\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{\texttt{%
pos}}}{\mathbb{E}}\left[f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})\right]\\
&\quad+\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log\underset{%
\mathcal{D}_{i}^{-}\sim p_{\texttt{data}}}{\mathbb{E}}\left[e^{f(\mathcal{D}_{%
i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right].\end{split}
\begin{split}&\lim_{\mathcal{N}\rightarrow\infty}\mathcal{L}_{\texttt{exp}}(f;%
\tau,\mathcal{N})-\log\mathcal{N}=\\
&\quad-\frac{1}{\tau}\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{%
\texttt{pos}}}{\mathbb{E}}\left[f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})%
\right]\\
&\quad+\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log\underset{%
\mathcal{D}_{i}^{-}\sim p_{\texttt{data}}}{\mathbb{E}}\left[e^{f(\mathcal{D}_{%
i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right].\end{split}
\begin{split}&\lim_{\mathcal{N}\rightarrow\infty}\mathcal{L}_{\texttt{exp}}(f;%
\tau,\mathcal{N})-\log\mathcal{N}=\\
&\qquad-\frac{1}{\tau}\underset{(\mathcal{D}_{hr},\mathcal{D}_{t})\sim p_{%
\texttt{pos}}}{\mathbb{E}}\left[f(\mathcal{D}_{hr})^{\top}f(\mathcal{D}_{t})%
\right]\\
&\qquad+\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log\underset%
{\mathcal{D}_{i}^{-}\sim p_{\texttt{data}}}{\mathbb{E}}\left[e^{f(\mathcal{D}_%
{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right].\end{split}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\texttt{anisotropy}_{\{\mathcal{D}\}}=\frac{1}{N(N-1)}\sum_{i=1}^{N}\sum_{j=1,%
j\neq i}^{N}e_{i}^{\top}e_{j}.
p_{\texttt{data}}
\{\mathcal{D}_{i}\}_{i=1}^{N}
\begin{split}&\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log%
\underset{\mathcal{D}_{i}^{-}\sim p_{data}}{\mathbb{E}}\left[e^{f(\mathcal{D}_%
{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right]\\
&=\frac{1}{N}\sum_{i=1}^{N}\log\left(\frac{1}{N}\sum_{j=1}^{N}e^{e_{i}^{\top}e%
_{j}/\tau}\right)\\
&\geq\frac{1}{\tau N^{2}}\sum_{i=1}^{N}\sum_{j=1}^{N}e_{i}^{\top}e_{j}\\
&=\frac{1}{\tau N^{2}}\left(\sum_{i=1}^{N}\sum_{j=1,j\neq i}^{N}e_{i}^{\top}e_%
{j}+N\right)\\
&=\frac{N-1}{\tau N}\cdot\frac{1}{N(N-1)}\sum_{i=1}^{N}\sum_{j=1,j\neq i}^{N}e%
_{i}^{\top}e_{j}+\frac{1}{\tau N}\\
&=\frac{N-1}{\tau N}\cdot\texttt{anisotropy}_{\{\mathcal{D}\}}+\frac{1}{\tau N%
}.\end{split}
\begin{split}&\underset{\mathcal{D}_{i}\sim p_{data}}{\mathbb{E}}\left[\log%
\underset{\mathcal{D}_{i}^{-}\sim p_{data}}{\mathbb{E}}\left[e^{f(\mathcal{D}_%
{i}^{-})^{\top}f(\mathcal{D}_{i})/\tau}\right]\right]\\
&\quad\geq\frac{N-1}{\tau N}\cdot\texttt{anisotropy}_{\{\mathcal{D}\}}+\frac{1%
}{\tau N}.\end{split}
40,943
11
86,835
3,034
3,134
14,541
237
272,115
17,535
20,466
gate\_proj
up\_proj
down\_proj
\times
dense\_h\_to\_4h
dense\_4h\_to\_h
fc1
fc2
\displaystyle\ell_{c}=-\log\frac{e^{(\phi(e_{t},e_{hr})-\gamma)/\tau}}{e^{(%
\phi(e_{t},e_{hr})-\gamma)/\tau}+\sum\nolimits_{j=1}^{\mathcal{N}}e^{\phi(e_{t%
},e_{{hr}_{j}^{\prime}})/\tau}}.
\displaystyle\ell_{c}=-\log\frac{e^{(\phi(e_{t},e_{hr})-\gamma)/\tau}}{e^{(%
\phi(e_{t},e_{hr})-\gamma)/\tau}+\sum\nolimits_{j=1}^{\mathcal{N}}e^{\phi(e_{t%
},e_{{hr}_{j}^{\prime}})/\tau}}.
k
k\in\{1,3,10\}
k
k
\uparrow
\downarrow
\uparrow
\downarrow
\{\mathcal{D}_{i}\}_{i=1}^{N}
\times
\lambda
\lambda>0
\lambda=0.1
\lambda=0,0.01,0.1,1.0
\lambda
\lambda
\lambda=0
\lambda=0.01
\lambda=0.1
\lambda=1.0
